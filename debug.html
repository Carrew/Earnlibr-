<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EarnLibr â€” Client Chat</title>
<style>
:root {
  --bg:#0b0d17; --card:#0f1724; --accent1:#4a90e2; --accent2:#a3ff6e; --muted:#cbd5e1; --radius:14px;
}
body {
  margin:0; font-family:Arial,sans-serif; background:var(--bg); color:#fff; min-height:100vh; display:flex; flex-direction:column;
}
header {
  background:var(--card); padding:20px; font-size:20px; font-weight:700; text-align:center; border-bottom:1px solid #1a2235;
}
#messagesContainer {
  flex:1; padding:15px; overflow-y:auto; display:flex; flex-direction:column; gap:10px;
}
.message { max-width:80%; padding:10px 14px; border-radius:var(--radius); line-height:1.4; }
.message.client { align-self:flex-start; background:rgba(74,144,226,0.2); color:var(--accent1);}
.message.provider { align-self:flex-end; background:rgba(163,255,110,0.15); color:var(--accent2);}
.message.system { align-self:center; font-size:12px; color:var(--muted);}
#inputContainer { display:flex; gap:10px; padding:15px; background:var(--card); border-top:1px solid #1a2235; }
#messageInput { flex:1; padding:10px; border-radius:8px; border:1px solid #1a2235; background:#141f33; color:#fff; font-size:14px; }
#sendBtn { padding:10px 20px; border:none; border-radius:8px; background:var(--accent2); color:#041018; font-weight:600; cursor:pointer; }
#sendBtn:hover { transform:scale(1.05); }
#loading { padding:20px; text-align:center; color:var(--muted); }
#debug { padding:10px; font-size:12px; background:#222; color:#f66; margin:0; overflow-x:auto; white-space:pre-wrap;}
</style>
</head>
<body>
<header>Chat with Provider</header>
<div id="messagesContainer">
  <div id="loading">Loading messages...</div>
</div>
<div id="inputContainer">
  <input type="text" id="messageInput" placeholder="Type your message..." />
  <button id="sendBtn">Send</button>
</div>
<pre id="debug"></pre>

<script type="module">
import { db } from "./firebase.js";
import {
  collection, doc, getDoc, addDoc, onSnapshot, query, orderBy, serverTimestamp, updateDoc
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

// --- Debug helper ---
const debugEl = document.getElementById("debug");
function debugLog(msg, data=null){
  console.log(msg, data || "");
  debugEl.textContent += `[DEBUG] ${msg} ${data ? JSON.stringify(data) : ""}\n`;
}

// --- Robust URL param parsing ---
const url = window.location.href;
let params = new URLSearchParams(window.location.search);
if(!params.has("deal") || !params.has("client")) {
  debugLog("Search params missing, checking URL hash fallback");
  const hashIndex = url.indexOf("#");
  if(hashIndex !== -1){
    params = new URLSearchParams(url.slice(hashIndex+1));
  }
}

let chatId = params.get("deal");
let clientId = params.get("client");

// --- fallback for clientId ---
if(!clientId){
  clientId = localStorage.getItem("clientId");
  if(!clientId){
    clientId = 'client_' + Math.random().toString(36).substr(2,9);
    localStorage.setItem("clientId", clientId);
    debugLog("Generated new clientId in localStorage", clientId);
  } else {
    debugLog("Using clientId from localStorage", clientId);
  }
}

if(!chatId){
  const errMsg = "Missing deal ID. Cannot load chat.";
  debugLog(errMsg);
  document.body.innerHTML = `<p style='color:red; padding:20px;'>${errMsg}</p>`;
  throw new Error(errMsg);
}

debugLog("Chat page initialized", {chatId, clientId});

// --- Elements ---
const messagesContainer = document.getElementById("messagesContainer");
const messageInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");

const chatDocRef = doc(db, "chats", chatId);
const messagesRef = collection(chatDocRef, "messages");
let chatData = null;

// --- Initialize chat ---
async function initChat() {
  try {
    debugLog("Fetching chat document", {chatId});
    const chatSnap = await getDoc(chatDocRef);
    if (!chatSnap.exists()) {
      const errMsg = "Chat not found in Firestore.";
      debugLog(errMsg);
      document.body.innerHTML = `<p style='color:red; padding:20px;'>${errMsg}</p>`;
      throw new Error(errMsg);
    }
    chatData = chatSnap.data();
    debugLog("Chat document loaded", chatData);
  } catch (err) {
    debugLog("Error fetching chat doc", err.message || err);
    document.body.innerHTML = `<p style='color:red; padding:20px;'>Error loading chat. Check debug below.</p>`;
  }
}

// --- Listen for messages ---
function listenMessages() {
  try {
    const q = query(messagesRef, orderBy("timestamp", "asc"));
    onSnapshot(q, snapshot => {
      messagesContainer.innerHTML = "";
      if(snapshot.empty) {
        messagesContainer.innerHTML = "<div class='message system'>No messages yet.</div>";
      }
      snapshot.forEach(docSnap => {
        const msg = docSnap.data();
        const div = document.createElement("div");
        div.classList.add("message");
        div.classList.add(msg.sender === "client" ? "client" :
                         msg.sender === "provider" ? "provider" : "system");
        div.textContent = msg.text;
        messagesContainer.appendChild(div);
      });
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }, err => {
      debugLog("Error listening to messages", err);
    });
  } catch(err) {
    debugLog("Error setting up message listener", err);
  }
}

// --- Send a message ---
async function sendMessage() {
  const text = messageInput.value.trim();
  if (!text) return;
  messageInput.value = "";
  const msgData = { text, sender: "client", timestamp: serverTimestamp() };
  try {
    debugLog("Sending message", msgData);
    await addDoc(messagesRef, msgData);
    await updateDoc(chatDocRef, { lastMessage: msgData });
  } catch (err) {
    debugLog("Error sending message", err);
  }
}

sendBtn.addEventListener("click", sendMessage);
messageInput.addEventListener("keypress", e => { if (e.key === "Enter") sendMessage(); });

await initChat();
if(chatData) listenMessages();
</script>
</body>
</html>
