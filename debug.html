<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EarnLibr â€” Client Chat Debug</title>
<style>
:root {
  --bg:#0b0d17; --card:#0f1724; --accent1:#4a90e2; --accent2:#a3ff6e; --muted:#cbd5e1; --radius:14px;
}
body {
  margin:0; font-family:Arial,sans-serif; background:var(--bg); color:#fff; min-height:100vh; display:flex; flex-direction:column;
}
header {
  background:var(--card); padding:20px; font-size:20px; font-weight:700; text-align:center; border-bottom:1px solid #1a2235;
}
#messagesContainer {
  flex:1; padding:15px; overflow-y:auto; display:flex; flex-direction:column; gap:10px;
}
.message { max-width:80%; padding:10px 14px; border-radius:var(--radius); line-height:1.4; }
.message.client { align-self:flex-start; background:rgba(74,144,226,0.2); color:var(--accent1);}
.message.provider { align-self:flex-end; background:rgba(163,255,110,0.15); color:var(--accent2);}
.message.system { align-self:center; font-size:12px; color:var(--muted);}
#inputContainer { display:flex; gap:10px; padding:15px; background:var(--card); border-top:1px solid #1a2235; }
#messageInput { flex:1; padding:10px; border-radius:8px; border:1px solid #1a2235; background:#141f33; color:#fff; font-size:14px; }
#sendBtn { padding:10px 20px; border:none; border-radius:8px; background:var(--accent2); color:#041018; font-weight:600; cursor:pointer; }
#sendBtn:hover { transform:scale(1.05); }

/* Debug Panel */
#debugPanel {
  position:fixed; bottom:0; right:0; width:400px; max-height:300px; overflow-y:auto;
  background:rgba(0,0,0,0.85); border-top-left-radius:12px; padding:10px; font-size:12px; z-index:9999;
  color:#fff; font-family:monospace;
}
.debugMsg { margin-bottom:5px; border-bottom:1px solid #1a2235; padding-bottom:2px; }
</style>
</head>
<body>
<header>Chat with Provider (Debug Mode)</header>
<div id="messagesContainer">
  <div id="loading">Loading messages...</div>
</div>
<div id="inputContainer">
  <input type="text" id="messageInput" placeholder="Type your message..." />
  <button id="sendBtn">Send</button>
</div>

<!-- Live Debug Panel -->
<div id="debugPanel">
  <div style="font-weight:bold; margin-bottom:5px;">Live Debug Panel</div>
</div>

<script type="module">
import { db } from "./firebase.js";
import {
  collection, doc, getDoc, addDoc, onSnapshot, query, orderBy, serverTimestamp, updateDoc
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

// --- Debugging utility ---
const debugPanel = document.getElementById("debugPanel");
function debugLog(...args) {
  console.log(...args); // also log to console
  const div = document.createElement("div");
  div.className = "debugMsg";
  div.textContent = args.map(a => typeof a==="object"?JSON.stringify(a):a).join(" ");
  debugPanel.appendChild(div);
  debugPanel.scrollTop = debugPanel.scrollHeight;
}

// --- Capture mouse events ---
document.addEventListener("mousemove", e => {
  debugLog(`Mouse Move: x=${e.clientX}, y=${e.clientY}`);
});
document.addEventListener("click", e => {
  debugLog(`Mouse Click: x=${e.clientX}, y=${e.clientY}, target=${e.target.tagName}`);
});

// --- URL params ---
const params = new URLSearchParams(window.location.search);
const chatId = params.get("deal");
const clientId = params.get("client");
debugLog("URL Params:", { chatId, clientId });

if (!chatId || !clientId) {
  document.body.innerHTML = "<p style='color:red; padding:20px;'>Invalid chat link. Missing chatId or clientId.</p>";
  debugLog("Missing chatId or clientId in URL.");
  throw new Error("Missing chatId or clientId in URL");
}

const messagesContainer = document.getElementById("messagesContainer");
const messageInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");

const chatDocRef = doc(db, "chats", chatId);
const messagesRef = collection(chatDocRef, "messages");

// --- Initialize chat ---
async function initChat() {
  try {
    debugLog("Fetching chat doc:", chatDocRef.path);
    const chatSnap = await getDoc(chatDocRef);
    debugLog("chatSnap.exists():", chatSnap.exists());
    if (!chatSnap.exists()) {
      messagesContainer.innerHTML = "<p style='color:red; padding:20px;'>Chat not found in database.</p>";
      debugLog("Chat document does not exist!");
      return false;
    }
    const chatData = chatSnap.data();
    debugLog("Chat data loaded:", chatData);
    return true;
  } catch (err) {
    messagesContainer.innerHTML = "<p style='color:red; padding:20px;'>Error loading chat.</p>";
    debugLog("Error fetching chat doc:", err);
    return false;
  }
}

// --- Listen messages ---
function listenMessages() {
  const q = query(messagesRef, orderBy("timestamp", "asc"));
  debugLog("Listening for messages in:", messagesRef.path);

  onSnapshot(q, snapshot => {
    messagesContainer.innerHTML = "";
    if (snapshot.empty) {
      messagesContainer.innerHTML = "<p class='message system'>No messages yet.</p>";
      debugLog("No messages yet.");
      return;
    }

    snapshot.forEach(docSnap => {
      const msg = docSnap.data();
      const div = document.createElement("div");
      div.classList.add("message");
      div.classList.add(msg.sender==="client"?"client":msg.sender==="provider"?"provider":"system");
      div.textContent = msg.text;
      messagesContainer.appendChild(div);
    });
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    debugLog("Messages updated, count:", snapshot.size);
  });
}

// --- Send message ---
async function sendMessage() {
  const text = messageInput.value.trim();
  if (!text) return;
  messageInput.value = "";
  const msgData = { text, sender:"client", timestamp:serverTimestamp() };
  try {
    await addDoc(messagesRef, msgData);
    await updateDoc(chatDocRef, { lastMessage: msgData });
    debugLog("Message sent:", msgData);
  } catch(err) {
    debugLog("Error sending message:", err);
  }
}

sendBtn.addEventListener("click", sendMessage);
messageInput.addEventListener("keypress", e=>{ if(e.key==="Enter") sendMessage(); });

// --- Run ---
(async () => {
  const chatExists = await initChat();
  if (chatExists) listenMessages();
})();
</script>
</body>
</html>
