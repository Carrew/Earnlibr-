<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EarnLibr ‚Äî Promoter Wallet</title>
<style>
  /* Keep all your current styles */
</style>
</head>
<body>
<header>
  <h1>üí∞ Promoter Wallet</h1>
  <button class="dashboard-btn" onclick="window.location.href='promoter-dashboard.html'">‚Üê Dashboard</button>
</header>

<div id="notif" class="notif"></div>
<div id="walletContainer" class="wallet-container"></div>

<!-- Withdrawal Confirmation Modal -->
<div id="withdrawModal" class="modal">
  <div class="modal-content">
    <h3 id="modalText">Confirm withdrawal?</h3>
    <div class="modal-actions">
      <button id="confirmWithdraw" class="confirm-btn">Yes, Withdraw</button>
      <button id="cancelWithdraw" class="cancel-btn">Cancel</button>
    </div>
  </div>
</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { doc, onSnapshot, collection, query, orderBy, getDoc, setDoc, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const walletContainer = document.getElementById('walletContainer');
const notif = document.getElementById('notif');
const modal = document.getElementById('withdrawModal');
const modalText = document.getElementById('modalText');
const confirmBtn = document.getElementById('confirmWithdraw');
const cancelBtn = document.getElementById('cancelWithdraw');

let selectedCurrency = null;
let selectedAmount = 0;
let selectedDeals = [];
let promoterId = null;

function showNotif(msg, type = "success") {
  notif.textContent = msg;
  notif.className = `notif ${type}`;
  notif.style.display = "block";
  setTimeout(() => (notif.style.display = "none"), 4000);
}

function openModal(currency, amount, deals) {
  selectedCurrency = currency;
  selectedAmount = amount;
  selectedDeals = deals;
  modalText.textContent = `Confirm withdrawal of ${amount.toFixed(2)} ${currency}?`;
  modal.classList.add('show');
}

function closeModal() {
  modal.classList.remove('show');
}
cancelBtn.onclick = closeModal;

confirmBtn.onclick = async () => {
  closeModal();
  try {
    const timestamp = new Date().toISOString();
    const withdrawalId = `wr-${selectedCurrency}-${Date.now()}`;
    
    // Add withdrawal request to Firestore
    await addDoc(collection(db, 'withdrawal-requests'), {
      withdrawalId,
      promoterId,
      currency: selectedCurrency,
      dealIds: selectedDeals,
      amount: selectedAmount,
      status: "pending",
      requestedAt: timestamp,
    });

    // Update deals to mark withdrawn & reset currentBalance
    const batchUpdates = [];
    for (const dealId of selectedDeals) {
      const dealRef = doc(db, 'promoter-earnings', promoterId, 'deals', dealId);
      batchUpdates.push(updateDoc(dealRef, { withdrawn: true }));
    }

    const metaRef = doc(db, 'promoter-earnings', promoterId, 'metadata', 'meta');
    const metaSnap = await getDoc(metaRef);
    if (metaSnap.exists()) {
      const metaData = metaSnap.data();
      const newBalances = { ...(metaData.currentBalance || {}) };
      newBalances[selectedCurrency] = 0;
      batchUpdates.push(updateDoc(metaRef, { currentBalance: newBalances, lastUpdated: timestamp }));
    }

    await Promise.all(batchUpdates);
    showNotif(`‚úÖ ${selectedCurrency} withdrawal requested!`);
  } catch (err) {
    console.error(err);
    showNotif("Error submitting withdrawal: " + err.message, "error");
  }
};

// ------------------- Auth -------------------
onAuthStateChanged(auth, async (user) => {
  if (!user) return (window.location.href = "login.html");
  const userRef = doc(db, 'users', user.uid);
  const snap = await getDoc(userRef);
  const userData = snap.exists() ? snap.data() : null;
  if (!userData || userData.role !== "freelancer") return (window.location.href = "login.html");

  promoterId = user.uid;
  loadWallet(promoterId);
});

// ------------------- Load Wallet -------------------
function loadWallet(uid) {
  const metaRef = doc(db, 'promoter-earnings', uid, 'metadata', 'meta');
  onSnapshot(metaRef, (snap) => {
    walletContainer.innerHTML = '';
    if (!snap.exists()) {
      walletContainer.innerHTML = "<p>No wallet data available yet.</p>";
      return;
    }
    const meta = snap.data();
    const balances = meta.currentBalance || {};
    const totalEarned = meta.totalLifetimeEarnings || {};
    const withdrawn = meta.totalWithdrawn || {};

    Object.keys(balances).forEach(async (currency) => {
      const curBalance = balances[currency] || 0;
      const curLifetime = totalEarned[currency] || 0;
      const curWithdrawn = withdrawn[currency] || 0;

      const card = document.createElement("div");
      card.className = "wallet-card";
      card.innerHTML = `
        <div class="currency-title">${currency}</div>
        <div class="wallet-stat">üí∞ Current Balance: <span class="amount">${curBalance.toFixed(2)}</span></div>
        <div class="wallet-stat">üìà Total Earned: ${curLifetime.toFixed(2)}</div>
        <div class="wallet-stat">üè¶ Withdrawn: ${curWithdrawn.toFixed(2)}</div>
      `;

      if (curBalance > 0) {
        const withdrawBtn = document.createElement("button");
        withdrawBtn.className = "btn";
        withdrawBtn.textContent = `Request ${currency} Withdrawal`;

        // Get eligible deals
        const dealsCol = collection(db, 'promoter-earnings', uid, 'deals');
        const dealsQuery = query(dealsCol);
        const dealsSnap = await getDoc(metaRef); // get metadata
        withdrawBtn.onclick = async () => {
          const dealsRef = collection(db, 'promoter-earnings', uid, 'deals');
          const dealsSnap = await getDocs(dealsRef);
          const pendingDeals = dealsSnap.docs
            .filter(d => !d.data().withdrawn && (d.data().currency || 'USD') === currency)
            .map(d => d.id);
          if (pendingDeals.length === 0) return showNotif(`No ${currency} earnings to withdraw.`, 'error');
          openModal(currency, curBalance, pendingDeals);
        };

        card.appendChild(withdrawBtn);
      }

      walletContainer.appendChild(card);
    });
  });
}
</script>
</body>
</html>
