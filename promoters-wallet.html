<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Promoter Wallet</title>
<style>
body { font-family: Arial, sans-serif; background: #0b0d17; color: #eef2f7; margin: 0; padding: 20px; }
h1 { background: linear-gradient(90deg, #4a90e2, #a3ff6e); -webkit-background-clip: text; color: transparent; margin-bottom: 20px; }
.wallet-box { background: #0f1724; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
.wallet-box h3 { margin-top: 0; }
.wallet-box p { margin: 4px 0; font-size: 14px; }
.wallet-box button { margin-top: 10px; padding: 6px 12px; border: none; border-radius: 8px; cursor: pointer; background: #4ade80; color: #041018; font-weight: 700; }
.notif { background: #1a2235; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; display: none; }
.notif.success { border-left: 4px solid #4ade80; color: #a3ff6e; }
.notif.error { border-left: 4px solid #ef4444; color: #ff8c8c; }
</style>
</head>
<body>

<h1>Promoter Wallet</h1>
<div id="notif" class="notif"></div>
<div id="walletContainer">Loading wallet...</div>

<script type="module">
import { auth, db } from './firebase.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { 
  doc, getDoc, collection, query, where, getDocs, addDoc, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const walletContainer = document.getElementById("walletContainer");
const notif = document.getElementById("notif");

const showNotif = (msg, type="success") => {
  notif.textContent = msg;
  notif.className = `notif ${type}`;
  notif.style.display = "block";
  setTimeout(() => { notif.style.display = "none"; }, 3000);
};

/* --- Session & Auth Check --- */
let userSession = localStorage.getItem("userSession");
if(!userSession){ window.location.href = "login.html"; throw new Error("No session"); }
userSession = JSON.parse(userSession);

onAuthStateChanged(auth, async (user) => {
  if(!user || user.uid !== userSession.uid){
    localStorage.removeItem("userSession");
    window.location.href = "login.html";
    return;
  }
  if(!user.emailVerified){
    localStorage.removeItem("userSession");
    window.location.href = "login.html";
    return;
  }

  // Firestore check
  const userDoc = await getDoc(doc(db, 'users', user.uid));
  if(!userDoc.exists() || userDoc.data().role !== 'promoter'){
    localStorage.removeItem("userSession");
    window.location.href = "login.html";
    return;
  }

  userSession = { uid: user.uid, name: userDoc.data().name, email: userDoc.data().email, role: userDoc.data().role };
  localStorage.setItem('userSession', JSON.stringify(userSession));

  loadWallet(user.uid);
});

/* --- Load Wallet --- */
async function loadWallet(promoterId){
  const metaRef = doc(db, "promoter-earnings", promoterId, "metadata", "summary");
  const metaSnap = await getDoc(metaRef);
  if(!metaSnap.exists()){
    walletContainer.innerHTML = "<p>No earnings yet.</p>";
    return;
  }

  const meta = metaSnap.data();
  walletContainer.innerHTML = "";

  for(const currency in meta.currentBalance){
    const withdrawable = meta.currentBalance[currency];
    const totalWithdrawn = meta.totalWithdrawn[currency] || 0;
    const totalLifetime = meta.totalLifetimeEarnings[currency] || 0;

    const box = document.createElement("div");
    box.className = "wallet-box";
    box.innerHTML = `
      <h3>${currency} Wallet</h3>
      <p>Total Lifetime Earnings: ${totalLifetime}</p>
      <p>Total Withdrawn: ${totalWithdrawn}</p>
      <p>Available to Withdraw: ${withdrawable}</p>
      <button id="withdraw-${currency}">Request Withdrawal</button>
    `;
    walletContainer.appendChild(box);

    box.querySelector(`#withdraw-${currency}`).onclick = async () => {
      await requestWithdrawal(promoterId, currency, withdrawable);
    }
  }
}

/* --- Request Withdrawal --- */
async function requestWithdrawal(promoterId, currency, withdrawableAmount){
  if(withdrawableAmount <= 0) return showNotif("No withdrawable balance","error");

  // Get eligible deals
  const dealsQuery = query(
    collection(db, "promoter-earnings", promoterId, "deals"),
    where("withdrawn", "==", false),
    where("offerCurrency", "==", currency)
  );

  const dealSnap = await getDocs(dealsQuery);
  if(dealSnap.empty) return showNotif("No deals available for withdrawal","error");

  const dealIds = dealSnap.docs.map(d=>d.id);

  // Create withdrawal request
  await addDoc(collection(db, "withdrawal-requests"), {
    promoterId,
    currency,
    amount: withdrawableAmount,
    dealIds,
    requestedAt: serverTimestamp(),
    status: "pending"
  });

  showNotif(`Withdrawal request for ${withdrawableAmount} ${currency} submitted`);
}
</script>
</body>
</html>
