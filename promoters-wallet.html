<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Promoter Wallet</title>

<style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: #0b0d17;
  color: #eef2f7;
  margin: 0;
  padding: 20px;
}

h1 {
  font-size: 2rem;
  background: linear-gradient(90deg, #4a90e2, #a3ff6e);
  -webkit-background-clip: text;
  color: transparent;
  margin-bottom: 25px;
}

.notif {
  background: #1a2235;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 15px;
  font-size: 14px;
  display: none;
}
.notif.success { border-left: 4px solid #4ade80; color: #a3ff6e; }
.notif.error { border-left: 4px solid #ef4444; color: #ff8c8c; }

.wallet-panel {
  background: rgba(15, 23, 36, 0.9);
  backdrop-filter: blur(10px);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.7);
  display: flex;
  flex-direction: column;
  gap: 15px;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.wallet-panel:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 28px rgba(0,0,0,0.8);
}

.wallet-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.wallet-header h3 {
  margin: 0;
  font-size: 1.25rem;
}
.wallet-header span {
  font-size: 1.5rem;
  font-weight: 700;
  color: #4ade80;
}

.wallet-progress {
  background: #1a2235;
  border-radius: 8px;
  height: 10px;
  overflow: hidden;
}
.wallet-progress div {
  height: 100%;
  background: linear-gradient(90deg, #4a90e2, #a3ff6e);
  width: 0%;
  transition: width 0.5s ease;
}

.wallet-panel button {
  padding: 10px 16px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  background: #4ade80;
  color: #041018;
  font-weight: 700;
  transition: background 0.2s ease;
}
.wallet-panel button:hover {
  background: #32cd70;
}

@media(max-width:600px){
  body{padding:10px;}
  h1{font-size:1.5rem;}
}
</style>
</head>
<body>

<h1>Promoter Wallet</h1>
<div id="notif" class="notif"></div>
<div id="walletContainer">Loading wallet...</div>

<script type="module">
import { auth, db } from './firebase.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { 
  doc, getDoc, collection, query, where, getDocs, serverTimestamp, runTransaction 
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const walletContainer = document.getElementById("walletContainer");
const notif = document.getElementById("notif");

/* --- Notification --- */
const showNotif = (msg, type="success") => {
  notif.textContent = msg;
  notif.className = `notif ${type}`;
  notif.style.display = "block";
  setTimeout(() => (notif.style.display = "none"), 5000);
};

/* --- Load Session & Auth --- */
let userSession = localStorage.getItem("userSession");
if (!userSession) {
  window.location.href = "login.html";
  throw new Error("No session found");
}
userSession = JSON.parse(userSession);

onAuthStateChanged(auth, async (user) => {
  if (!user || user.uid !== userSession.uid || !user.emailVerified) {
    localStorage.removeItem("userSession");
    window.location.href = "login.html";
    return;
  }

  const userDocRef = doc(db, "users", user.uid);
  const userDoc = await getDoc(userDocRef);

  if (!userDoc.exists() || userDoc.data().role !== "freelancer") {
    localStorage.removeItem("userSession");
    window.location.href = "login.html";
    return;
  }

  const data = userDoc.data();
  userSession = {
    uid: user.uid,
    name: data.name,
    email: data.email,
    role: data.role,
    referralCode: data.referralCode || "",
    phone: data.phone || "",
    country: data.country || "",
    createdAt: data.createdAt || ""
  };
  localStorage.setItem("userSession", JSON.stringify(userSession));

  loadWallet(user.uid);
});

/* --- Load Wallet --- */
async function loadWallet(promoterId) {
  const metaRef = doc(db, "promoter-earnings", promoterId, "metadata", "summary");
  const metaSnap = await getDoc(metaRef);

  if (!metaSnap.exists()) {
    walletContainer.innerHTML = "<p>No earnings yet.</p>";
    return;
  }

  const meta = metaSnap.data();
  walletContainer.innerHTML = "";

  for (const currency in meta.currentBalance) {
    const withdrawable = meta.currentBalance[currency] || 0;
    const totalWithdrawn = meta.totalWithdrawn?.[currency] || 0;
    const totalLifetime = meta.totalLifetimeEarnings?.[currency] || 0;

    const box = document.createElement("div");
    box.className = "wallet-panel";
    box.innerHTML = `
      <div class="wallet-header">
        <h3>${currency} Wallet</h3>
        <span>${withdrawable.toFixed(2)}</span>
      </div>
      <div class="wallet-progress"><div></div></div>
      <p>Total Lifetime: ${totalLifetime.toFixed(2)} | Withdrawn: ${totalWithdrawn.toFixed(2)}</p>
      <button>Request Withdrawal</button>
    `;
    walletContainer.appendChild(box);

    // Animate progress
    const progress = box.querySelector(".wallet-progress div");
    progress.style.width = totalLifetime > 0 ? `${(withdrawable / totalLifetime) * 100}%` : "0%";

    const withdrawBtn = box.querySelector("button");
    if (withdrawable <= 0) {
      withdrawBtn.disabled = true;
      withdrawBtn.textContent = "No Balance to Withdraw";
    }

    withdrawBtn.onclick = async () => {
      withdrawBtn.disabled = true;
      await requestWithdrawal(promoterId, currency, withdrawable, withdrawBtn);
    };
  }
}

/* --- Request Withdrawal --- */
async function requestWithdrawal(promoterId, currency, withdrawableAmount, btn) {
  if (withdrawableAmount <= 0) {
    btn.disabled = true;
    return showNotif("No withdrawable balance", "error");
  }

  const originalText = btn.textContent;
  btn.textContent = "Processing...";
  console.log(`Starting withdrawal: ${currency} - Amount: ${withdrawableAmount}`);

  try {
    // 1. Fetch eligible deals outside the transaction
    const dealsCollectionRef = collection(db, "promoter-earnings", promoterId, "deals");
    const dealsQuery = query(
      dealsCollectionRef,
      where("withdrawalRequestId", "==", null),
      where("offerCurrency", "==", currency)
    );
    const dealSnap = await getDocs(dealsQuery);
    if (dealSnap.empty) throw new Error("No eligible deals to withdraw.");

    const dealRefs = dealSnap.docs.map(d => doc(db, "promoter-earnings", promoterId, "deals", d.id));

    // 2. Run transaction
    await runTransaction(db, async (t) => {
      const metaRef = doc(db, "promoter-earnings", promoterId, "metadata", "summary");
      const metaSnap = await t.get(metaRef);
      if (!metaSnap.exists()) throw new Error("Wallet metadata not found.");

      const currentBalance = metaSnap.data().currentBalance?.[currency] || 0;
      if (currentBalance < withdrawableAmount || Math.abs(currentBalance - withdrawableAmount) > 0.01) {
        throw new Error("Balance mismatch. Please refresh and try again.");
      }

      const withdrawalRequestRef = doc(collection(db, "withdrawal-requests"));
      const withdrawalRequestId = withdrawalRequestRef.id;

      // Create withdrawal request
      t.set(withdrawalRequestRef, {
        withdrawalRequestId,
        promoterId,
        currency,
        amount: withdrawableAmount,
        dealIds: dealRefs.map(d => d.id),
        requestedAt: serverTimestamp(),
        status: "pending"
      });

      // Update deals
      for (const dealRef of dealRefs) {
        const dealDocSnap = await t.get(dealRef);
        if (!dealDocSnap.exists()) throw new Error("Deal document missing during transaction.");
        t.update(dealRef, {
          withdrawalRequestId,
          withdrawalRequestedAt: serverTimestamp()
        });
      }

      // Update wallet balance
      t.update(metaRef, {
        [`currentBalance.${currency}`]: Math.max(0, currentBalance - withdrawableAmount)
      });
    });

    showNotif(`Withdrawal request for ${withdrawableAmount.toFixed(2)} ${currency} submitted successfully!`);
    loadWallet(promoterId);

  } catch(err) {
    console.error("Withdrawal failed:", JSON.stringify(err, Object.getOwnPropertyNames(err)));
    let message = err.message || "Unknown error occurred during withdrawal.";
    if (err.code) message += ` (Code: ${err.code})`;
    showNotif(`Withdrawal failed: ${message}`, "error");
    btn.textContent = originalText;
    btn.disabled = false;
  }
}
</script>
</body>
</html>
