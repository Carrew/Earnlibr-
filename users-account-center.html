<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EarnLibr — Account Center</title>

  <style>
    :root {
      --bg:#0b0d17; --card:#0f1724; --accent1:#4a90e2;
      --accent2:#a3ff6e; --muted:#bfc7d6; --danger:#e74c3c;
    }
    body{
      margin:0; font-family:Inter,system-ui,Arial;
      background:linear-gradient(180deg,#071028 0%, #0b0d17 100%);
      color:#eef2f7; min-height:100vh; display:flex;
      align-items:center; justify-content:center; padding:20px;
    }
    .card{
      width:100%; max-width:520px;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.015));
      border-radius:14px; padding:22px; box-shadow:0 8px 30px rgba(2,6,23,0.6);
      border:1px solid rgba(255,255,255,0.03); overflow:hidden;
    }
    h1{
      font-size:22px; margin:0 0 6px;
      background:linear-gradient(90deg,var(--accent1),var(--accent2));
      -webkit-background-clip:text; color:transparent;
    }
    p.lead{ color:var(--muted); margin:0 0 14px; font-size:13px; }
    label{ display:block; font-size:13px; color:var(--muted); margin-top:12px; margin-bottom:6px; }
    input, select{
      width:100%; padding:10px 12px; border-radius:8px;
      border:1px solid rgba(255,255,255,0.04);
      background:#071427; color:#fff; font-size:14px;
    }
    .row{ display:flex; gap:10px; }
    .row > div{ flex:1; }
    .btn{
      margin-top:18px; width:100%; padding:12px; border-radius:10px;
      border:0; cursor:pointer;
      background:linear-gradient(90deg,var(--accent1),var(--accent2));
      color:#041018; font-weight:700; transition:opacity 0.2s;
    }
    .btn:hover{ opacity:0.9; }
    .btn-ghost{
      margin-top:10px; width:100%; padding:10px; border-radius:10px;
      border:1px solid rgba(148,163,184,0.35);
      background:transparent; color:var(--muted); cursor:pointer;
    }
    .small{ font-size:13px; color:var(--muted); margin-top:10px; text-align:center; }
    .error{ color:var(--danger); font-weight:600; margin-top:10px; font-size:13px; display:none; }
    .ok{ color:var(--accent2); font-weight:600; margin-top:10px; font-size:13px; display:none; }
    .readonly{ opacity:0.85; }
  </style>
</head>

<body>
  <div class="card">
    <h1>Account Center</h1>
    <p class="lead">View and update your account information.</p>

    <div id="ok" class="ok"></div>
    <div id="error" class="error"></div>

    <label>Full name</label>
    <input id="name" type="text" placeholder="Your name" />

    <label>Email (read-only)</label>
    <input id="email" type="email" class="readonly" disabled />

    <div class="row">
      <div>
        <label>Country</label>
        <select id="country"></select>
      </div>
      <div>
        <label>Phone</label>
        <input id="phone" type="text" placeholder="e.g. +231555..." />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Role (read-only)</label>
        <input id="role" class="readonly" disabled />
      </div>
      <div>
        <label>Referral code (read-only)</label>
        <input id="referralCode" class="readonly" disabled />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Created at</label>
        <input id="createdAt" class="readonly" disabled />
      </div>
      <div>
        <label>Last login</label>
        <input id="lastLoginAt" class="readonly" disabled />
      </div>
    </div>

    <button id="saveBtn" class="btn">Save changes</button>
    <button id="refreshBtn" class="btn-ghost" type="button">Refresh</button>

    <p class="small">
      Tip: For password changes, use <a href="users-password-reset.html" style="color:var(--accent2);text-decoration:none;font-weight:600">Reset password</a>.
    </p>
  </div>

  <script type="module">
    import { auth, db } from "./firebase.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      doc,
      getDoc,
      getDocFromServer,
      updateDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const $ = (id) => document.getElementById(id);
    const ok = $("ok");
    const error = $("error");
    const saveBtn = $("saveBtn");
    const refreshBtn = $("refreshBtn");

    const showOk = (t) => { ok.style.display="block"; ok.textContent=t; error.style.display="none"; error.textContent=""; };
    const showErr = (t) => { error.style.display="block"; error.textContent=t; ok.style.display="none"; ok.textContent=""; };

    let currentUserUid = null;
    let targetRef = null; // users/{uid} or admins/{uid}
    let roleCache = "";

    async function loadCountries(selectedCountry){
      const countrySelect = $("country");
      countrySelect.innerHTML = "";
      const res = await fetch("countries.json");
      const data = await res.json();

      data.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.name;
        opt.textContent = c.name;
        if (selectedCountry && c.name === selectedCountry) opt.selected = true;
        countrySelect.appendChild(opt);
      });
    }

    function formatIso(iso){
      if(!iso) return "";
      try {
        // You can change to local formatting if you prefer
        return new Date(iso).toLocaleString();
      } catch { return iso; }
    }

    function toIsoFromFirestoreTimestamp(ts){
      return ts ? ts.toDate().toISOString() : "";
    }

    async function fetchProfile(){
      if(!currentUserUid) throw new Error("Not signed in.");

      const userRef = doc(db, "users", currentUserUid);
      const adminRef = doc(db, "admins", currentUserUid);

      // Try users first, then admins (matches your login logic)
      const userSnap = await getDocFromServer(userRef);
      if (userSnap.exists()){
        targetRef = userRef;
        return { collection: "users", data: userSnap.data() };
      }

      const adminSnap = await getDocFromServer(adminRef);
      if (adminSnap.exists()){
        targetRef = adminRef;
        return { collection: "admins", data: adminSnap.data() };
      }

      throw new Error("User record not found.");
    }

    function fillForm(data){
      $("name").value = data?.name || "";
      $("email").value = data?.email || "";
      roleCache = data?.role || "";
      $("role").value = roleCache || "";
      $("referralCode").value = data?.referralCode || "";
      $("phone").value = data?.phone || "";

      const createdIso = toIsoFromFirestoreTimestamp(data?.createdAt);
      const lastLoginIso = toIsoFromFirestoreTimestamp(data?.lastLoginAt);

      $("createdAt").value = formatIso(createdIso);
      $("lastLoginAt").value = formatIso(lastLoginIso);

      // Countries list + select
      loadCountries(data?.country || "");
    }

    function updateLocalStorage(uid, data){
      const createdAtIso = toIsoFromFirestoreTimestamp(data?.createdAt);
      const lastLoginAtIso = toIsoFromFirestoreTimestamp(data?.lastLoginAt);

      const session = {
        uid,
        name: data?.name || "",
        email: data?.email || "",
        role: data?.role || roleCache || "",
        referralCode: data?.referralCode || "",
        phone: data?.phone || "",
        country: data?.country || "",
        createdAt: createdAtIso,
        lastLoginAt: lastLoginAtIso
      };

      localStorage.setItem("userSession", JSON.stringify(session));
    }

    async function refresh(){
      try {
        ok.style.display="none"; error.style.display="none";
        const result = await fetchProfile();
        fillForm(result.data);
        updateLocalStorage(currentUserUid, result.data);
      } catch(e){
        console.error(e);
        showErr(e.message || "Failed to load profile.");
      }
    }

    saveBtn.addEventListener("click", async () => {
      try {
        if(!targetRef) return showErr("Profile not loaded yet.");

        const name = $("name").value.trim();
        const phone = $("phone").value.trim();
        const country = $("country").value;

        if(!name || !phone || !country){
          return showErr("Please fill name, phone, and country.");
        }

        saveBtn.disabled = true;
        saveBtn.textContent = "Saving...";

        // You can also normalize phone here if you want:
        // const normalizedPhone = phone.replace(/\s+/g,"");

        await updateDoc(targetRef, {
          name,
          phone,
          country,
          updatedAt: serverTimestamp()
        });

        // Re-fetch to get serverTimestamp resolved, then update UI + localStorage
        const freshSnap = await getDocFromServer(targetRef);
        const freshData = freshSnap.data();

        fillForm(freshData);
        updateLocalStorage(currentUserUid, freshData);

        showOk("✅ Saved successfully.");
      } catch(e){
        console.error(e);
        showErr(e.message || "Failed to save changes.");
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = "Save changes";
      }
    });

    refreshBtn.addEventListener("click", refresh);

    // Auth gate
    onAuthStateChanged(auth, async (user) => {
      if(!user){
        window.location.href = "login.html";
        return;
      }
      currentUserUid = user.uid;
      await refresh();
    });
  </script>
</body>
</html>
