<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin — Integrated Payment Verification</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0b0d17;
      color: #eef2f7;
      margin: 0;
      padding: 20px;
    }
    h1 {
      background: linear-gradient(90deg, #4a90e2, #a3ff6e);
      -webkit-background-clip: text;
      color: transparent;
      margin-bottom: 20px;
    }
    .bill-card {
      background: #0f1724;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
      border-left: 4px solid #facc15; /* paid_pending_verification color */
    }
    .bill-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .btn {
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
      margin-right: 10px;
    }
    .btn.verify { background: #4ade80; color: #041018; }
    .btn.reject { background: #ef4444; color: #fff; }
    .offer-breakdown {
      background: #1a2235;
      border-radius: 8px;
      padding: 10px;
      margin-top: 10px;
      display: none;
    }
    .offer {
      border-bottom: 1px solid #2b3145;
      padding: 5px 0;
    }
    .notif {
      background: #1a2235;
      padding: 10px;
      border-left: 4px solid #4ade80;
      border-radius: 8px;
      color: #a3ff6e;
      margin-bottom: 20px;
      display: none;
    }
    .status {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: bold;
      text-transform: capitalize;
      background: #facc15;
      color: #000;
    }
  </style>
</head>
<body>
  <h1>Admin — Integrated Payment Verification</h1>
  <div id="notif" class="notif"></div>
  <div id="verifyContainer">Loading bills pending verification...</div>

  <script type="module">
    import { db } from './firebase.js';
    import { ref, get, update, onValue, push } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js';

    const container = document.getElementById('verifyContainer');
    const notif = document.getElementById('notif');
    const showNotif = (msg) => {
      notif.textContent = msg;
      notif.style.display = 'block';
      setTimeout(() => notif.style.display = 'none', 4000);
    };

    const adminBillsRef = ref(db, 'admin-bills');
    onValue(adminBillsRef, async (snapshot) => {
      container.innerHTML = '';
      if (!snapshot.exists()) {
        container.innerHTML = '<p>No bills pending verification.</p>';
        return;
      }

      const bills = snapshot.val();
      Object.entries(bills)
        .filter(([_, bill]) => bill.status === 'paid_pending_verification')
        .sort((a, b) => new Date(b[1].createdAt) - new Date(a[1].createdAt))
        .forEach(([billId, bill]) => renderBillCard(billId, bill));
    });

    function renderBillCard(billId, bill) {
      const card = document.createElement('div');
      card.className = 'bill-card';
      card.id = billId; // ✅ Assign ID for removal after processing

      let totalsHTML = '';
      Object.entries(bill.totals).forEach(([curr, amt]) => {
        totalsHTML += `<div><strong>${curr}:</strong> ${amt.toFixed(2)}</div>`;
      });

      card.innerHTML = `
        <div class="bill-header">
          <h3>${bill.providerName} — Bill #${billId.slice(-6)}</h3>
          <span class="status ${bill.status}">${bill.status.replace('_', ' ')}</span>
        </div>
        <div><strong>Date:</strong> ${new Date(bill.createdAt).toLocaleString()}</div>
        <div>${totalsHTML}</div>
        <button class="toggleOffers">Show Offer Breakdown</button>
        <div class="offer-breakdown"></div>
        <br>
        <button class="btn verify">✅ Verify Payment</button>
        <button class="btn reject">❌ Reject Payment</button>
      `;

      const breakdown = card.querySelector('.offer-breakdown');
      Object.values(bill.offers).forEach(offer => {
        const offerDiv = document.createElement('div');
        offerDiv.className = 'offer';
        offerDiv.innerHTML = `
          <strong>${offer.offerTitle}</strong><br>
          ${offer.currency} ${offer.total.toFixed(2)} (${offer.deals.length} deals)
        `;
        breakdown.appendChild(offerDiv);
      });

      card.querySelector('.toggleOffers').onclick = () => {
        breakdown.style.display = breakdown.style.display === 'none' ? 'block' : 'none';
      };

      card.querySelector('.verify').onclick = () => processVerification(billId, bill, 'verified');
      card.querySelector('.reject').onclick = () => processVerification(billId, bill, 'pending');

      container.appendChild(card);
    }

    async function processVerification(billId, bill, newStatus) {
      const providerId = bill.providerId;
      const timestamp = new Date().toISOString();
      let updates = {};

      if (newStatus === 'verified') {
        if (!confirm('Confirm verifying this provider payment?')) return;

        for (const offer of Object.values(bill.offers)) {
          let totalPaid = 0;
          for (const d of offer.deals) {
            const dealPath = `completed-deals/${d.id}`;
            updates[`${dealPath}/providerPaid`] = true;
            updates[`${dealPath}/paymentAmount`] = parseFloat(d.commissionEarned);
            updates[`${dealPath}/paymentNotes`] = `Verified by admin on ${timestamp}`;
            totalPaid += parseFloat(d.commissionEarned);
          }

          const offerRefPath = `offers/${providerId}/${offer.offerId}`;
          const offerSnap = await get(ref(db, offerRefPath));
          const currentAmountPaid = offerSnap.exists() ? parseFloat(offerSnap.val().amountPaid || 0) : 0;
          const currentTotalOwed = offerSnap.exists() ? parseFloat(offerSnap.val().outstandingBalance || 0) : 0;

          updates[`${offerRefPath}/amountPaid`] = currentAmountPaid + totalPaid;
          updates[`${offerRefPath}/outstandingBalance`] = Math.max(currentTotalOwed - totalPaid, 0);
        }

        updates[`bills/${providerId}/${billId}/verifiedAt`] = timestamp;

      } else if (newStatus === 'pending') {
        if (!confirm('Reject this payment and return it to pending?')) return;
        updates[`bills/${providerId}/${billId}/rejectionNote`] = `Admin rejected payment verification on ${timestamp}`;
      }

      updates[`bills/${providerId}/${billId}/status`] = newStatus;
      updates[`admin-bills/${billId}/status`] = newStatus;
      updates[`bills/${providerId}/${billId}/updatedAt`] = timestamp;

      const notification = {
        title: newStatus === 'verified' ? 'Payment Verified ✅' : 'Payment Rejected ❌',
        message: newStatus === 'verified'
          ? `Your payment for Bill ${billId.slice(-6)} has been confirmed.`
          : `Your payment for Bill ${billId.slice(-6)} was rejected. Contact support.`,
        createdAt: timestamp,
        type: newStatus === 'verified' ? 'payment_verified' : 'payment_rejected',
        billId: billId
      };

      await push(ref(db, `notifications/${providerId}`), notification);

      try {
        await update(ref(db), updates);
        showNotif(`✅ Bill ${newStatus === 'verified' ? 'verified' : 'rejected'} for ${bill.providerName}`);
        document.getElementById(billId)?.remove();
      } catch (err) {
        console.error(err);
        showNotif('Error processing verification/rejection: ' + err.message);
      }
    }
  </script>
</body>
</html>
