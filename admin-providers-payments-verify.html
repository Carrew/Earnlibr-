<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin — Verify Provider Payments</title>
<style>
body { font-family: Inter,system-ui,Arial; background:#0b0d17; color:#eef2f7; margin:0; padding:20px; }
h1 { font-size:24px; margin-bottom:20px; background:linear-gradient(90deg,#4a90e2,#a3ff6e); -webkit-background-clip:text; color:transparent; }
.notif { display:none; padding:12px 16px; margin-bottom:20px; border-radius:8px; font-weight:600; }
.notif.success { border-left:4px solid #4ade80; color:#4ade80; background:rgba(74,222,128,0.05); }
.notif.error { border-left:4px solid #ef4444; color:#ff8c8c; background:rgba(239,68,68,0.05); }
.bill-card { background:#0f1724; padding:16px; border-radius:12px; margin-bottom:20px; box-shadow:0 8px 20px rgba(0,0,0,0.4); border-left:4px solid #facc15; transition:0.2s; }
.bill-card:hover { transform:translateY(-2px); box-shadow:0 10px 22px rgba(0,0,0,0.5); }
.btn { padding:8px 14px; border:none; border-radius:8px; font-weight:600; cursor:pointer; margin-top:10px; transition:0.2s; }
.btn-verify { background:#4ade80; color:#041018; }
.btn-reject { background:#ef4444; color:#fff; }
.btn-verify:hover, .btn-reject:hover { opacity:0.9; }
.offer-breakdown { margin-top:10px; display:none; }
.offer { border-bottom:1px solid #2b3145; padding:6px 0; }
.deal-item { font-size:13px; margin-left:12px; padding:2px 0; }
.btn-toggleOffers { background:#3b82f6; color:#fff; margin-top:10px; }
.btn-toggleOffers:hover { opacity:0.9; }
.status { display:inline-block; padding:4px 8px; border-radius:6px; font-size:13px; font-weight:bold; text-transform:capitalize; background:#facc15; color:#000; margin-left:10px; }
.status.paid { background:#4ade80; color:#041018; }
.status.rejected { background:#ef4444; color:#fff; }
</style>
</head>
<body>

<h1>Admin — Verify Provider Payments</h1>
<div id="notif" class="notif"></div>
<div id="paymentsContainer">Loading provider payments...</div>

<script type="module">
import { auth, db } from './firebase.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { collection, query, where, onSnapshot, doc, updateDoc, addDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const notif = document.getElementById("notif");
const paymentsContainer = document.getElementById("paymentsContainer");

const showNotif = (msg, type='success')=>{
  notif.textContent = msg;
  notif.className = `notif ${type}`;
  notif.style.display='block';
  setTimeout(()=> notif.style.display='none',4000);
};

// --- AUTH CHECK ---
let userSession = localStorage.getItem("userSession");
if(!userSession){ window.location.href = "login.html"; throw new Error("No session"); }
userSession = JSON.parse(userSession);

onAuthStateChanged(auth, async (user)=>{
  if(!user || user.uid !== userSession.uid){
    localStorage.removeItem("userSession");
    window.location.href="login.html";
    return;
  }

  if(!user.emailVerified){
    localStorage.removeItem("userSession");
    window.location.href="login.html";
    return;
  }

  const userDoc = await getDoc(doc(db, 'users', user.uid));
  if(!userDoc.exists() || !["admin","super_admin"].includes(userDoc.data().role)){
    localStorage.removeItem("userSession");
    window.location.href="login.html";
    return;
  }

  // Passed auth — load bills
  loadBills();
});

// --- Load Bills ---
function loadBills(){
  const billsQuery = query(collection(db, "bills"), where("status","==","paid_pending_verification"));

  onSnapshot(billsQuery, snapshot=>{
    paymentsContainer.innerHTML="";
    if(snapshot.empty){
      paymentsContainer.innerHTML="<p style='opacity:.6;text-align:center;'>No payments pending verification.</p>";
      return;
    }

    snapshot.docs.forEach(docSnap=>{
      const bill = docSnap.data();
      renderBillCard(bill);
    });
  });
}

// --- Render Bill Card ---
function renderBillCard(bill){
  const card = document.createElement("div");
  card.className="bill-card";

  let totalsHTML="";
  Object.entries(bill.totals || {}).forEach(([curr, amt])=>{
    totalsHTML += `<div><strong>${curr} Total:</strong> ${amt.toFixed(2)}</div>`;
  });

  card.innerHTML=`
    <h3>Provider: ${bill.providerName} — Bill #${bill.billId.slice(-6)} <span class="status">${bill.status}</span></h3>
    <div><strong>Created:</strong> ${new Date(bill.createdAt).toLocaleString()}</div>
    <div>${totalsHTML}</div>
    <button class="btn btn-toggleOffers">Show Offer & Deals Breakdown</button>
    <div class="offer-breakdown"></div>
    <button class="btn btn-verify">✅ Confirm Payment</button>
    <button class="btn btn-reject">❌ Reject Payment</button>
  `;

  const breakdown = card.querySelector(".offer-breakdown");

  // Offer & deal breakdown
  Object.values(bill.offers || {}).forEach(offer=>{
    const offerDiv = document.createElement("div");
    offerDiv.className="offer";
    offerDiv.innerHTML=`<strong>${offer.offerTitle} — ${offer.currency} ${offer.total.toFixed(2)}</strong>`;
    offer.deals.forEach(d=>{
      const dealDiv = document.createElement("div");
      dealDiv.className="deal-item";
      dealDiv.textContent=`DealID: ${d.dealId} | Client: ${d.clientName} | Commission: ${d.commissionEarned.toFixed(2)} | Note: ${d.note||"None"}`;
      offerDiv.appendChild(dealDiv);
    });
    breakdown.appendChild(offerDiv);
  });

  // Toggle breakdown
  card.querySelector(".btn-toggleOffers").onclick=()=>{ breakdown.style.display = breakdown.style.display==="none"?"block":"none"; };

  // Confirm payment
  card.querySelector(".btn-verify").onclick=async ()=>{
    if(!confirm("Confirm verifying this provider payment?")) return;
    try{
      const timestamp = new Date().toISOString();
      const providerId = bill.providerId;

      // Update completed deals
      for(const offer of Object.values(bill.offers || {})){
        for(const deal of offer.deals){
          const dealRef = doc(db, "completedDeals", deal.dealId);
          await updateDoc(dealRef, { providerPaid: true, paymentAmount: deal.commissionEarned, paymentNotes: `Verified by admin on ${timestamp}` });
        }
      }

      // Update provider & global bills
      const providerBillRef = doc(db, "providers", providerId, "bills", bill.billId);
      const globalBillRef = doc(db, "bills", bill.billId);
      await updateDoc(providerBillRef, { status: "paid", verifiedAt: timestamp });
      await updateDoc(globalBillRef, { status: "paid", verifiedAt: timestamp });

      // Notify provider
      await addDoc(collection(db, `providers/${providerId}/notifications`), {
        type: "payment_verified",
        billId: bill.billId,
        message: `Your payment for Bill #${bill.billId.slice(-6)} has been verified.`,
        createdAt: timestamp,
        unread: true
      });

      card.remove();
      showNotif(`Bill #${bill.billId.slice(-6)} marked as Paid`);
    } catch(err){
      console.error(err);
      showNotif("Error verifying payment: "+err.message,"error");
    }
  };

  // Reject payment
  card.querySelector(".btn-reject").onclick=async ()=>{
    if(!confirm("Reject this provider payment?")) return;
    try{
      const timestamp = new Date().toISOString();
      const providerId = bill.providerId;

      const providerBillRef = doc(db, "providers", providerId, "bills", bill.billId);
      const globalBillRef = doc(db, "bills", bill.billId);
      await updateDoc(providerBillRef, { status: "rejected", rejectionNote:`Admin rejected payment on ${timestamp}` });
      await updateDoc(globalBillRef, { status: "rejected" });

      await addDoc(collection(db, `providers/${providerId}/notifications`), {
        type: "payment_rejected",
        billId: bill.billId,
        message: `Your payment for Bill #${bill.billId.slice(-6)} has been rejected.`,
        createdAt: timestamp,
        unread: true
      });

      card.remove();
      showNotif(`Bill #${bill.billId.slice(-6)} rejected`,"error");
    } catch(err){
      console.error(err);
      showNotif("Error rejecting payment: "+err.message,"error");
    }
  };

  paymentsContainer.appendChild(card);
}
</script>

</body>
</html>
