<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EarnLibr — Admin Verify Payments</title>
<style>
body { font-family: Arial,sans-serif; background:#0b0d17; color:#eef2f7; padding:20px; }
h1 { background: linear-gradient(90deg,#4a90e2,#a3ff6e); -webkit-background-clip:text; color:transparent; margin-bottom:20px; }
.bill-card { background:#0f1724; padding:15px; border-radius:12px; margin-bottom:15px; box-shadow:0 5px 15px rgba(0,0,0,0.5); transition: opacity 0.5s; }
.bill-card.verified { opacity:0.5; pointer-events:none; }
.btn { background:#4ade80; border:none; padding:6px 12px; border-radius:8px; cursor:pointer; font-weight:700; color:#041018; transition: background 0.3s; }
.btn:hover:not(:disabled) { background:#3ec16b; }
.btn:disabled { opacity:0.6; cursor:not-allowed; }
.notif { background:#1a2235; padding:10px; border-radius:8px; margin-bottom:15px; display:none; transition: opacity 0.3s; }
.notif.success { border-left:4px solid #4ade80; color:#a3ff6e; }
.notif.error { border-left:4px solid #ef4444; color:#ff8c8c; }
</style>
</head>
<body>

<h1>Verify Provider Payments</h1>
<div id="notif" class="notif"></div>
<div id="billsContainer">Loading bills...</div>

<script type="module">
import { auth, db } from './firebase.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { collection, doc, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const billsContainer = document.getElementById("billsContainer");
const notif = document.getElementById("notif");

// --- Show notification ---
const showNotif = (msg,type="success")=>{
  notif.textContent = msg;
  notif.className = `notif ${type}`;
  notif.style.display = "block";
  setTimeout(()=>{ notif.style.display="none"; },3000);
};

// --- Auth check ---
let userSession = localStorage.getItem("userSession");
if(!userSession){ window.location.href="login.html"; throw new Error("No session"); }
userSession = JSON.parse(userSession);

onAuthStateChanged(auth, async user=>{
  if(!user || user.uid !== userSession.uid){ 
    localStorage.removeItem("userSession"); 
    window.location.href="login.html"; 
    return; 
  }
  loadBills();
});

// --- Load bills marked provider_marked_paid ---
function loadBills(){
  const billsRef = collection(db, "bills");
  onSnapshot(billsRef, snapshot=>{
    billsContainer.innerHTML = "";
    snapshot.docs.forEach(docSnap=>{
      const bill = docSnap.data();
      if(bill.status === "provider_marked_paid"){
        const card = document.createElement("div");
        card.className = "bill-card";
        card.innerHTML = `
          <div><strong>Provider:</strong> ${bill.providerName}</div>
          <div><strong>Offer:</strong> ${bill.offerTitle} (${bill.currency})</div>
          <div><strong>Total:</strong> ${bill.total.toFixed(2)}</div>
          <div><strong>Status:</strong> ${bill.status}</div>
        `;
        const btn = document.createElement("button");
        btn.className = "btn";
        btn.textContent = "Verify Payment";
        btn.onclick = ()=>verifyPayment(bill.billId, bill.deals, bill.providerId, btn, card);
        card.appendChild(btn);
        billsContainer.appendChild(card);
      }
    });
  });
}

// --- Verify payment ---
async function verifyPayment(billId, dealObjs, providerId, btn, card){
  btn.disabled = true;
  const originalText = btn.textContent;
  btn.textContent = "Verifying...";
  const timestamp = new Date().toISOString();
  const dealIds = dealObjs.map(d => typeof d === "string" ? d : d.dealId);

  try {
    // Update all deals
    for(const dealId of dealIds){
      const snap = await getDoc(doc(db,"completed-deals",dealId));
      if(!snap.exists()) continue;
      await updateDoc(doc(db,"completed-deals",dealId),{
        providerPaid:true,
        providerPaidAt:timestamp,
        linkedBillId:billId
      });
    }

    // Update bills
    await updateDoc(doc(db,"bills",billId), { status:"verified_paid", adminVerifiedAt:timestamp });
    await updateDoc(doc(db, `providers/${providerId}/bills/${billId}`), { status:"verified_paid", adminVerifiedAt:timestamp });

    showNotif("Payment verified successfully!");
    card.classList.add("verified");          // mark visually
    btn.textContent = "Verified ✅";           // update button
  } catch(err){
    console.error("Verification failed:", err);
    showNotif("Error verifying payment","error");
    btn.disabled = false;
    btn.textContent = originalText;
  }
}
</script>
</body>
</html>
