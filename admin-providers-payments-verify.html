<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EarnLibr — Admin Verify Payments</title>
<style>
body { font-family: Arial,sans-serif; background:#0b0d17; color:#eef2f7; padding:20px; }
h1 { background: linear-gradient(90deg,#4a90e2,#a3ff6e); -webkit-background-clip:text; color:transparent; margin-bottom:20px; }
.controls { margin-bottom: 15px; }
.bill-card { background:#0f1724; padding:15px; border-radius:12px; margin-bottom:15px; box-shadow:0 5px 15px rgba(0,0,0,0.5); transition: opacity 0.5s; }
.bill-card.verified { opacity:0.5; pointer-events:none; }
.btn { background:#4ade80; border:none; padding:6px 12px; border-radius:8px; cursor:pointer; font-weight:700; color:#041018; transition: background 0.3s; margin-right: 8px; }
.btn:hover:not(:disabled) { background:#3ec16b; }
.btn:disabled { opacity:0.6; cursor:not-allowed; }
.notif { background:#1a2235; padding:10px; border-radius:8px; margin-bottom:15px; display:none; transition: opacity 0.3s; }
.notif.success { border-left:4px solid #4ade80; color:#a3ff6e; }
.notif.error { border-left:4px solid #ef4444; color:#ff8c8c; }
</style>
</head>
<body>

<h1>Verify Provider Payments</h1>
<div class="controls">
  <button id="verifyAllBtn" class="btn">Verify All</button>
</div>
<div id="notif" class="notif"></div>
<div id="billsContainer">Loading bills...</div>

<script type="module">
import { auth, db } from './firebase.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { 
    collection, doc, onSnapshot, getDoc, addDoc, serverTimestamp, writeBatch, query, where
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const billsContainer = document.getElementById("billsContainer");
const notif = document.getElementById("notif");
const verifyAllBtn = document.getElementById("verifyAllBtn");

const showNotif = (msg,type="success")=>{
  notif.textContent = msg;
  notif.className = `notif ${type}`;
  notif.style.display = "block";
  setTimeout(()=>{ notif.style.display="none"; },3000);
};

// --- Notification Helper (UPGRADED to use writeBatch for consistency) ---
async function sendNotification(uid, title, message) {
  try {
    const batch = writeBatch(db);
    batch.set(doc(collection(db, `notifications/${uid}/items`)), {
      title,
      message,
      createdAt: serverTimestamp(),
      read: false
    });
    await batch.commit();
  } catch(err) {
    console.error("Batch notification error:", err);
  }
}

let userSession = localStorage.getItem("userSession");
if(!userSession){ window.location.href="login.html"; throw new Error("No session"); }
userSession = JSON.parse(userSession);

onAuthStateChanged(auth, async user=>{
  if(!user || user.uid !== userSession.uid){ 
    localStorage.removeItem("userSession"); 
    window.location.href="login.html"; 
    return; 
  }
  // NOTE: Add admin role check here if not already done in the main auth block
  loadBills();
});

let billCards = [];

function loadBills(){
  // Query only bills marked by the provider as paid
  const billsQuery = query(collection(db, "bills"), where("status", "==", "provider_marked_paid"));
  
  onSnapshot(billsQuery, snapshot=>{
    billsContainer.innerHTML = "";
    billCards = [];
    snapshot.docs.forEach(docSnap=>{
      const bill = docSnap.data();
      
      const card = document.createElement("div");
      card.className = "bill-card";
      card.innerHTML = `
        <div><strong>Provider:</strong> ${bill.providerName}</div>
        <div><strong>Offer:</strong> ${bill.offerTitle} (${bill.currency})</div>
        <div><strong>Total:</strong> ${bill.total.toFixed(2)}</div>
        <div><strong>Status:</strong> ${bill.status}</div>
      `;
      const btn = document.createElement("button");
      btn.className = "btn";
      btn.textContent = "Verify Payment";
      
      // Pass all necessary data to the verification function
      btn.onclick = ()=>verifyPayment(docSnap.id, bill.deals, bill.providerId, btn, card, bill.offerTitle, bill.total, bill.currency);
      
      card.appendChild(btn);
      billsContainer.appendChild(card);
      
      // Store necessary data for the Verify All button
      billCards.push({ 
        billId: docSnap.id, 
        deals: bill.deals, 
        providerId: bill.providerId, 
        btn, 
        card, 
        offerTitle: bill.offerTitle, 
        total: bill.total, 
        currency: bill.currency 
      });
    });
  });
}

// --- Verify single bill (CRITICALLY UPGRADED to use writeBatch) ---
async function verifyPayment(billId, dealIds, providerId, btn, card, offerTitle, total, currency){
  btn.disabled = true;
  const originalText = btn.textContent;
  btn.textContent = "Verifying...";
  
  try {
    const batch = writeBatch(db);
    
    // 1. Update all related deals atomically
    // NOTE: dealIds should already be an array of strings from the Layer 1 bill creation
    dealIds.forEach(dealId => {
      // Mark the deal as fully paid by the provider
      batch.update(doc(db, "completed-deals", dealId), {
        providerPaid: true,
        providerPaidAt: serverTimestamp(), // Use serverTimestamp
        linkedBillId: billId
      });
    });
    
    // 2. Update the bill status in two locations atomically
    const updateBillData = { 
      status: "verified_paid", 
      adminVerifiedAt: serverTimestamp(), // Use serverTimestamp
      adminVerifiedBy: userSession.uid
    };
    batch.update(doc(db, "bills", billId), updateBillData);
    batch.update(doc(db, `providers/${providerId}/bills/${billId}`), updateBillData);

    // Commit the entire atomic operation
    await batch.commit(); 

    // 3. Send notification to provider
    await sendNotification(providerId, "Payment Verified ✅", `Your payment for ${offerTitle} (${total.toFixed(2)} ${currency}) has been verified by admin. Thank you!`);

    card.classList.add("verified");
    btn.textContent = "Verified ✅";
  } catch(err){
    console.error("Verification failed:", err);
    showNotif("Error verifying payment: " + err.message, "error");
    btn.disabled = false;
    btn.textContent = originalText;
  }
}

// --- Verify all concurrently (Now calls the batch-safe verifyPayment) ---
verifyAllBtn.onclick = async () => {
  if(billCards.length === 0) return showNotif("No bills to verify","error");
  verifyAllBtn.disabled = true;
  verifyAllBtn.textContent = "Verifying All...";
  showNotif(`Attempting to verify ${billCards.length} payments...`, "info");

  // Run all verifications concurrently, calling the batch-safe function
  const results = await Promise.all(billCards.map(b => verifyPayment(b.billId, b.deals, b.providerId, b.btn, b.card, b.offerTitle, b.total, b.currency)));

  verifyAllBtn.textContent = "Verify All ✅";
  setTimeout(() => {
    verifyAllBtn.disabled = false;
    verifyAllBtn.textContent = "Verify All";
  }, 2000);
};
</script>
</body>
</html>
