<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EarnLibr â€” Admin Verify Payments</title>
<style>
body { font-family: Arial,sans-serif; background:#0b0d17; color:#eef2f7; padding:20px; }
h1 { background: linear-gradient(90deg,#4a90e2,#a3ff6e); -webkit-background-clip:text; color:transparent; margin-bottom:20px; }
.bill-card { background:#0f1724; padding:15px; border-radius:12px; margin-bottom:15px; box-shadow:0 5px 15px rgba(0,0,0,0.5); }
.btn { background:#4ade80; border:none; padding:6px 12px; border-radius:8px; cursor:pointer; font-weight:700; color:#041018; }
.btn:disabled { opacity:0.6; cursor:not-allowed; }
.notif { background:#1a2235; padding:10px; border-radius:8px; margin-bottom:15px; display:none; }
.notif.success { border-left:4px solid #4ade80; color:#a3ff6e; }
.notif.error { border-left:4px solid #ef4444; color:#ff8c8c; }
</style>
</head>
<body>

<h1>Verify Provider Payments</h1>
<div id="notif" class="notif"></div>
<div id="billsContainer">Loading bills...</div>

<script type="module">
import { auth, db } from './firebase.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { collection, doc, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const billsContainer = document.getElementById("billsContainer");
const notif = document.getElementById("notif");

const showNotif = (msg,type="success")=>{
  notif.textContent=msg;
  notif.className=`notif ${type}`;
  notif.style.display="block";
  setTimeout(()=>{ notif.style.display="none"; },3000);
};

// --- Auth check ---
let userSession = localStorage.getItem("userSession");
if(!userSession){ window.location.href="login.html"; throw new Error("No session"); }
userSession = JSON.parse(userSession);

onAuthStateChanged(auth, async user=>{
  if(!user || user.uid !== userSession.uid){ 
    localStorage.removeItem("userSession"); 
    window.location.href="login.html"; 
    return; 
  }
  loadBills();
});

// --- Load bills marked provider_marked_paid ---
function loadBills(){
  const billsRef = collection(db, "bills");
  onSnapshot(billsRef, snapshot=>{
    billsContainer.innerHTML="";
    snapshot.docs.forEach(docSnap=>{
      const bill = docSnap.data();
      if(bill.status==="provider_marked_paid"){
        const card = document.createElement("div");
        card.className="bill-card";
        card.innerHTML=`
          <div><strong>Provider:</strong> ${bill.providerName}</div>
          <div><strong>Offer:</strong> ${bill.offerTitle} (${bill.currency})</div>
          <div><strong>Total:</strong> ${bill.total.toFixed(2)}</div>
          <div><strong>Status:</strong> ${bill.status}</div>
        `;
        const btn = document.createElement("button");
        btn.className="btn";
        btn.textContent="Verify Payment";
        btn.onclick=()=>verifyPayment(bill.billId, bill.deals, bill.providerId, btn);
        card.appendChild(btn);
        billsContainer.appendChild(card);
      }
    });
  });
}

// --- Debugging helper ---
async function checkDealExists(dealId){
  const snap = await getDoc(doc(db,"completed-deals",dealId));
  return snap.exists();
}

// --- Verify payment ---
async function verifyPayment(billId, dealObjs, providerId, btn){
  btn.disabled=true;
  const timestamp = new Date().toISOString();
  const dealIds = dealObjs.map(d => typeof d === "string" ? d : d.dealId);

  console.log("Verifying bill:", billId, "Deals:", dealIds, "Provider:", providerId);

  try {
    // Step 1: Update all deals
    for(const dealId of dealIds){
      const exists = await checkDealExists(dealId);
      if(!exists){
        console.warn("Deal does not exist:", dealId);
        continue; // skip missing deals
      }
      try{
        await updateDoc(doc(db,"completed-deals",dealId),{
          providerPaid:true,
          providerPaidAt:timestamp,
          linkedBillId:billId
        });
        console.log("Updated deal:", dealId);
      }catch(err){
        console.error("Failed to update deal:",dealId,err);
      }
    }

    // Step 2: Update bill documents
    try{
      await updateDoc(doc(db,"bills",billId), { status:"verified_paid", adminVerifiedAt:timestamp });
      console.log("Updated main bill:", billId);
    }catch(err){ console.error("Failed to update main bill:", err); }

    try{
      await updateDoc(doc(db, `providers/${providerId}/bills/${billId}`), { status:"verified_paid", adminVerifiedAt:timestamp });
      console.log("Updated provider bill:", billId);
    }catch(err){ console.error("Failed to update provider bill:", err); }

    showNotif("Payment verified and deals marked paid!");
  }catch(err){
    console.error("Verification failed:", err);
    showNotif("Error verifying payment: " + err.message,"error");
  }finally{
    btn.disabled=false;
  }
}
</script>
</body>
</html>
