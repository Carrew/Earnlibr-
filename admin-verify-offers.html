<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EarnLibr ‚Äî Admin Verify Offers</title>
<style>
  body { font-family: Arial, sans-serif; background:#0b0d17; color:#eef2f7; margin:0; padding:20px;}
  h1 { background: linear-gradient(90deg,#4a90e2,#a3ff6e); -webkit-background-clip:text; color:transparent; }

  .offer-card {
    background:#0f1724; border-radius:12px; padding:15px; margin-bottom:15px;
    display:flex; gap:15px; align-items:flex-start; position:relative;
    transition: opacity 0.3s ease;
  }
  .offer-card img {
    width:120px; height:80px; object-fit:cover; border-radius:8px;
    transition: transform 0.2s ease; cursor:pointer;
  }
  .offer-card img:hover { transform: scale(2); z-index: 10; position: relative; }

  .offer-details { flex:1; line-height:1.4; }
  .offer-actions button { margin-right:8px; padding:6px 12px; border:none; border-radius:8px; cursor:pointer; font-weight:700;}
  .approve { background:#4ade80; color:#041018; }
  .reject { background:#ef4444; color:#fff; }

  .notification {
    position: absolute;
    top:5px; right:5px;
    padding:6px 12px;
    border-radius:8px;
    font-size:0.9rem;
    font-weight:700;
    opacity:0.9;
  }
  .notification.success { background:#4ade80; color:#041018; }
  .notification.error { background:#ef4444; color:#fff; }
  .notification.info { background:#3b82f6; color:#fff; }

  .unauthorized { color: #ef4444; text-align: center; padding: 50px; }
</style>
</head>
<body>

<h1>Pending Offers Verification</h1>
<div id="offersContainer">Loading...</div>

<script type="module">
import { db, auth } from './firebase.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { doc, collection, getDoc, getDocs, deleteDoc, setDoc, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const offersContainer = document.getElementById('offersContainer');
let userSession = null;
const ADMIN_ROLES = ['admin', 'super_admin'];

// --- Utility Functions ---
function showNotification(card, message, type='info', duration=3000) {
  const notif = document.createElement('div');
  notif.className = `notification ${type}`;
  notif.innerText = message;
  card.appendChild(notif);
  setTimeout(() => notif.remove(), duration);
}

async function getProviderInfo(providerId) {
  const userRef = doc(db, 'users', providerId);
  const snap = await getDoc(userRef);
  return snap.exists() ? snap.data() : null;
}

function handleUnauthorized(message) {
  console.error(message);
  offersContainer.innerHTML = `<div class="unauthorized">‚ùå ${message} Redirecting to login...</div>`;
  localStorage.removeItem('userSession');
  setTimeout(() => window.location.href = 'login.html', 2000);
}

// --- 1. SESSION & AUTHENTICATION CHECK ---
const sessionRaw = localStorage.getItem('userSession');
if (sessionRaw) userSession = JSON.parse(sessionRaw);

onAuthStateChanged(auth, async (user) => {
  if (!user) return handleUnauthorized("You are not logged in.");

  try {
    const adminRef = doc(db, 'admins', user.uid);
    const snap = await getDoc(adminRef);

    if (!snap.exists()) return handleUnauthorized("User not found in admin records.");

    const userData = snap.data();
    const role = userData.role || 'admin';

    if (!ADMIN_ROLES.includes(role)) return handleUnauthorized(`Unauthorized role: ${role}.`);

    userSession = {
      uid: user.uid,
      role: role,
      name: userData.name || user.email,
      email: user.email
    };
    localStorage.setItem('userSession', JSON.stringify(userSession));

    loadPendingOffers();

  } catch (err) {
    handleUnauthorized("Database verification failed: " + err.message);
  }
});

// --- 2. CORE DEAL LOADING LOGIC ---
async function loadPendingOffers() {
  const pendingRef = collection(db, 'offers_pending');

  onSnapshot(pendingRef, async (snapshot) => {
    offersContainer.innerHTML = '';
    if (snapshot.empty) {
      offersContainer.innerHTML = '<p>No pending offers.</p>';
      return;
    }

    for (const userDoc of snapshot.docs) {
      const uid = userDoc.id;
      const offersColRef = collection(db, 'offers_pending', uid, 'offers');
      const offersSnap = await getDocs(offersColRef);

      offersSnap.forEach(offerDoc => {
        const offer = offerDoc.data();
        const offerId = offerDoc.id;

        const card = document.createElement('div');
        card.className = 'offer-card';
        card.id = `offer-${offerId}`;
        card.innerHTML = `
          <img src="${offer.imageBase64 || 'https://via.placeholder.com/120x80?text=No+Image'}" alt="Offer Image">
          <div class="offer-details">
            <strong>${offer.title || 'Untitled Offer'}</strong><br>
            ${offer.description || ''}<br>
            üí∞ ${offer.currency || '$'} ${offer.price || 0}<br>
            Commission: ${offer.commissionType || ''} ${offer.commissionValue || 0}<br>
            Total Products: ${offer.totalProducts || 0}<br>
            Promo Budget: ${offer.promotionBudget || 0}<br>
            Promo Spent: 0<br><br>
            <em>Category:</em> ${offer.category || 'Uncategorized'}<br>
            <em>Submitted:</em> ${offer.createdAt ? new Date(offer.createdAt).toLocaleString() : 'N/A'}<br>
            <em>Provider:</em> ${offer.providerPhone || '+231000000000'} (ID: ${uid})
          </div>
          <div class="offer-actions">
            <button class="approve">Approve</button>
            <button class="reject">Reject</button>
          </div>
        `;

        const approveBtn = card.querySelector('.approve');
        const rejectBtn = card.querySelector('.reject');

        approveBtn.onclick = async () => {
          approveBtn.disabled = true;
          rejectBtn.disabled = true;
          showNotification(card, 'Processing approval...', 'info');

          try {
            const providerInfo = await getProviderInfo(uid);
            let cloudUrl = null;

            if (offer.imageBase64) {
              const formData = new FormData();
              formData.append('file', offer.imageBase64);
              formData.append('upload_preset', 'Earnlibr');

              const res = await fetch('https://api.cloudinary.com/v1_1/dye3bda08/image/upload', { method:'POST', body:formData });
              const data = await res.json();
              cloudUrl = data.secure_url;
            }

            const approvedOfferRef = doc(db, 'offers', uid, 'offers', offerId);
            await setDoc(approvedOfferRef, {
              ...offer,
              providerName: providerInfo?.name || "Unknown",
              providerEmail: providerInfo?.email || "",
              providerPhone: providerInfo?.phone || offer.providerPhone || "+231000000000",
              status: 'active',
              verified: true,
              verifiedBy: userSession.role,
              approvedAt: new Date().toISOString(),
              imageUrl: cloudUrl || null
            });

            await deleteDoc(doc(db, 'offers_pending', uid, 'offers', offerId));
            await addDoc(collection(db, 'notifications', uid, 'notifications'), {
              title: 'Offer Approved ‚úÖ',
              message: `Your offer "${offer.title}" has been approved and is now live.`,
              type: 'approved',
              createdAt: new Date().toISOString()
            });

            showNotification(card, 'Offer approved and live.', 'success');
            card.style.opacity = '0';
            setTimeout(() => card.remove(), 300);

          } catch (err) {
            console.error(err);
            showNotification(card, 'Error: ' + err.message, 'error');
            approveBtn.disabled = false;
            rejectBtn.disabled = false;
          }
        };

        rejectBtn.onclick = async () => {
          const confirmReject = confirm('Are you sure you want to reject this offer?');
          if (!confirmReject) return;

          approveBtn.disabled = true;
          rejectBtn.disabled = true;
          showNotification(card, 'Processing rejection...', 'info');

          try {
            await deleteDoc(doc(db, 'offers_pending', uid, 'offers', offerId));
            await addDoc(collection(db, 'notifications', uid, 'notifications'), {
              title: 'Offer Rejected ‚ùå',
              message: `Your offer "${offer.title}" was rejected. Please review and try again.`,
              type: 'rejected',
              createdAt: new Date().toISOString()
            });

            showNotification(card, 'Offer rejected. Provider notified.', 'error');
            card.style.opacity = '0';
            setTimeout(() => card.remove(), 300);

          } catch (err) {
            console.error(err);
            showNotification(card, 'Error: ' + err.message, 'error');
            approveBtn.disabled = false;
            rejectBtn.disabled = false;
          }
        };

        offersContainer.appendChild(card);
      });
    }
  });
}
</script>

</body>
</html>
