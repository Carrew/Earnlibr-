<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EarnLibr ‚Äî Admin Verify Offers</title>

<style>
  body { font-family: Arial, sans-serif; background:#0b0d17; color:#eef2f7; margin:0; padding:20px;}
  h1 { background: linear-gradient(90deg,#4a90e2,#a3ff6e); -webkit-background-clip:text; color:transparent; }

  .offer-card {
    background:#0f1724; border-radius:12px; padding:15px; margin-bottom:15px;
    display:flex; gap:15px; align-items:flex-start; position:relative;
    transition: opacity 0.3s ease;
  }
  .offer-card img {
    width:120px; height:80px; object-fit:cover; border-radius:8px;
    transition: transform 0.2s ease; cursor:pointer;
  }
  .offer-card img:hover { transform: scale(2); z-index: 10; position: relative; }

  .offer-details { flex:1; line-height:1.4; }
  .offer-actions button { margin-right:8px; padding:6px 12px; border:none; border-radius:8px; cursor:pointer; font-weight:700;}
  .approve { background:#4ade80; color:#041018; }
  .reject { background:#ef4444; color:#fff; }

  .notification {
    position: absolute;
    top:5px; right:5px;
    padding:6px 12px;
    border-radius:8px;
    font-size:0.9rem;
    font-weight:700;
    opacity:0.9;
  }
  .notification.success { background:#4ade80; color:#041018; }
  .notification.error { background:#ef4444; color:#fff; }
  .notification.info { background:#3b82f6; color:#fff; }

  .unauthorized { color: #ef4444; text-align: center; padding: 50px; }
</style>
</head>
<body>

<h1>Pending Offers Verification</h1>
<div id="offersContainer">Loading...</div>

<script type="module">
import { db, auth } from './firebase.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { 
  collection, doc, getDoc, getDocs, setDoc, addDoc, deleteDoc 
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const offersContainer = document.getElementById('offersContainer');
const ADMIN_ROLES = ['admin', 'super_admin'];
let userSession = null;

// ================== UTILITY FUNCTIONS ==================
function showNotification(card, message, type='info', duration=3000) {
  const notif = document.createElement('div');
  notif.className = `notification ${type}`;
  notif.innerText = message;
  card.appendChild(notif);
  setTimeout(() => notif.remove(), duration);
}

async function getProviderInfo(providerId) {
  const userDoc = await getDoc(doc(db, "providers", providerId));
  return userDoc.exists() ? userDoc.data() : null;
}

function handleUnauthorized(message) {
  offersContainer.innerHTML = `<div class="unauthorized">‚ùå ${message} Redirecting to login...</div>`;
  localStorage.removeItem('userSession');
  setTimeout(() => window.location.href = 'login.html', 2000);
}

// ================== AUTH & SESSION ==================
const sessionRaw = localStorage.getItem('userSession');
if (sessionRaw) userSession = JSON.parse(sessionRaw);

onAuthStateChanged(auth, async (user) => {
  if (!user) return handleUnauthorized("You are not logged in.");

  try {
    const adminDoc = await getDoc(doc(db, "admins", user.uid));
    if (!adminDoc.exists()) return handleUnauthorized("Admin record not found.");

    const userData = adminDoc.data();
    const role = userData.role || 'admin';
    if (!ADMIN_ROLES.includes(role)) return handleUnauthorized(`Unauthorized role: ${role}.`);

    userSession = {
      uid: user.uid,
      role,
      name: userData.name || user.email,
      email: user.email
    };
    localStorage.setItem('userSession', JSON.stringify(userSession));

    loadPendingOffers();

  } catch (err) {
    handleUnauthorized("Auth verification failed: " + err.message);
  }
});

// ================== LOAD PENDING OFFERS ==================
async function loadPendingOffers() {
  const snapshot = await getDocs(collection(db, "offers_pending"));
  offersContainer.innerHTML = '';

  if (snapshot.empty) {
    offersContainer.innerHTML = '<p>No pending offers.</p>';
    return;
  }

  snapshot.forEach(docSnap => renderOfferCard(docSnap));
}

// ================== RENDER OFFER CARD ==================
function renderOfferCard(docSnap) {
  const offer = docSnap.data();
  const offerId = docSnap.id;
  const providerId = offer.providerId;

  const card = document.createElement('div');
  card.className = 'offer-card';
  card.id = `offer-${offerId}`;
  card.innerHTML = `
    <img src="${offer.imageTemp || 'https://via.placeholder.com/120x80?text=No+Image'}" alt="Offer Image">
    <div class="offer-details">
      <strong>${offer.title || 'Untitled Offer'}</strong><br>
      ${offer.description || ''}<br>
      üí∞ ${offer.currency || '$'} ${offer.price || 0}<br>
      Commission: ${offer.commissionType || ''} ${offer.commissionValue || 0}<br>
      Total Products: ${offer.totalProducts || 0}<br>
      Promo Budget: ${offer.promotionBudget || 0}<br>
      Promo Spent: 0<br><br>
      <em>Category:</em> ${offer.category || 'Uncategorized'}<br>
      <em>Submitted:</em> ${offer.createdAt ? new Date(offer.createdAt).toLocaleString() : 'N/A'}<br>
      <em>Provider ID:</em> ${providerId}
    </div>
    <div class="offer-actions">
      <button class="approve">Approve</button>
      <button class="reject">Reject</button>
    </div>
  `;

  const approveBtn = card.querySelector('.approve');
  const rejectBtn = card.querySelector('.reject');

  approveBtn.onclick = () => approveOffer(card, offer, offerId, providerId);
  rejectBtn.onclick = () => rejectOffer(card, offer, offerId, providerId);

  offersContainer.appendChild(card);
}

// ================== APPROVE OFFER ==================
async function approveOffer(card, offer, offerId, providerId) {
  const approveBtn = card.querySelector('.approve');
  const rejectBtn = card.querySelector('.reject');
  approveBtn.disabled = true;
  rejectBtn.disabled = true;
  showNotification(card, "Processing approval...", "info");

  try {
    const providerInfo = await getProviderInfo(providerId);
    let cloudUrl = null;

    if (offer.imageTemp) {
      const formData = new FormData();
      formData.append('file', offer.imageTemp);
      formData.append('upload_preset', 'Earnlibr');

      const res = await fetch('https://api.cloudinary.com/v1_1/dye3bda08/image/upload', { method: 'POST', body: formData });
      const data = await res.json();
      cloudUrl = data.secure_url;
    }

    // --- Enhanced Offer Object ---
    const approvedOffer = {
      ...offer,
      providerId,
      providerName: providerInfo?.name || "Unknown",
      providerEmail: providerInfo?.email || "",
      providerPhone: providerInfo?.phone || "+000000000",
      role: providerInfo?.role || "provider",
      imageUrl: cloudUrl || offer.imageUrl || null,
      status: "active",
      verified: true,
      verifiedBy: userSession.role,
      approvedAt: new Date().toISOString(),
      promoSpent: offer.promoSpent || 0,
      amountOwed: 0,
      amountPaid: 0,
      outstandingBalance: 0,
      paymentStatus: 'unpaid',
      paymentDeadline: null,
      nextBillingDate: null,
      lastBilledAt: null,
      paymentNotes: '',
      providerStats: { totalDeals: 0, completedDeals: 0, cancelledDeals: 0 },
      totalDealsGenerated: 0,
      totalDealsCompleted: 0,
      totalEarned: 0,
    };

    // --- Save globally & under provider ---
    await setDoc(doc(db, "offers_all", offerId), approvedOffer);
    await setDoc(doc(db, `providers/${providerId}/offers`, offerId), approvedOffer);

    // --- Remove pending version ---
    await deleteDoc(doc(db, "offers_pending", offerId));

    // --- Notify provider ---
    await addDoc(collection(db, `notifications/${providerId}/notifications`), {
      title: "Offer Approved ‚úÖ",
      message: `Your offer "${offer.title}" has been approved and is now live.`,
      type: "approved",
      createdAt: new Date().toISOString()
    });

    showNotification(card, "Offer approved successfully!", "success");
    card.style.opacity = "0";
    setTimeout(() => card.remove(), 300);

  } catch (err) {
    console.error(err);
    showNotification(card, "Error: " + err.message, "error");
    approveBtn.disabled = false;
    rejectBtn.disabled = false;
  }
}

// ================== REJECT OFFER ==================
async function rejectOffer(card, offer, offerId, providerId) {
  if (!confirm("Are you sure you want to reject this offer?")) return;
  const approveBtn = card.querySelector('.approve');
  const rejectBtn = card.querySelector('.reject');
  approveBtn.disabled = true;
  rejectBtn.disabled = true;
  showNotification(card, "Rejecting offer...", "info");

  try {
    await deleteDoc(doc(db, "offers_pending", offerId));
    await addDoc(collection(db, `notifications/${providerId}/notifications`), {
      title: "Offer Rejected ‚ùå",
      message: `Your offer "${offer.title}" was rejected. Please review and resubmit.`,
      type: "rejected",
      createdAt: new Date().toISOString()
    });

    showNotification(card, "Offer rejected and provider notified.", "error");
    card.style.opacity = "0";
    setTimeout(() => card.remove(), 300);
  } catch (err) {
    console.error(err);
    showNotification(card, "Error: " + err.message, "error");
    approveBtn.disabled = false;
    rejectBtn.disabled = false;
  }
}
</script>
</body>
</html>
