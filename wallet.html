<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EarnLibr — Promoter Wallet</title>
  <style>
    body { font-family: Arial, sans-serif; background: #0b0d17; color: #eef2f7; margin: 0; padding: 20px; }
    h1 { background: linear-gradient(90deg, #4a90e2, #a3ff6e); -webkit-background-clip: text; color: transparent; margin-bottom: 20px; }
    .wallet-summary { background: #1a2235; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
    .deal-item { background: #0f1724; padding: 10px; margin: 5px 0; border-radius: 8px; cursor: pointer; }
    .deal-list { display: none; margin-top: 10px; }
    .btn-withdraw { background: #4ade80; color: #041018; padding: 10px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; margin-top: 10px; }
    .notif { display: none; margin-bottom: 20px; padding: 10px; border-radius: 8px; }
    .notif.success { border-left: 4px solid #4ade80; color: #a3ff6e; }
    .notif.error { border-left: 4px solid #ef4444; color: #ff8c8c; }
  </style>
</head>
<body>

<h1>Promoter Wallet</h1>
<div id="notif" class="notif"></div>
<div id="walletContainer">Loading wallet...</div>

<script type="module">
import { db } from './firebase.js';
import { ref, get, update, push } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js';

const promoterId = "PROMOTER_ID_HERE"; // replace with logged-in promoter ID
const walletContainer = document.getElementById('walletContainer');
const notif = document.getElementById('notif');
const showNotif = (msg, type='success') => {
  notif.textContent = msg;
  notif.className = `notif ${type}`;
  notif.style.display = 'block';
  setTimeout(() => notif.style.display = 'none', 4000);
};

async function fetchWallet() {
  walletContainer.innerHTML = "Loading wallet...";
  try {
    const promoterSnap = await get(ref(db, `promoter-earnings/${promoterId}`));
    if (!promoterSnap.exists()) {
      walletContainer.innerHTML = "<p>No earnings found yet.</p>";
      return;
    }

    const promoterData = promoterSnap.val();
    const deals = promoterData.deals || {};
    const metadata = promoterData.metadata || {};
    
    // Filter deals not withdrawn
    const withdrawableDeals = Object.entries(deals)
      .filter(([dealId, deal]) => !deal.withdrawn)
      .map(([dealId, deal]) => ({ id: dealId, ...deal }));

    const totalWithdrawable = withdrawableDeals.reduce((acc, deal) => acc + parseFloat(deal.commissionAmount || 0), 0);
    const lifetimeEarnings = parseFloat(metadata.totalLifetimeEarnings || 0);
    const totalWithdrawn = parseFloat(metadata.totalWithdrawn || 0);

    // Display summary
    walletContainer.innerHTML = `
      <div class="wallet-summary">
        <p><strong>Current Balance:</strong> ${totalWithdrawable.toFixed(2)}</p>
        <p><strong>Total Withdrawn:</strong> ${totalWithdrawn.toFixed(2)}</p>
        <p><strong>Lifetime Earnings:</strong> ${lifetimeEarnings.toFixed(2)}</p>
      </div>
    `;

    // Display deal list (expandable)
    if (withdrawableDeals.length) {
      const dealListDiv = document.createElement('div');
      withdrawableDeals.forEach(deal => {
        const dealDiv = document.createElement('div');
        dealDiv.className = 'deal-item';
        dealDiv.innerHTML = `<strong>${deal.offerTitle}</strong> — ${deal.commissionAmount.toFixed(2)} | Completed: ${new Date(deal.completedAt).toLocaleString()}`;

        const dealDetails = document.createElement('div');
        dealDetails.className = 'deal-list';
        dealDetails.innerHTML = `
          <p>Provider: ${deal.providerName} (${deal.providerId})</p>
          <p>Client: ${deal.clientName} | ${deal.clientContact}</p>
          <p>Note: ${deal.note || 'None'}</p>
        `;

        dealDiv.onclick = () => {
          dealDetails.style.display = dealDetails.style.display === 'none' ? 'block' : 'none';
        };
        dealDiv.appendChild(dealDetails);
        walletContainer.appendChild(dealDiv);
      });

      // Withdraw button
      const withdrawBtn = document.createElement('button');
      withdrawBtn.className = 'btn-withdraw';
      withdrawBtn.textContent = `Request Withdrawal (${totalWithdrawable.toFixed(2)})`;
      withdrawBtn.onclick = async () => {
        try {
          // 1️⃣ Mark deals as pending withdrawal
          const updates = {};
          withdrawableDeals.forEach(deal => {
            updates[`promoter-earnings/${promoterId}/deals/${deal.id}/withdrawn`] = true;
          });
          await update(ref(db), updates);

          // 2️⃣ Notify admin
          await push(ref(db, 'admin-notifications'), {
            promoterId,
            totalAmount: totalWithdrawable,
            deals: withdrawableDeals.map(d => ({ id: d.id, offerTitle: d.offerTitle, amount: d.commissionAmount })),
            type: 'promoterWithdrawalRequest',
            createdAt: new Date().toISOString()
          });

          showNotif(`Withdrawal request sent for ${totalWithdrawable.toFixed(2)}.`, 'success');
          fetchWallet(); // refresh wallet
        } catch (err) {
          console.error(err);
          showNotif('Error requesting withdrawal: ' + err.message, 'error');
        }
      };
      walletContainer.appendChild(withdrawBtn);
    } else {
      walletContainer.innerHTML += "<p>No withdrawable earnings at this time.</p>";
    }
  } catch (err) {
    console.error(err);
    walletContainer.innerHTML = "<p>Error loading wallet: " + err.message + "</p>";
  }
}

// Initialize
fetchWallet();
</script>

</body>
</html>
