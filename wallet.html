<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Promoter Wallet — EarnLibr</title>
  <style>
    body { font-family: Arial, sans-serif; background: #0b0d17; color: #eef2f7; margin: 0; padding: 20px; }
    h1 { background: linear-gradient(90deg, #4ade80, #22d3ee); -webkit-background-clip: text; color: transparent; margin-bottom: 20px; }
    .wallet { background: #0f1724; border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.4); }
    .balance { font-size: 18px; margin-bottom: 10px; }
    .deal-card { background: #1a2235; border-radius: 10px; padding: 10px; margin-bottom: 10px; }
    .deal-info { font-size: 14px; margin-bottom: 4px; }
    .btn { background: #4ade80; border: none; color: #041018; font-weight: bold; border-radius: 6px; padding: 6px 12px; cursor: pointer; margin-top: 10px; }
    .btn.request { background: #22d3ee; }
    .notif { background: #1a2235; border-left: 4px solid #4ade80; color: #a3ff6e; padding: 10px; margin-bottom: 20px; border-radius: 8px; display: none; }
  </style>
</head>
<body>
  <h1>Promoter Wallet</h1>
  <div id="notif" class="notif"></div>

  <div id="walletContainer" class="wallet">
    Loading wallet...
  </div>

  <script type="module">
    import { db } from './firebase.js';
    import { ref, onValue, push, get, update } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js';

    const walletContainer = document.getElementById('walletContainer');
    const notif = document.getElementById('notif');
    const showNotif = (msg, type = 'success') => {
      notif.textContent = msg;
      notif.style.display = 'block';
      notif.style.borderLeft = type === 'error' ? '4px solid #ef4444' : '4px solid #4ade80';
      setTimeout(() => notif.style.display = 'none', 4000);
    };

    // ⚡ Replace with logged-in promoter ID
    const promoterId = "promoter123";

    const promoterRef = ref(db, `promoter-earnings/${promoterId}`);
    onValue(promoterRef, async (snapshot) => {
      walletContainer.innerHTML = '';
      if (!snapshot.exists()) {
        walletContainer.innerHTML = '<p>No wallet data found.</p>';
        return;
      }

      const data = snapshot.val();
      const metadata = data.metadata || {};
      const deals = data.deals || {};

      const currentBalance = metadata.currentBalance || 0;
      const lifetimeEarnings = metadata.totalLifetimeEarnings || 0;
      const totalWithdrawn = metadata.totalWithdrawn || 0;

      walletContainer.innerHTML = `
        <div class="balance"><strong>Current Balance:</strong> $${currentBalance.toFixed(2)}</div>
        <div class="balance"><strong>Total Lifetime Earnings:</strong> $${lifetimeEarnings.toFixed(2)}</div>
        <div class="balance"><strong>Total Withdrawn:</strong> $${totalWithdrawn.toFixed(2)}</div>
      `;

      // Pending deals for withdrawal
      const pendingDeals = Object.entries(deals).filter(([_, d]) => d.withdrawn === false);
      if (pendingDeals.length === 0) {
        walletContainer.innerHTML += '<p>No pending deals for withdrawal.</p>';
      } else {
        walletContainer.innerHTML += '<h3>Pending Deals:</h3>';
        pendingDeals.forEach(([dealId, deal]) => {
          const dealDiv = document.createElement('div');
          dealDiv.className = 'deal-card';
          dealDiv.innerHTML = `
            <div class="deal-info"><strong>Deal:</strong> ${deal.offerTitle} (${deal.currency || 'USD'} ${deal.commissionAmount.toFixed(2)})</div>
            <div class="deal-info"><strong>Provider:</strong> ${deal.providerName}</div>
            <div class="deal-info"><strong>Client:</strong> ${deal.clientName}</div>
            <div class="deal-info"><strong>Completed At:</strong> ${new Date(deal.completedAt).toLocaleString()}</div>
          `;
          walletContainer.appendChild(dealDiv);
        });

        // Withdrawal request button
        const withdrawBtn = document.createElement('button');
        withdrawBtn.className = 'btn request';
        withdrawBtn.textContent = 'Request Withdrawal';
        withdrawBtn.onclick = async () => {
          if (!confirm('Confirm withdrawal request for all pending deals?')) return;

          try {
            const timestamp = new Date().toISOString();
            const withdrawalId = `wr-${Date.now()}`;

            // Create withdrawal request
            await push(ref(db, `withdrawal-requests`), {
              promoterId,
              dealIds: pendingDeals.map(([id]) => id),
              amount: currentBalance,
              status: 'pending',
              requestedAt: timestamp
            });

            // Mark all deals as withdrawn = true in promoter-earnings (FIFO basis)
            let updates = {};
            pendingDeals.forEach(([dealId, _]) => {
              updates[`promoter-earnings/${promoterId}/deals/${dealId}/withdrawn`] = true;
            });

            // Update promoter metadata
            updates[`promoter-earnings/${promoterId}/metadata/currentBalance`] = 0;
            updates[`promoter-earnings/${promoterId}/metadata/lastUpdated`] = timestamp;

            await update(ref(db), updates);

            showNotif(`✅ Withdrawal request submitted for $${currentBalance.toFixed(2)}.`);
          } catch (err) {
            console.error(err);
            showNotif('Error requesting withdrawal: ' + err.message, 'error');
          }
        };

        walletContainer.appendChild(withdrawBtn);
      }
    });
  </script>
</body>
</html>
