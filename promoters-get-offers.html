<!DOCTYPE html>  
<html lang="en">  
<head>  
<meta charset="UTF-8" />  
<meta name="viewport" content="width=device-width, initial-scale=1.0" />  
<title>EarnLibr ‚Äî Promoters Get Offers</title>  
<style>  
:root {  
  --bg: #090c14;  
  --card: rgba(20, 25, 38, 0.85);  
  --accent1: #4a90e2;  
  --accent2: #a3ff6e;  
  --muted: #9ca3af;  
  --radius: 14px;  
  --text: #e5e7eb;  
}  

body {  
  margin: 0;  
  font-family: "Inter", system-ui, Arial;  
  background: radial-gradient(circle at top, #0d111c 0%, #090c14 80%);  
  color: var(--text);  
  min-height: 100vh;  
  padding: 30px 20px;  
}  

header {  
  display: flex;  
  justify-content: space-between;  
  align-items: center;  
  margin-bottom: 25px;  
}  

h1 {  
  font-size: 26px;  
  background: linear-gradient(90deg, var(--accent1), var(--accent2));  
  -webkit-background-clip: text;  
  color: transparent;  
  font-weight: 700;  
}  

.profile-btn {  
  background: transparent;  
  color: var(--text);  
  border: 1px solid rgba(255, 255, 255, 0.15);  
  border-radius: var(--radius);  
  padding: 8px 14px;  
  cursor: pointer;  
  transition: all 0.2s;  
}  
.profile-btn:hover { background: rgba(255, 255, 255, 0.1); }  

.filter-bar {  
  display: flex;  
  flex-wrap: wrap;  
  gap: 12px;  
  align-items: center;  
  margin-bottom: 25px;  
  background: rgba(255, 255, 255, 0.05);  
  padding: 12px 16px;  
  border-radius: var(--radius);  
  backdrop-filter: blur(10px);  
}  

.filter-bar select,  
.filter-bar input {  
  background: rgba(255, 255, 255, 0.08);  
  border: 1px solid rgba(255, 255, 255, 0.1);  
  color: var(--text);  
  border-radius: 8px;  
  padding: 8px 10px;  
  font-size: 14px;  
  outline: none;  
}  

.filter-bar select:focus,  
.filter-bar input:focus { border-color: var(--accent1); }  

.filter-bar button {  
  background: linear-gradient(90deg, var(--accent1), var(--accent2));  
  border: none;  
  border-radius: 8px;  
  padding: 8px 12px;  
  cursor: pointer;  
  color: #0b0f14;  
  font-weight: 600;  
  transition: 0.2s;  
}  
.filter-bar button:hover { opacity: 0.9; }  

.offer-grid {  
  display: grid;  
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));  
  gap: 24px;  
  transition: opacity 0.3s;  
}  

.offer-card {  
  backdrop-filter: blur(14px);  
  background: var(--card);  
  border-radius: var(--radius);  
  padding: 16px;  
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);  
  transition: transform 0.25s, box-shadow 0.25s;  
  border: 1px solid rgba(255, 255, 255, 0.05);  
  overflow: hidden;  
}  

.offer-card:hover {  
  transform: translateY(-6px);  
  box-shadow: 0 6px 18px rgba(74, 144, 226, 0.25);  
}  

.offer-card img {  
  width: 100%;  
  height: 200px;  
  object-fit: cover;  
  border-radius: 10px;  
  margin-bottom: 12px;  
}  

.offer-title {  
  font-weight: 600;  
  font-size: 18px;  
  color: #fff;  
  margin-bottom: 8px;  
}  

.offer-desc {  
  font-size: 14px;  
  color: var(--muted);  
  margin: 4px 0;  
}  

.status {  
  display: inline-block;  
  padding: 5px 12px;  
  border-radius: 8px;  
  font-size: 13px;  
  margin-top: 8px;  
  font-weight: 600;  
  text-transform: capitalize;  
}  
.status.active {  
  background: rgba(34, 197, 94, 0.15);  
  color: #4ade80;  
}  

.actions {  
  margin-top: 16px;  
  display: flex;  
  flex-wrap: wrap;  
  gap: 8px;  
}  

.btn {  
  flex: 1;  
  border: none;  
  border-radius: 8px;  
  padding: 10px;  
  font-size: 14px;  
  cursor: pointer;  
  color: #fff;  
  font-weight: 500;  
  transition: all 0.2s ease;  
  display: flex;  
  align-items: center;  
  justify-content: center;  
  gap: 6px;  
}  
.btn span.icon { font-size: 16px; }  
.btn.copy { background: var(--accent1); }  
.btn.download { background: #6366f1; }  
.btn.share {  
  background: linear-gradient(90deg, var(--accent2), #5cf060);  
  color: #0a0f12;  
  font-weight: 600;  
}  
.btn:hover { opacity: 0.9; }  

.notification {  
  position: fixed;  
  top: 20px;  
  right: 20px;  
  padding: 14px 22px;  
  border-radius: 10px;  
  background: linear-gradient(90deg, var(--accent1), var(--accent2));  
  color: #fff;  
  font-weight: 600;  
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);  
  opacity: 0;  
  transform: translateY(-10px);  
  transition: opacity 0.3s, transform 0.3s;  
  z-index: 9999;  
}  
.notification.show { opacity: 1; transform: translateY(0); }  

/* Skeleton loading */  
.skeleton-card {  
  backdrop-filter: blur(14px);  
  background: var(--card);  
  border-radius: var(--radius);  
  padding: 16px;  
  margin-bottom: 20px;  
  border: 1px solid rgba(255, 255, 255, 0.04);  
  position: relative;  
  overflow: hidden;  
}  
.skeleton-img {  
  width: 100%;  
  height: 200px;  
  border-radius: 10px;  
  background: #111827;  
  margin-bottom: 12px;  
  position: relative;  
  overflow: hidden;  
}  
.skeleton-line {  
  height: 10px;  
  border-radius: 999px;  
  background: #111827;  
  margin-bottom: 8px;  
  position: relative;  
  overflow: hidden;  
}  
.skeleton-line.short { width: 40%; }  
.skeleton-line.medium { width: 60%; }  
.skeleton-line.long { width: 90%; }  

.skeleton-img::before,  
.skeleton-line::before {  
  content: '';  
  position: absolute;  
  inset: 0;  
  background: linear-gradient(90deg,  
    rgba(15, 23, 42, 0) 0%,  
    rgba(55, 65, 81, 0.9) 50%,  
    rgba(15, 23, 42, 0) 100%  
  );  
  transform: translateX(-100%);  
  animation: shimmer 1.2s infinite;  
}  

@keyframes shimmer {  
  100% { transform: translateX(100%); }  
}  

/* Empty state */  
.empty-state {  
  padding: 20px 18px;  
  border-radius: var(--radius);  
  background: rgba(20, 25, 38, 0.9);  
  border: 1px dashed rgba(148, 163, 184, 0.5);  
  font-size: 13px;  
  color: var(--muted);  
  text-align: center;  
}  
.empty-state strong {  
  display: block;  
  margin-bottom: 4px;  
  color: #e5e7eb;  
}  
</style>  
</head>  
<body>  
<header>  
  <h1>üéØ Promoter Offers</h1>  
</header>  

<div class="filter-bar">  
  <select id="categoryFilter"><option value="">All Categories</option></select>  
  <input type="text" id="searchInput" placeholder="Search offers..." />  
  <button id="clearFilters">Clear Filters</button>  
</div>  

<div id="offerGrid" class="offer-grid"></div>  
<div id="notification" class="notification"></div>  

<script type="module">  
import { auth, db } from "./firebase.js";  
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";  
import { doc, getDoc, collection, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";  

const offerGrid = document.getElementById('offerGrid');  
const notification = document.getElementById('notification');  
const categoryFilter = document.getElementById('categoryFilter');  
const searchInput = document.getElementById('searchInput');  
const clearFiltersBtn = document.getElementById('clearFilters');  

let allOffers = [];  
let skeletonContainer = null;  
let promotedOfferIds = new Set(); // offers this promoter is already promoting  

function showNotification(message) {  
  notification.textContent = message;  
  notification.classList.add('show');  
  setTimeout(() => notification.classList.remove('show'), 2500);  
}  

// Skeleton helpers  
function createSkeletonCard() {  
  const card = document.createElement('div');  
  card.className = 'skeleton-card';  
  card.innerHTML = `  
    <div class="skeleton-img"></div>  
    <div class="skeleton-line medium"></div>  
    <div class="skeleton-line long"></div>  
    <div class="skeleton-line short"></div>  
  `;  
  return card;  
}  

function showSkeleton(count = 3) {  
  hideSkeleton();  
  skeletonContainer = document.createElement('div');  
  skeletonContainer.style.display = 'grid';  
  skeletonContainer.style.gridTemplateColumns = 'repeat(auto-fill, minmax(340px, 1fr))';  
  skeletonContainer.style.gap = '24px';  

  for (let i = 0; i < count; i++) {  
    skeletonContainer.appendChild(createSkeletonCard());  
  }  

  offerGrid.innerHTML = '';  
  offerGrid.appendChild(skeletonContainer);  
}  

function hideSkeleton() {  
  if (skeletonContainer && skeletonContainer.parentNode) {  
    skeletonContainer.parentNode.removeChild(skeletonContainer);  
  }  
  skeletonContainer = null;  
}  

// Load which offers this promoter is already promoting  
async function loadPromotedOffers(promoterId) {  
  promotedOfferIds = new Set();  
  try {  
    const colRef = collection(db, "promoter_offers", promoterId, "offers");  
    const snap = await getDocs(colRef);  
    snap.docs.forEach(docSnap => {  
      promotedOfferIds.add(docSnap.id); // doc id is offer.id  
    });  
  } catch (err) {  
    console.error("Failed to load promoted offers:", err);  
  }  
}  

// Mark that this promoter chose to promote this offer (create doc with all fields)  
async function markOfferPromoted(promoterId, offer) {  
  try {  
    const ref = doc(db, "promoter_offers", promoterId, "offers", offer.id);  
    const now = new Date();  

    await setDoc(ref, {  
      offerId: offer.id,  
      promoterId: promoterId,  
      title: offer.title || 'Untitled Offer',  
      description: offer.description || '',  
      imageUrl: offer.imageUrl || '',  
      category: offer.category || '',  
      currency: offer.currency || '$',  
      price: offer.price || null,  
      commissionValue: offer.commissionValue || 0,  
      commissionType: offer.commissionType || 'flat',  
      status: offer.status || 'active',  

      // tracking-related fields initialised here  
      clicks: 0,  
      lastClickAt: null,  
      createdAt: now,  
      startedPromotingAt: now,  
      lastShareAt: now  
    }, { merge: true });  

    promotedOfferIds.add(offer.id);  
  } catch (err) {  
    console.error("Failed to mark offer as promoted:", err);  
    throw err;  
  }  
}  

// --- Auth & session safety ---  
let rawSession = localStorage.getItem('userSession');  
let existingSession = null;  
if (rawSession) {  
  try {  
    existingSession = JSON.parse(rawSession);  
  } catch (e) {  
    existingSession = null;  
    localStorage.removeItem('userSession');  
  }  
}  

onAuthStateChanged(auth, async (user) => {  
  if (!user || !user.emailVerified) {  
    localStorage.removeItem('userSession');  
    return window.location.href='login.html';  
  }  
    
  try {  
    const userDoc = await getDoc(doc(db, 'users', user.uid));  
    const adminDoc = await getDoc(doc(db, 'admins', user.uid));  
    let userData = null;  
    let role = null;  

    if (userDoc.exists()) {  
      userData = userDoc.data();  
      role = userData.role;  
    } else if (adminDoc.exists()) {  
      userData = adminDoc.data();  
      role = adminDoc.data().role || 'admin';  
    } else {  
      showNotification("User record not found.");  
      auth.signOut();  
      window.location.href='login.html';  
      return;  
    }  

    if (role !== 'freelancer') {  
      showNotification("Access denied: Not a promoter.");  
      auth.signOut();  
      window.location.href='login.html';  
      return;  
    }  

    const sessionData = {  
      uid: user.uid,  
      name: userData.name,  
      email: userData.email,  
      role: role,  
      referralCode: userData.referralCode || '',  
      phone: userData.phone || '',  
      country: userData.country || '',  
      createdAt: userData.createdAt || ''  
    };  

    localStorage.setItem('userSession', JSON.stringify(sessionData));  

    // Load promoted offers first so displayOffers knows which ones are already active  
    await loadPromotedOffers(user.uid);  
    loadOffers();  
  } catch(err) {  
    console.error(err);  
    showNotification("Error validating session.");  
  }  
});  

async function loadOffers() {  
  showSkeleton(3);  

  try {  
    const offersCol = collection(db, "offers_all");  
    const snapshot = await getDocs(offersCol);  
    allOffers = snapshot.docs  
      .map(docSnap => ({ id: docSnap.id, ...docSnap.data() }))  
      .filter(o => o.verified && o.status === 'active');  

    hideSkeleton();  
    populateCategories();  
    displayOffers(allOffers);  
  } catch(err) {  
    console.error(err);  
    hideSkeleton();  
    showNotification('Failed to load offers.');  
    offerGrid.innerHTML = `<div class="empty-state"><strong>Failed to load offers.</strong>Please check your internet connection and try again.</div>`;  
  }  
}  

function populateCategories() {  
  const categories = [...new Set(allOffers.map(o => o.category).filter(Boolean))];  
  categoryFilter.innerHTML = '<option value="">All Categories</option>' +  
    categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');  
}  

function displayOffers(offers) {  
  const sessionRaw = localStorage.getItem('userSession');  
  if (!sessionRaw) {  
    offerGrid.innerHTML = `<div class="empty-state"><strong>Session expired.</strong>Please log in again.</div>`;  
    return;  
  }  

  let session = null;  
  try {  
    session = JSON.parse(sessionRaw);  
  } catch (e) {  
    offerGrid.innerHTML = `<div class="empty-state"><strong>Session error.</strong>Please log in again.</div>`;  
    return;  
  }  

  offerGrid.innerHTML = "";  

  if (!offers.length) {  
    offerGrid.innerHTML = `  
      <div class="empty-state">  
        <strong>No offers for this filter.</strong>  
        Try clearing filters or check back later for new promotions.  
      </div>`;  
    return;  
  }  

  offers.forEach(offer => {  
    const image = offer.imageUrl || "https://via.placeholder.com/400x200?text=No+Image";  

    const fullDesc = offer.description || '';  
    const desc = fullDesc  
      ? (fullDesc.length > 100  
        ? fullDesc.substring(0, 100) + "..."  
        : fullDesc)  
      : '';  

    const link = `${window.location.origin}/track.html?offer=${offer.id}&promoter=${session.uid}`;  

    const isPromoted = promotedOfferIds.has(offer.id);  

    const card = document.createElement('div');  
    card.className='offer-card';  
    card.innerHTML = `  
      <img src="${image}" alt="Offer">  
      <div class="offer-title">${offer.title || 'Untitled Offer'}</div>  
      <div class="offer-desc">
        <span class="desc-short">${desc}</span>
        <span class="desc-full" style="display:none;">${fullDesc}</span>
        ${fullDesc && fullDesc.length > 100  
          ? '<button class="toggle-desc" style="margin-left:6px;background:none;border:none;color:var(--accent1);font-size:12px;cursor:pointer;padding:0;">See more</button>'  
          : ''}  
      </div>  
      <div class="offer-desc">üí∞ ${offer.currency || "$"} ${offer.price || "‚Äî"}</div>  
      <div class="offer-desc">üèÜ Commission: ${offer.commissionValue || 0}${offer.commissionType==="percentage"?"%":""}</div>  
      <div class="status active">${isPromoted ? 'Promoting' : offer.status}</div>  

      <!-- First step: choose to promote -->  
      <div class="actions promote-chooser" style="${isPromoted ? 'display:none;' : ''}">  
        <button class="btn start-promote"><span class="icon">üöÄ</span><span>Start Promoting</span></button>  
      </div>  

      <!-- Real tools: only visible once they promote -->  
      <div class="actions main-actions" style="${isPromoted ? 'display:flex;' : 'display:none;'}">  
        <button class="btn copy"><span class="icon">üîó</span><span>Copy Link</span></button>  
        <button class="btn copy-caption"><span class="icon">üìã</span><span>Copy Caption</span></button>  
        <button class="btn download"><span class="icon">üì∏</span><span>Download Image</span></button>  
        <button class="btn share"><span class="icon">üì§</span><span>Share</span></button>  
      </div>  
    `;  
    offerGrid.appendChild(card);  

    const promoteChooser = card.querySelector('.promote-chooser');  
    const mainActions = card.querySelector('.main-actions');  

    // "See more / See less" toggle for description  
    const toggleBtn = card.querySelector('.toggle-desc');  
    if (toggleBtn) {  
      const shortEl = card.querySelector('.desc-short');  
      const fullEl = card.querySelector('.desc-full');  

      toggleBtn.onclick = () => {  
        const expanded = fullEl.style.display === 'inline';  
        if (expanded) {  
          fullEl.style.display = 'none';  
          shortEl.style.display = 'inline';  
          toggleBtn.textContent = 'See more';  
        } else {  
          fullEl.style.display = 'inline';  
          shortEl.style.display = 'none';  
          toggleBtn.textContent = 'See less';  
        }  
      };  
    }  

    // Start promoting button ‚Äì creates the doc and reveals tools  
    const startPromoteBtn = card.querySelector('.start-promote');  
    if (startPromoteBtn) {  
      startPromoteBtn.onclick = async () => {  
        startPromoteBtn.disabled = true;  
        try {  
          await markOfferPromoted(session.uid, offer);  
          const statusEl = card.querySelector('.status');  
          if (statusEl) statusEl.textContent = 'Promoting';  
          if (promoteChooser) promoteChooser.style.display = 'none';  
          if (mainActions) mainActions.style.display = 'flex';  
          showNotification("üöÄ You're now promoting this offer!");  
        } catch (e) {  
          showNotification("‚ùå Failed to start promoting this offer.");  
          startPromoteBtn.disabled = false;  
        }  
      };  
    }  

    // Copy ONLY the tracking link  
    const copyLinkBtn = card.querySelector('.btn.copy');  
    if (copyLinkBtn) {  
      copyLinkBtn.onclick = () => {  
        navigator.clipboard.writeText(link)  
          .then(() => showNotification("‚úÖ Promotion link copied!"))  
          .catch(() => showNotification("‚ùå Failed to copy link."));  
      };  
    }  

    // Copy full caption: title + full description + link  
    const copyCaptionBtn = card.querySelector('.btn.copy-caption');  
    if (copyCaptionBtn) {  
      copyCaptionBtn.onclick = () => {  
        const caption = `${offer.title || 'Untitled Offer'}\n\n${offer.description || ''}\n\nPromo link: ${link}`;  
        navigator.clipboard.writeText(caption)  
          .then(() => showNotification("üìã Caption copied! Paste it into your post."))  
          .catch(() => showNotification("‚ùå Failed to copy caption."));  
      };  
    }  

    // Download image  
    const downloadBtn = card.querySelector('.btn.download');  
    if (downloadBtn) {  
      downloadBtn.onclick = async () => {  
        try {  
          const res = await fetch(image);  
          const blob = await res.blob();  
          const url = window.URL.createObjectURL(blob);  
          const a = document.createElement("a");  
          a.href = url;  
          a.download = `${(offer.title || "offer").replace(/\s+/g,"_")}.jpg`;  
          document.body.appendChild(a);  
          a.click();  
          a.remove();  
          window.URL.revokeObjectURL(url);  
          showNotification("üì∏ Image downloaded!");  
        } catch {  
          showNotification("‚ùå Failed to download image.");  
        }  
      };  
    }  

    // Share: descriptions + link + image when supported  
    const shareBtn = card.querySelector('.btn.share');  
    if (shareBtn) {  
      shareBtn.onclick = async () => {  
        const shareText = `${offer.title || 'Untitled Offer'}\n\n${offer.description || ''}\n\nPromo link: ${link}`;  

        // Try sharing with image (Web Share API Level 2)  
        try {  
          const response = await fetch(image);  
          const blob = await response.blob();  
          const file = new File([blob], `${(offer.title || "offer").replace(/\s+/g,"_")}.jpg`, { type: blob.type });  

          if (navigator.canShare && navigator.canShare({ files: [file] })) {  
            await navigator.share({  
              title: offer.title,  
              text: shareText,  
              files: [file]  
            });  
            showNotification("üì§ Offer shared with image!");  
            return;  
          }  
        } catch (err) {  
          console.warn("Image share not supported or failed:", err);  
        }  

        // Fallback: share text + link only  
        if (navigator.share) {  
          try {  
            await navigator.share({  
              title: offer.title,  
              text: shareText,  
              url: link  
            });  
            showNotification("üì§ Shared (image not supported on this device).");  
            return;  
          } catch (err) {  
            console.error("Share failed:", err);  
          }  
        }  

        // Last fallback: copy full promo text  
        navigator.clipboard.writeText(shareText)  
          .then(() => showNotification("üîó Full promo copied (share not supported)."))  
          .catch(() => showNotification("‚ùå Failed to copy promo."));  
      };  
    }  
  });  
}  

function applyFilters() {  
  const cat = categoryFilter.value;  
  const search = searchInput.value.toLowerCase();  
  const filtered = allOffers.filter(o => {  
    const matchesCat = !cat || o.category === cat;  
    const title = (o.title || "").toLowerCase();  
    const desc = (o.description || "").toLowerCase();  
    const matchesSearch = title.includes(search) || desc.includes(search);  
    return matchesCat && matchesSearch;  
  });  
  displayOffers(filtered);  
}  

categoryFilter.addEventListener('change', applyFilters);  
searchInput.addEventListener('input', applyFilters);  
clearFiltersBtn.addEventListener('click', ()=>{  
  categoryFilter.value='';  
  searchInput.value='';  
  applyFilters();  
});  
</script>  
</body>  
</html>
