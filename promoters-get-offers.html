<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EarnLibr ‚Äî Promoters Get Offers</title>
<style>
:root {
  --bg: #090c14;
  --card: rgba(20, 25, 38, 0.85);
  --accent1: #4a90e2;
  --accent2: #a3ff6e;
  --muted: #9ca3af;
  --radius: 14px;
  --text: #e5e7eb;
}
body {
  margin: 0;
  font-family: "Inter", system-ui, Arial;
  background: radial-gradient(circle at top, #0d111c 0%, #090c14 80%);
  color: var(--text);
  min-height: 100vh;
  padding: 30px 20px;
}
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
}
h1 {
  font-size: 26px;
  background: linear-gradient(90deg, var(--accent1), var(--accent2));
  -webkit-background-clip: text;
  color: transparent;
  font-weight: 700;
}
.profile-btn {
  background: transparent;
  color: var(--text);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: var(--radius);
  padding: 8px 14px;
  cursor: pointer;
  transition: all 0.2s;
}
.profile-btn:hover { background: rgba(255, 255, 255, 0.1); }
.filter-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: center;
  margin-bottom: 25px;
  background: rgba(255, 255, 255, 0.05);
  padding: 12px 16px;
  border-radius: var(--radius);
  backdrop-filter: blur(10px);
}
.filter-bar select,
.filter-bar input {
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.1);
  color: var(--text);
  border-radius: 8px;
  padding: 8px 10px;
  font-size: 14px;
  outline: none;
}
.filter-bar select:focus,
.filter-bar input:focus { border-color: var(--accent1); }
.filter-bar button {
  background: linear-gradient(90deg, var(--accent1), var(--accent2));
  border: none;
  border-radius: 8px;
  padding: 8px 12px;
  cursor: pointer;
  color: #0b0f14;
  font-weight: 600;
  transition: 0.2s;
}
.filter-bar button:hover { opacity: 0.9; }

.offer-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  gap: 24px;
  transition: opacity 0.3s;
}
.offer-card {
  backdrop-filter: blur(14px);
  background: var(--card);
  border-radius: var(--radius);
  padding: 16px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
  transition: transform 0.25s, box-shadow 0.25s;
  border: 1px solid rgba(255, 255, 255, 0.05);
  overflow: hidden;
}
.offer-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 6px 18px rgba(74, 144, 226, 0.25);
}
.offer-card img {
  width: 100%;
  height: 200px;
  object-fit: cover;
  border-radius: 10px;
  margin-bottom: 12px;
}
.offer-title { font-weight: 600; font-size: 18px; color: #fff; margin-bottom: 8px; }
.offer-desc { font-size: 14px; color: var(--muted); margin: 4px 0; }
.status {
  display: inline-block;
  padding: 5px 12px;
  border-radius: 8px;
  font-size: 13px;
  margin-top: 8px;
  font-weight: 600;
  text-transform: capitalize;
}
.status.active { background: rgba(34, 197, 94, 0.15); color: #4ade80; }
.actions { margin-top: 16px; display: flex; flex-wrap: wrap; gap: 8px; }
.btn { flex: 1; border: none; border-radius: 8px; padding: 10px; font-size: 14px; cursor: pointer; color: #fff; font-weight: 500; transition: all 0.2s ease; }
.btn.copy { background: var(--accent1); }
.btn.download { background: #6366f1; }
.btn.track { background: linear-gradient(90deg, var(--accent2), #5cf060); color: #0a0f12; font-weight: 600; }
.btn:hover { opacity: 0.9; }

.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 14px 22px;
  border-radius: 10px;
  background: linear-gradient(90deg, var(--accent1), var(--accent2));
  color: #fff;
  font-weight: 600;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
  opacity: 0;
  transform: translateY(-10px);
  transition: opacity 0.3s, transform 0.3s;
  z-index: 9999;
}
.notification.show { opacity: 1; transform: translateY(0); }
</style>
</head>
<body>
<header>
  <h1>üéØ Promoter Offers</h1>
  <button class="profile-btn" onclick="window.location.href='promoter-dashboard.html'">My Dashboard</button>
</header>

<div class="filter-bar">
  <select id="categoryFilter"><option value="">All Categories</option></select>
  <input type="text" id="searchInput" placeholder="Search offers..." />
  <button id="clearFilters">Clear Filters</button>
</div>

<div id="offerGrid" class="offer-grid"></div>
<div id="notification" class="notification"></div>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { collection, getDocs, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const offerGrid = document.getElementById('offerGrid');
const notification = document.getElementById('notification');
const categoryFilter = document.getElementById('categoryFilter');
const searchInput = document.getElementById('searchInput');
const clearFiltersBtn = document.getElementById('clearFilters');
let allOffers = [];

function showNotification(message) {
  notification.textContent = message;
  notification.classList.add('show');
  setTimeout(() => notification.classList.remove('show'), 2500);
}

onAuthStateChanged(auth, async (user) => {
  if (!user) return window.location.href='login.html';
  if (!user.emailVerified) return window.location.href='login.html';

  try {
    const sessionRaw = localStorage.getItem('userSession');
    const session = sessionRaw ? JSON.parse(sessionRaw) : null;
    if (!session || session.role !== 'freelancer') return window.location.href='login.html';
    loadOffers(session.uid);
  } catch(err) { console.error(err); showNotification('Error verifying session.'); }
});

async function loadOffers(promoterId) {
  const offersCol = collection(db, 'offers');
  onSnapshot(offersCol, async snapshot => {
    allOffers = [];
    offerGrid.innerHTML = '';
    for (const providerDoc of snapshot.docs) {
      const providerId = providerDoc.id;
      const providerOffersCol = collection(db, 'offers', providerId, 'offers');
      const offersSnap = await getDocs(providerOffersCol);
      offersSnap.forEach(offerDoc => {
        const offer = offerDoc.data();
        if (!offer.verified || offer.status !== 'active') return;
        allOffers.push({...offer, id: offerDoc.id});
      });
    }
    populateCategories();
    displayOffers(allOffers, promoterId);
  });
}

function populateCategories() {
  const categories = [...new Set(allOffers.map(o => o.category).filter(Boolean))];
  categoryFilter.innerHTML = '<option value="">All Categories</option>' +
    categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
}

function displayOffers(offers, promoterId) {
  offerGrid.innerHTML = "";
  if (!offers.length) {
    offerGrid.innerHTML = "<div style='text-align:center;opacity:0.6;padding-top:30px;'>No offers available for this filter.</div>";
    return;
  }

  offers.forEach(offer => {
    const image = offer.imageUrl || "https://via.placeholder.com/400x200?text=No+Image";
    const desc = offer.description ? offer.description.substring(0,100)+"..." : '';
    const link = `${window.location.origin}/Earnlibr-/track.html?offer=${offer.id}&promoter=${promoterId}`;

    const card = document.createElement('div');
    card.className='offer-card';
    card.innerHTML = `
      <img src="${image}" alt="Offer">
      <div class="offer-title">${offer.title}</div>
      <div class="offer-desc">${desc}</div>
      <div class="offer-desc">üí∞ ${offer.currency || "$"} ${offer.price || "‚Äî"}</div>
      <div class="offer-desc">üèÜ Commission: ${offer.commissionValue || 0}${offer.commissionType==="percentage"?"%":""}</div>
      <div class="status active">${offer.status}</div>
      <div class="actions">
        <button class="btn copy">Copy Link</button>
        <button class="btn download">Download Image</button>
        <button class="btn track">Track Stats</button>
      </div>
    `;
    offerGrid.appendChild(card);

    card.querySelector('.btn.copy').onclick = () => {
      navigator.clipboard.writeText(link).then(()=>showNotification("‚úÖ Promotion link copied!"))
      .catch(()=>showNotification("‚ùå Failed to copy link."));
    };

    card.querySelector('.btn.download').onclick = async () => {
      try {
        const res = await fetch(image);
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${offer.title.replace(/\s+/g,"_")}.jpg`;
        document.body.appendChild(a); a.click(); a.remove(); window.URL.revokeObjectURL(url);
        showNotification("üì∏ Image downloaded!");
      } catch { showNotification("‚ùå Failed to download image."); }
    };

    card.querySelector('.btn.track').onclick = () => {
      window.location.href=`my-promotions.html#${offer.id}`;
    };
  });
}

// --- Filters ---
function applyFilters() {
  const cat = categoryFilter.value;
  const search = searchInput.value.toLowerCase();
  const session = JSON.parse(localStorage.getItem('userSession'));
  const filtered = allOffers.filter(o=>{
    const matchesCat = !cat || o.category===cat;
    const matchesSearch = o.title.toLowerCase().includes(search) || (o.description && o.description.toLowerCase().includes(search));
    return matchesCat && matchesSearch;
  });
  displayOffers(filtered, session.uid);
}
categoryFilter.addEventListener('change', applyFilters);
searchInput.addEventListener('input', applyFilters);
clearFiltersBtn.addEventListener('click', ()=>{ categoryFilter.value=''; searchInput.value=''; applyFilters(); });

</script>
</body>
</html>
