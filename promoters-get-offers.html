<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>EarnLibr — Promoters Get Offers</title>
<style>
:root {
  --bg: #0b0d17;
  --card: #0f1724;
  --accent1: #4a90e2;
  --accent2: #a3ff6e;
  --muted: #bfc7d6;
  --radius: 12px;
}
html, body { height:100%; margin:0; font-family:Inter,system-ui,Arial; background: linear-gradient(180deg, #071028 0%, #0b0d17 100%); color: #eef2f7; }
.wrap { max-width: 1200px; margin: 28px auto; padding: 20px; display: grid; grid-template-columns: 260px 1fr; gap: 20px; }
.card { background: linear-gradient(180deg, var(--card), #0d1221); border-radius: var(--radius); padding: 18px; box-shadow: 0 8px 30px rgba(2,6,23,0.6); border:1px solid rgba(255,255,255,0.03); overflow:hidden; }
.sidebar { height: calc(100vh - 80px); display:flex; flex-direction:column; gap:14px; position:sticky; top:20px; }
.logo img { width:44px; height:44px; border-radius:8px; object-fit:cover; }
.nav { margin-top:12px; display:flex; flex-direction:column; gap:8px; }
.nav a { display:block; padding:10px 12px; border-radius:10px; text-decoration:none; color:var(--muted); font-weight:600; cursor:pointer; }
.nav a.active, .nav a:hover { color:#041018; background: linear-gradient(90deg, var(--accent1), var(--accent2)); }
.offer-card { background: var(--card); border-radius:10px; padding:12px; margin-bottom:12px; display:flex; flex-direction:column; gap:8px; border:1px solid rgba(255,255,255,0.05); }
.offer-card img { width:100%; max-height:150px; object-fit:cover; border-radius:8px; }
.offer-card h3 { margin:0; font-size:16px; background:linear-gradient(90deg, var(--accent1), var(--accent2)); -webkit-background-clip:text; color:transparent; }
.offer-card button { padding:8px 10px; border:none; border-radius:8px; cursor:pointer; background:linear-gradient(90deg, var(--accent1), var(--accent2)); color:#041018; font-weight:600; }
#offersContainer { display:flex; flex-direction:column; }

/* Debug panel */
#debugPanel {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  max-height: 200px;
  overflow-y: auto;
  background: rgba(0,0,0,0.85);
  color: #fff;
  font-family: monospace;
  font-size: 12px;
  padding: 8px;
  z-index: 9999;
}
</style>
</head>
<body>
<div class="wrap">
  <aside class="card sidebar">
    <div class="logo"><img src="https://raw.githubusercontent.com/Carrew/Earnlibr-/refs/heads/main/1000115452-01.jpeg" alt="logo"><h2>EarnLibr</h2></div>
    <nav class="nav">
      <a id="nav-dashboard">Dashboard</a>
      <a id="nav-get-offers" class="active">Get Offers</a>
      <a id="nav-notifs">Notifications</a>
    </nav>
    <div class="profile">
      <div id="avatar" class="avatar">PR</div>
      <div>
        <div id="promoterName" style="font-weight:700;">Loading...</div>
        <div id="promoterEmail" class="muted">—</div>
      </div>
      <div style="margin-left:auto"><button id="logoutBtn">Logout</button></div>
    </div>
  </aside>

  <main class="main card">
    <h1>Available Offers</h1>
    <div id="offersContainer">Loading offers...</div>
  </main>
</div>

<div id="debugPanel"></div>

<script type="module">
import { auth, db } from "./firebase.js";
import { collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

const promoterNameEl = document.getElementById('promoterName');
const promoterEmailEl = document.getElementById('promoterEmail');
const avatarEl = document.getElementById('avatar');
const offersContainer = document.getElementById('offersContainer');
const logoutBtn = document.getElementById('logoutBtn');
const debugPanel = document.getElementById('debugPanel');

function debugLog(label, value) {
  debugPanel.innerHTML += `<div><strong>${label}:</strong> ${JSON.stringify(value)}</div>`;
}

// Load session (but don't redirect yet)
let userSession = null;
try {
  const raw = localStorage.getItem('userSession');
  if (!raw) throw new Error('No session in localStorage');
  userSession = JSON.parse(raw);
  debugLog('Parsed userSession', userSession);
} catch(e) {
  debugLog('Session error', e.message);
}

// Firebase auth check
onAuthStateChanged(auth, user => {
  debugLog('Firebase user', user);

  if (!user) {
    debugLog('Redirecting: no Firebase user');
    localStorage.removeItem('userSession');
    window.location.href='login.html';
    return;
  }

  if (!userSession) {
    debugLog('Redirecting: missing session after Firebase auth');
    localStorage.removeItem('userSession');
    window.location.href='login.html';
    return;
  }

  if (user.uid !== userSession.uid) {
    debugLog('Redirecting: UID mismatch');
    localStorage.removeItem('userSession');
    window.location.href='login.html';
    return;
  }

  if (userSession.role !== 'promoter') {
    debugLog(`Redirecting: unauthorized role (${userSession.role})`);
    localStorage.removeItem('userSession');
    window.location.href='login.html';
    return;
  }

  if (!user.emailVerified) {
    debugLog('Redirecting: email not verified');
    localStorage.removeItem('userSession');
    window.location.href='login.html';
    return;
  }

  debugLog('Auth verified: loading page');
  promoterNameEl.textContent = userSession.name || 'Promoter';
  promoterEmailEl.textContent = userSession.email || '';
  avatarEl.textContent = (userSession.name || 'PR').charAt(0).toUpperCase();
  attachHandlers();
  loadOffers();
});

function attachHandlers() {
  document.getElementById('nav-dashboard').onclick = () => window.location.href='promoter-dashboard.html';
  document.getElementById('nav-notifs').onclick = () => window.location.href='notifications.html';
  logoutBtn.onclick = async () => {
    try { await signOut(auth); } catch(e){}
    localStorage.removeItem('userSession');
    window.location.href='login.html';
  };
}

async function loadOffers() {
  offersContainer.innerHTML = "Loading offers...";
  try {
    const q = query(collection(db, "offers_pending"), where("status", "==", "active"));
    const querySnapshot = await getDocs(q);

    offersContainer.innerHTML = "";
    if(querySnapshot.empty) {
      offersContainer.textContent = "No offers available at the moment.";
      return;
    }

    querySnapshot.forEach(doc => {
      const offer = doc.data();
      const offerId = doc.id;

      const card = document.createElement('div');
      card.className = "offer-card";

      card.innerHTML = `
        ${offer.imageTemp ? `<img src="${offer.imageTemp}" alt="Offer Image">` : ""}
        <h3>${offer.title}</h3>
        <p>${offer.description}</p>
        <p>Price: ${offer.price} ${offer.currency}</p>
        <p>Commission: ${offer.commissionValue} ${offer.commissionType}</p>
        <button>Copy Referral Link</button>
      `;

      const button = card.querySelector("button");
      button.onclick = () => {
        const referralLink = `${window.location.origin}/offer-landing.html?offerId=${offerId}&promoterId=${userSession.uid}`;
        navigator.clipboard.writeText(referralLink).then(() => {
          button.textContent = "Link Copied!";
          setTimeout(() => button.textContent = "Copy Referral Link", 2000);
        });
      };

      offersContainer.appendChild(card);
    });
  } catch(err) {
    console.error("Error loading offers:", err);
    offersContainer.textContent = "Failed to load offers.";
    debugLog('Error loading offers', err);
  }
}
</script>
</body>
</html>
