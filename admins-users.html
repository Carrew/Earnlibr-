<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EarnLibr — Admin Users</title>

<style>
:root{
  --bg:#0b0d17; --card:#0f1724; --accent1:#4a90e2; --accent2:#a3ff6e;
  --muted:#94a3b8; --danger:#ef4444; --radius:14px;
}
body{
  margin:0; font-family:Inter,system-ui,Arial;
  background:linear-gradient(180deg,#071028 0%, #0b0d17 100%);
  color:#eef2f7; min-height:100vh;
}
header{
  background:var(--card);
  border-bottom:1px solid #1a2235;
  padding:16px 18px;
  display:flex; align-items:center; justify-content:space-between; gap:12px;
}
header .title{
  font-weight:800; font-size:16px;
  background:linear-gradient(90deg,var(--accent1),var(--accent2));
  -webkit-background-clip:text; color:transparent;
}
header .right{
  display:flex; gap:10px; align-items:center; color:var(--muted); font-size:13px;
}
button{
  border:0; cursor:pointer;
  border-radius:10px; padding:10px 12px;
  font-weight:700;
}
.btn{
  background:linear-gradient(90deg,var(--accent1),var(--accent2));
  color:#041018;
}
.btn-ghost{
  background:transparent;
  border:1px solid rgba(148,163,184,0.35);
  color:#cbd5e1;
}
.wrap{
  padding:18px;
  max-width:1200px;
  margin:0 auto;
}
.grid{
  display:grid;
  grid-template-columns: 1.15fr 0.85fr;
  gap:14px;
}
@media(max-width:900px){
  .grid{ grid-template-columns: 1fr; }
}
.card{
  background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.015));
  border:1px solid rgba(255,255,255,0.04);
  border-radius:var(--radius);
  box-shadow:0 8px 30px rgba(2,6,23,0.45);
  overflow:hidden;
}
.card-h{
  padding:14px 14px 10px;
  border-bottom:1px solid rgba(255,255,255,0.04);
  display:flex; align-items:center; justify-content:space-between; gap:10px;
}
.card-h h2{
  margin:0; font-size:14px; color:#e5e7eb;
}
.kpis{
  display:grid;
  grid-template-columns: repeat(4, minmax(0,1fr));
  gap:10px;
  padding:14px;
}
@media(max-width:700px){
  .kpis{ grid-template-columns: repeat(2, minmax(0,1fr)); }
}
.kpi{
  background:rgba(255,255,255,0.02);
  border:1px solid rgba(255,255,255,0.04);
  border-radius:12px;
  padding:12px;
}
.kpi .label{ color:var(--muted); font-size:12px; }
.kpi .val{ font-size:20px; font-weight:800; margin-top:6px; }

.tools{
  display:flex; gap:8px; flex-wrap:wrap;
  padding:14px;
  border-bottom:1px solid rgba(255,255,255,0.04);
}
input, select{
  padding:10px 12px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.07);
  background:#071427;
  color:#fff;
  outline:none;
  font-size:13px;
}
input{ flex:1; min-width:180px; }
select{ min-width:160px; }

.list{
  max-height: 65vh;
  overflow:auto;
}
.user{
  padding:12px 14px;
  border-bottom:1px solid rgba(255,255,255,0.04);
  cursor:pointer;
  display:flex; justify-content:space-between; gap:10px;
}
.user:hover{ background:rgba(74,144,226,0.06); }
.user .name{ font-weight:700; font-size:13px; }
.user .meta{ color:var(--muted); font-size:12px; margin-top:4px; }
.badges{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
.badge{
  font-size:11px; padding:4px 8px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.12);
  color:#cbd5e1;
}
.badge.green{ border-color:rgba(163,255,110,0.4); color:var(--accent2); }
.badge.blue{ border-color:rgba(74,144,226,0.5); color:#9fd0ff; }
.badge.red{ border-color:rgba(239,68,68,0.6); color:#ffb4b4; }

.detail{
  padding:14px;
}
.row{
  display:flex; justify-content:space-between; gap:10px;
  padding:8px 0;
  border-bottom:1px dashed rgba(255,255,255,0.06);
  font-size:13px;
}
.row .k{ color:var(--muted); }
.row .v{ color:#e5e7eb; text-align:right; max-width:65%; word-break:break-word; }
.actions{
  display:flex; gap:8px; flex-wrap:wrap;
  margin-top:12px;
}
.toast{
  position:fixed; bottom:18px; right:18px;
  display:none;
  background:#0f1724;
  border:1px solid rgba(255,255,255,0.08);
  color:#fff;
  padding:10px 12px;
  border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,0.5);
  font-size:13px;
  max-width:320px;
}
.small{
  color:var(--muted);
  font-size:12px;
}
</style>
</head>

<body>
<header>
  <div class="title">EarnLibr Admin — Users</div>
  <div class="right">
    <span id="adminEmail" class="small"></span>
    <button class="btn-ghost" id="logoutBtn">Logout</button>
  </div>
</header>

<div class="wrap">
  <div class="card" style="margin-bottom:14px;">
    <div class="card-h">
      <h2>Overview</h2>
      <div class="small" id="lastUpdated">Loading…</div>
    </div>
    <div class="kpis">
      <div class="kpi"><div class="label">Total users</div><div class="val" id="kpiTotal">—</div></div>
      <div class="kpi"><div class="label">Providers</div><div class="val" id="kpiProviders">—</div></div>
      <div class="kpi"><div class="label">Affiliates</div><div class="val" id="kpiAffiliates">—</div></div>
      <div class="kpi"><div class="label">Signups (7 days)</div><div class="val" id="kpi7d">—</div></div>
    </div>
    <div style="padding:0 14px 14px;">
      <div class="small">Tip: for scalable analytics later, we’ll add an <b>admin_stats</b> doc updated by Cloud Functions.</div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="card-h">
        <h2>Users</h2>
        <div class="small" id="usersCount">—</div>
      </div>

      <div class="tools">
        <input id="search" placeholder="Search by name, email, phone…" />
        <select id="roleFilter">
          <option value="all">All roles</option>
          <option value="provider">Providers</option>
          <option value="freelancer">Affiliates</option>
        </select>
        <select id="statusFilter">
          <option value="all">All statuses</option>
          <option value="active">Active</option>
          <option value="disabled">Disabled</option>
        </select>
        <button class="btn-ghost" id="refreshBtn">Refresh</button>
      </div>

      <div class="list" id="userList">
        <div style="padding:14px; color:var(--muted);">Loading users…</div>
      </div>
    </div>

    <div class="card">
      <div class="card-h">
        <h2>User details</h2>
        <div class="small" id="detailHint">Select a user</div>
      </div>
      <div class="detail" id="detailBox">
        <div class="small">Click a user from the list to view full info.</div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import {
  collection, getDocs, doc, getDoc, updateDoc, serverTimestamp,
  query, orderBy
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const $ = (id) => document.getElementById(id);

const toast = (text) => {
  const t = $("toast");
  t.textContent = text;
  t.style.display = "block";
  clearTimeout(window.__t);
  window.__t = setTimeout(() => t.style.display = "none", 2600);
};

$("logoutBtn").onclick = async () => {
  await signOut(auth);
  location.href = "login.html";
};

let users = [];
let selectedUser = null;

function toDate(ts){
  try{
    if(!ts) return null;
    if(ts.seconds) return new Date(ts.seconds * 1000);
    return new Date(ts);
  }catch{return null;}
}
function fmtDate(ts){
  const d = toDate(ts);
  if(!d) return "";
  return d.toLocaleString();
}
function daysAgo(n){
  const d = new Date();
  d.setDate(d.getDate() - n);
  return d;
}

/**
 * ✅ ADMIN GUARD (admins collection ONLY)
 * - Must exist in `admins/{uid}`
 * - role must be "admin" or "super_admin" (or isAdmin === true)
 */
async function getAdminProfile(uid){
  const adminSnap = await getDoc(doc(db, "admins", uid));
  if(!adminSnap.exists()) return null;

  const data = adminSnap.data();
  const role = data.role || "admin";
  const ok = role === "admin" || role === "super_admin" || data.isAdmin === true;
  if(!ok) return null;

  return { ...data, uid, role };
}

function deny(message){
  document.body.innerHTML = `
    <div style="padding:20px;color:#ef4444;font-family:Arial">
      ${message}
    </div>
  `;
}

function renderKPIs(list){
  const total = list.length;
  const providers = list.filter(u => u.role === "provider").length;
  const affiliates = list.filter(u => u.role === "freelancer").length;

  const sevenDays = daysAgo(7);
  const signups7d = list.filter(u => {
    const d = toDate(u.createdAt);
    return d && d >= sevenDays;
  }).length;

  $("kpiTotal").textContent = total;
  $("kpiProviders").textContent = providers;
  $("kpiAffiliates").textContent = affiliates;
  $("kpi7d").textContent = signups7d;

  $("lastUpdated").textContent = "Updated: " + new Date().toLocaleString();
}

function badgeFor(user){
  const badges = [];
  badges.push(user.role === "provider"
    ? `<span class="badge green">Provider</span>`
    : `<span class="badge blue">Affiliate</span>`);

  if(user.disabled) badges.push(`<span class="badge red">Disabled</span>`);
  return badges.join("");
}

function renderList(list){
  const box = $("userList");
  box.innerHTML = "";

  if(!list.length){
    box.innerHTML = `<div style="padding:14px;color:var(--muted);">No users found.</div>`;
    $("usersCount").textContent = "0";
    return;
  }

  $("usersCount").textContent = list.length + " shown";

  list.forEach(u => {
    const div = document.createElement("div");
    div.className = "user";
    div.onclick = () => selectUser(u.uid);

    div.innerHTML = `
      <div>
        <div class="name">${u.name || "Unnamed"}</div>
        <div class="meta">${u.email || ""}${u.phone ? " • " + u.phone : ""}</div>
      </div>
      <div class="badges">${badgeFor(u)}</div>
    `;
    box.appendChild(div);
  });
}

function renderDetail(u){
  $("detailHint").textContent = u ? "Selected" : "Select a user";
  const box = $("detailBox");
  if(!u){
    box.innerHTML = `<div class="small">Click a user from the list.</div>`;
    return;
  }

  box.innerHTML = `
    <div class="row"><div class="k">Name</div><div class="v">${u.name || ""}</div></div>
    <div class="row"><div class="k">Email</div><div class="v">${u.email || ""}</div></div>
    <div class="row"><div class="k">Phone</div><div class="v">${u.phone || ""}</div></div>
    <div class="row"><div class="k">Country</div><div class="v">${u.country || ""}</div></div>
    <div class="row"><div class="k">Role</div><div class="v">${u.role || ""}</div></div>
    <div class="row"><div class="k">Referral code</div><div class="v">${u.referralCode || ""}</div></div>
    <div class="row"><div class="k">Referred by</div><div class="v">${u.referredBy || "—"}</div></div>
    <div class="row"><div class="k">Created</div><div class="v">${fmtDate(u.createdAt) || "—"}</div></div>
    <div class="row"><div class="k">Updated</div><div class="v">${fmtDate(u.updatedAt) || "—"}</div></div>
    <div class="row"><div class="k">Disabled</div><div class="v">${u.disabled ? "Yes" : "No"}</div></div>

    <div class="actions">
      <button class="btn" id="toggleDisableBtn">${u.disabled ? "Enable user" : "Disable user"}</button>
      <button class="btn-ghost" id="makeProviderBtn">Set as Provider</button>
      <button class="btn-ghost" id="makeAffiliateBtn">Set as Affiliate</button>
    </div>

    <div class="small" style="margin-top:10px;">
      Note: Admin actions here write to Firestore. Protect this page with Firestore rules.
    </div>
  `;

  $("toggleDisableBtn").onclick = async () => {
    try{
      await updateDoc(doc(db,"users",u.uid), { disabled: !u.disabled });
      toast(u.disabled ? "User enabled" : "User disabled");
      await refresh();
      selectUser(u.uid);
    }catch(e){
      console.error(e);
      toast("Action failed (check rules).");
    }
  };

  $("makeProviderBtn").onclick = async () => {
    try{
      await updateDoc(doc(db,"users",u.uid), { role: "provider" });
      toast("Role updated: Provider");
      await refresh();
      selectUser(u.uid);
    }catch(e){
      console.error(e);
      toast("Action failed (check rules).");
    }
  };

  $("makeAffiliateBtn").onclick = async () => {
    try{
      await updateDoc(doc(db,"users",u.uid), { role: "freelancer" });
      toast("Role updated: Affiliate");
      await refresh();
      selectUser(u.uid);
    }catch(e){
      console.error(e);
      toast("Action failed (check rules).");
    }
  };
}

function applyFilters(){
  const term = $("search").value.trim().toLowerCase();
  const role = $("roleFilter").value;
  const status = $("statusFilter").value;

  let list = [...users];

  if(role !== "all") list = list.filter(u => u.role === role);
  if(status !== "all"){
    list = list.filter(u => status === "disabled" ? !!u.disabled : !u.disabled);
  }

  if(term){
    list = list.filter(u => {
      const hay = `${u.name||""} ${u.email||""} ${u.phone||""}`.toLowerCase();
      return hay.includes(term);
    });
  }

  renderKPIs(users);
  renderList(list);
}

async function selectUser(uid){
  selectedUser = users.find(u => u.uid === uid) || null;
  renderDetail(selectedUser);
}

async function refresh(){
  const snap = await getDocs(query(collection(db,"users"), orderBy("createdAt","desc")));
  users = snap.docs.map(d => d.data());
  applyFilters();
}

$("search").addEventListener("input", applyFilters);
$("roleFilter").addEventListener("change", applyFilters);
$("statusFilter").addEventListener("change", applyFilters);
$("refreshBtn").onclick = refresh;

onAuthStateChanged(auth, async (user) => {
  if(!user){
    location.href = "login.html";
    return;
  }

  // ✅ Same behavior as your login page
  if(!user.emailVerified){
    await signOut(auth);
    location.href = "login.html";
    return;
  }

  $("adminEmail").textContent = user.email || "";

  // ✅ Admin must exist in `admins/{uid}` ONLY
  const adminProfile = await getAdminProfile(user.uid);
  if(!adminProfile){
    deny("Access denied. Admins only.");
    return;
  }

  // ✅ Optional: update lastLoginAt for admin (admins collection)
  try{
    await updateDoc(doc(db, "admins", user.uid), { lastLoginAt: serverTimestamp() });
  }catch(e){
    console.warn("Could not update lastLoginAt (rules?)", e);
  }

  await refresh();
  toast(`Welcome, ${adminProfile.role}!`);
});
</script>
</body>
</html>
