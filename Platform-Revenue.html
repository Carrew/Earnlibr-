<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EarnLibr â€” Pro Revenue Analytics</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #0b0d17; color: #eef2f7; margin:0; padding:20px; }
    h1 { background: linear-gradient(90deg, #4a90e2, #a3ff6e); -webkit-background-clip: text; color: transparent; margin-bottom:20px; }
    
    .overview-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: #0f1724; border-radius: 12px; padding: 20px; text-align: center; border: 1px solid #1a2235; }
    .stat-card span { display: block; font-size: 24px; font-weight: bold; color: #a3ff6e; margin-top: 5px; }

    .chart-container { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px; }
    .chart-box { background: #0f1724; border-radius: 12px; padding: 15px; flex: 1 1 45%; min-width: 300px; border: 1px solid #1a2235; }

    .currency-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
    .detail-card { background: #0f1724; border-radius: 12px; padding: 20px; border-top: 4px solid #4a90e2; }
    .table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
    .table th { text-align: left; color: #8892b0; padding-bottom: 8px; }
    .table td { padding: 8px 0; border-bottom: 1px solid #1a2235; }
    
    .notif { position: fixed; top: 20px; right: 20px; padding: 15px; border-radius: 8px; display: none; z-index: 1000; }
    .success { background: #4ade80; color: #041018; }
</style>
</head>
<body>

<h1>Revenue Intelligence Dashboard</h1>

<div class="overview-grid" id="statsGrid">
    <div class="stat-card">Total Deals<span id="totalDeals">0</span></div>
    </div>

<div class="chart-container">
    <div class="chart-box">
        <h3 style="margin-top:0">Revenue Trend (All Currencies)</h3>
        <canvas id="revenueLineChart"></canvas>
    </div>
    <div class="chart-box">
        <h3 style="margin-top:0">Market Share</h3>
        <canvas id="sharePieChart"></canvas>
    </div>
</div>

<h2 style="color: #4a90e2;">Detailed Audit Logs</h2>
<div class="currency-grid" id="detailsGrid"></div>

<script type="module">
import { db } from './firebase.js';
import { collection, onSnapshot } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

let revenueLineChart, sharePieChart;

onSnapshot(collection(db, "platform-earnings"), (snapshot) => {
    const allData = [];
    snapshot.forEach(doc => allData.push({ id: doc.id, ...doc.data() }));
    
    renderStats(allData);
    renderCharts(allData);
    renderDetails(allData);
});

// 1. Render Top Stat Cards (Separated by Currency)
function renderStats(data) {
    const statsGrid = document.getElementById("statsGrid");
    const totalDeals = data.reduce((sum, c) => sum + (c.dealsCount || 0), 0);
    
    let html = `<div class="stat-card">Total Deals<span>${totalDeals}</span></div>`;
    data.forEach(c => {
        html += `<div class="stat-card">${c.id} Revenue<span>${c.totalRevenue.toLocaleString()}</span></div>`;
    });
    statsGrid.innerHTML = html;
}

// 2. Render Detailed Tables
function renderDetails(data) {
    const grid = document.getElementById("detailsGrid");
    grid.innerHTML = "";

    data.forEach(c => {
        const div = document.createElement("div");
        div.className = "detail-card";
        
        let rows = "";
        // Sort dates descending
        const sortedDates = Object.keys(c.dailyRevenue || {}).sort().reverse();
        sortedDates.forEach(date => {
            rows += `<tr><td>${date}</td><td>${c.id} ${c.dailyRevenue[date].toFixed(2)}</td></tr>`;
        });

        div.innerHTML = `
            <h3 style="margin:0; color:#a3ff6e">${c.id} Ledger</h3>
            <p style="margin:5px 0; color:#8892b0">Deals: ${c.dealsCount}</p>
            <table class="table">
                <thead><tr><th>Date</th><th>Earnings</th></tr></thead>
                <tbody>${rows || "<tr><td colspan='2'>No data</td></tr>"}</tbody>
            </table>
        `;
        grid.appendChild(div);
    });
}

// 3. Render Style Charts
function renderCharts(data) {
    const ctxLine = document.getElementById('revenueLineChart').getContext('2d');
    const ctxPie = document.getElementById('sharePieChart').getContext('2d');

    // Aggregate dates for line chart
    const dateLabels = [...new Set(data.flatMap(c => Object.keys(c.dailyRevenue)))].sort();
    const datasets = data.map((c, i) => ({
        label: c.id,
        data: dateLabels.map(d => c.dailyRevenue[d] || 0),
        borderColor: ['#4a90e2', '#a3ff6e', '#f5a623'][i % 3],
        tension: 0.3
    }));

    if(revenueLineChart) revenueLineChart.destroy();
    revenueLineChart = new Chart(ctxLine, {
        type: 'line',
        data: { labels: dateLabels, datasets },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    if(sharePieChart) sharePieChart.destroy();
    sharePieChart = new Chart(ctxPie, {
        type: 'doughnut',
        data: {
            labels: data.map(c => c.id),
            datasets: [{
                data: data.map(c => c.totalRevenue),
                backgroundColor: ['#4a90e2', '#a3ff6e', '#f5a623']
            }]
        }
    });
}
</script>
</body>
</html>
