<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EarnLibr — Admin Provider Bills</title>
<style>
body { font-family: Arial, sans-serif; background: #0b0d17; color: #eef2f7; margin: 0; padding: 20px; }
h1 { background: linear-gradient(90deg, #4a90e2, #a3ff6e); -webkit-background-clip: text; color: transparent; margin-bottom: 20px; }
.bill-container { margin-bottom: 20px; }
.provider-bill { background: #1a2235; padding: 15px; border-radius: 12px; margin-bottom: 10px; }
.offer-breakdown { background: #0f1724; padding: 10px; margin-bottom: 5px; border-radius: 10px; cursor: pointer; }
.deal-item { background: #171f34; padding: 8px; margin: 5px 0; border-radius: 8px; font-size: 14px; }
.btn-confirm { background: #4ade80; color: #041018; padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px; }
.notif { display: none; margin-bottom: 20px; padding: 10px; border-radius: 8px; }
.notif.success { border-left: 4px solid #4ade80; color: #a3ff6e; }
.notif.error { border-left: 4px solid #ef4444; color: #ff8c8c; }
</style>
</head>
<body>

<h1>Admin — Provider Bills</h1>
<div id="notif" class="notif"></div>
<div id="billContainer" class="bill-container">Loading provider bills...</div>

<script type="module">
import { db } from './firebase.js';
import { ref, get, update } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js';

const billContainer = document.getElementById('billContainer');
const notif = document.getElementById('notif');
const showNotif = (msg, type='success') => {
  notif.textContent = msg;
  notif.className = `notif ${type}`;
  notif.style.display = 'block';
  setTimeout(() => notif.style.display = 'none', 4000);
};

async function fetchAdminBills() {
  billContainer.innerHTML = "Loading...";
  try {
    const billsSnap = await get(ref(db, 'provider-bills'));
    if (!billsSnap.exists()) {
      billContainer.innerHTML = "<p>No provider bills found.</p>";
      return;
    }

    const providerBills = billsSnap.val();
    billContainer.innerHTML = "";

    for (const [providerId, bills] of Object.entries(providerBills)) {
      const providerDiv = document.createElement('div');
      providerDiv.className = "provider-bill";
      providerDiv.innerHTML = `<h3>Provider: ${providerId}</h3>`;

      for (const [billId, bill] of Object.entries(bills)) {
        for (const [currency, total] of Object.entries(bill.totalPerCurrency)) {
          const currencyDiv = document.createElement('div');
          currencyDiv.innerHTML = `<strong>${currency} Total:</strong> ${total.toFixed(2)}`;

          // Offer breakdown
          bill.offers.filter(o => o.currency === currency).forEach(offer => {
            const offerDiv = document.createElement('div');
            offerDiv.className = "offer-breakdown";
            offerDiv.innerHTML = `<strong>${offer.offerTitle}</strong> — Subtotal: ${offer.subtotal.toFixed(2)} (${offer.deals.length} deals)`;

            const dealsList = document.createElement('div');
            dealsList.style.display = 'none';
            offer.deals.forEach(deal => {
              const dealDiv = document.createElement('div');
              dealDiv.className = "deal-item";
              dealDiv.textContent = `DealID: ${deal.id} | Client: ${deal.clientName} | Commission: ${deal.commissionEarned.toFixed(2)}`;
              dealsList.appendChild(dealDiv);
            });

            offerDiv.appendChild(dealsList);
            offerDiv.onclick = () => dealsList.style.display = dealsList.style.display === 'none' ? 'block' : 'none';
            currencyDiv.appendChild(offerDiv);
          });

          // Confirm Payment button
          const confirmBtn = document.createElement('button');
          confirmBtn.className = 'btn-confirm';
          confirmBtn.textContent = `Confirm Payment (${currency} ${total.toFixed(2)})`;
          confirmBtn.onclick = async () => {
            try {
              // Mark all deals in this bill as providerPaid
              for (const offer of bill.offers.filter(o => o.currency === currency)) {
                for (const deal of offer.deals) {
                  await update(ref(db, `completed-deals/${deal.id}`), { providerPaid: true });
                }
              }
              showNotif(`Payment confirmed for provider ${providerId}, ${currency} ${total.toFixed(2)}.`, 'success');
            } catch (err) {
              console.error(err);
              showNotif('Error confirming payment: ' + err.message, 'error');
            }
          };

          currencyDiv.appendChild(confirmBtn);
          providerDiv.appendChild(currencyDiv);
        }
      }

      billContainer.appendChild(providerDiv);
    }

  } catch (err) {
    console.error(err);
    billContainer.innerHTML = "<p>Error fetching provider bills: " + err.message + "</p>";
  }
}

fetchAdminBills();
</script>
</body>
</html>
