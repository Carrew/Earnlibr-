<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EarnLibr â€” Provider Bills</title>
<style>
body { font-family: Arial,sans-serif; background:#0b0d17; color:#eef2f7; padding:20px; }
h1 { background: linear-gradient(90deg,#4a90e2,#a3ff6e); -webkit-background-clip:text; color:transparent; margin-bottom:20px; }
.bill-card { background:#0f1724; padding:15px; border-radius:12px; margin-bottom:15px; box-shadow:0 5px 15px rgba(0,0,0,0.5); }
.btn { background:#4ade80; border:none; padding:6px 12px; border-radius:8px; cursor:pointer; font-weight:700; color:#041018; }
.btn:disabled { opacity:0.6; cursor:not-allowed; }
.notif { background:#1a2235; padding:10px; border-radius:8px; margin-bottom:15px; display:none; }
.notif.success { border-left:4px solid #4ade80; color:#a3ff6e; }
.notif.error { border-left:4px solid #ef4444; color:#ff8c8c; }
</style>
</head>
<body>

<h1>Your Bills</h1>
<div id="notif" class="notif"></div>
<div id="billsContainer">Loading bills...</div>

<script type="module">
import { auth, db } from './firebase.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { 
    collection, doc, updateDoc, query, where, onSnapshot, serverTimestamp, writeBatch 
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const billsContainer = document.getElementById("billsContainer");
const notif = document.getElementById("notif");

const showNotif = (msg,type="success")=>{
  notif.textContent=msg;
  notif.className=`notif ${type}`;
  notif.style.display="block";
  setTimeout(()=>{ notif.style.display="none"; },3000);
};

// --- Auth check ---
let userSession = localStorage.getItem("userSession");
if(!userSession){ window.location.href="login.html"; throw new Error("No session"); }
userSession = JSON.parse(userSession);

onAuthStateChanged(auth, async user=>{
  if(!user || user.uid !== userSession.uid){ localStorage.removeItem("userSession"); window.location.href="login.html"; return; }
  loadBills();
});

// --- Load provider bills ---
function loadBills(){
  // Query only bills that have been 'sent' and are not yet marked for approval
  const billsQuery = query(
    collection(db, `providers/${userSession.uid}/bills`),
    where("status", "==", "sent") 
  );
  
  onSnapshot(billsQuery, snapshot=>{
    billsContainer.innerHTML="";
    if(snapshot.empty) { billsContainer.innerHTML="<p>No pending bills to pay.</p>"; return; }

    snapshot.docs.forEach(docSnap=>{
      const bill = docSnap.data();
      const card = document.createElement("div");
      card.className="bill-card";
      card.innerHTML=`
        <div><strong>Offer:</strong> ${bill.offerTitle} (${bill.currency})</div>
        <div><strong>Total:</strong> ${bill.total.toFixed(2)}</div>
        <div><strong>Status:</strong> ${bill.status}</div>
      `;

      if(bill.status==="sent"){
        const btn = document.createElement("button");
        btn.className="btn";
        btn.textContent="Mark as Paid (Waiting Admin Approval)";
        btn.onclick=()=>markAsPaid(bill.billId, btn);
        card.appendChild(btn);
      }

      billsContainer.appendChild(card);
    });
  });
}

// --- Mark a bill as paid (UPGRADED: Uses writeBatch and serverTimestamp) ---
async function markAsPaid(billId, btn){
  btn.disabled=true;
  try {
    const batch = writeBatch(db);
    const updateData = { 
      status: "provider_marked_paid", 
      providerMarkedAt: serverTimestamp() // Use serverTimestamp for integrity
    };

    // Update the main bill record
    batch.update(doc(db,"bills",billId), updateData);
    
    // Update the provider's subcollection record
    batch.update(doc(db, `providers/${userSession.uid}/bills/${billId}`), updateData);
    
    await batch.commit(); // Atomic update

    showNotif("Bill marked as paid and sent for Admin Approval!");
  } catch(err) {
    console.error("Failed to mark bill as paid:", err);
    showNotif("Error: Failed to update bill status.", "error");
    btn.disabled=false; // Re-enable on failure
  }
}
</script>
</body>
</html>
