<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Provider Weekly Bill — EarnLibr</title>
<style>
:root {
  --bg:#0b0d17;
  --card:#0f1724;
  --accent1:#4a90e2;
  --accent2:#a3ff6e;
  --muted:#bfc7d6;
  --radius:12px;
  --glass: rgba(255,255,255,0.02);
  --glass2: rgba(255,255,255,0.015);
}

body {
  font-family: Inter,system-ui,Arial; margin:0; background:var(--bg); color:#eef2f7; padding:20px; min-height:100vh;
}
h1 {
  font-size:24px; margin-bottom:20px;
  background:linear-gradient(90deg,var(--accent1),var(--accent2));
  -webkit-background-clip:text; color:transparent;
}
.notif {
  display:none; padding:12px 16px; margin-bottom:20px; border-radius:8px;
  font-weight:600;
}
.notif.success { border-left:4px solid var(--accent2); color:var(--accent2); background:rgba(74,144,226,0.05); }
.notif.error { border-left:4px solid #ef4444; color:#ff8c8c; background:rgba(239,68,68,0.05); }

.bill-card {
  background: linear-gradient(180deg,var(--glass),var(--glass2)); 
  padding:18px; border-radius:var(--radius); margin-bottom:20px;
  box-shadow:0 8px 20px rgba(0,0,0,0.4); border:1px solid rgba(255,255,255,0.03);
  transition: transform 0.2s, box-shadow 0.2s;
}
.bill-card:hover { transform:translateY(-3px); box-shadow:0 12px 24px rgba(0,0,0,0.5); }

.offer { border-bottom:1px solid #2b3145; padding:8px 0; cursor:pointer; }
.deal-item { font-size:13px; margin-left:15px; padding:2px 0; }

.btn-toggleOffers, .btn-pay {
  padding:8px 14px; border:none; border-radius:8px; font-weight:600; cursor:pointer; margin-top:10px;
  transition:0.2s;
}
.btn-toggleOffers { background:#3b82f6; color:#fff; }
.btn-toggleOffers:hover { opacity:0.9; }
.btn-pay { background:#4ade80; color:#041018; }
.btn-pay:hover { opacity:0.9; }

.filters {
  margin-bottom:20px; display:flex; gap:12px; flex-wrap:wrap;
}
.filters select {
  padding:6px 10px; border-radius:8px; border:1px solid #2b3145; background:var(--card); color:#eef2f7; cursor:pointer;
}
</style>
</head>
<body>

<h1>Provider Weekly Bill</h1>
<div class="filters">
  <select id="filterStatus">
    <option value="all">All Statuses</option>
    <option value="pending">Pending</option>
    <option value="paid_pending_verification">Paid (Pending Verification)</option>
    <option value="paid">Paid</option>
  </select>
</div>

<div id="notif" class="notif"></div>
<div id="billContainer">Loading your bills...</div>

<script type="module">
import { db } from './firebase.js';
import { ref, onValue, update, push } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js';

const sessionRaw = localStorage.getItem('userSession');
if(!sessionRaw) { window.location.href='login.html'; throw new Error('No session'); }
const session = JSON.parse(sessionRaw);
if(session.role !== 'provider'){ window.location.href='login.html'; throw new Error('Unauthorized'); }

const providerId = session.uid;
const billContainer = document.getElementById('billContainer');
const notif = document.getElementById('notif');
const filterStatus = document.getElementById('filterStatus');

const showNotif = (msg, type='success') => {
  notif.textContent = msg;
  notif.className = `notif ${type}`;
  notif.style.display = 'block';
  setTimeout(()=> notif.style.display='none', 4000);
};

let billsData = {};

const billsRef = ref(db, `bills/${providerId}`);
onValue(billsRef, snapshot => {
  billsData = snapshot.exists() ? snapshot.val() : {};
  renderBills();
});

filterStatus.addEventListener('change', renderBills);

function renderBills(){
  billContainer.innerHTML = '';
  const filter = filterStatus.value;

  const billsArray = Object.values(billsData)
    .filter(b => filter==='all' || b.status===filter)
    .sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

  if(billsArray.length === 0){
    billContainer.innerHTML = '<p style="opacity:0.6;text-align:center;">No bills to display.</p>';
    return;
  }

  billsArray.forEach(bill => {
    const card = document.createElement('div');
    card.className = 'bill-card';

    let totalsHTML = '';
    Object.entries(bill.totals).forEach(([curr, amt]) => totalsHTML += `<div><strong>${curr} Total:</strong> ${amt.toFixed(2)}</div>`);

    card.innerHTML = `
      <h3>${bill.providerName} — Bill #${bill.billId.slice(-6)}</h3>
      <div><strong>Created:</strong> ${new Date(bill.createdAt).toLocaleString()}</div>
      <div>${totalsHTML}</div>
      <button class="btn-toggleOffers">Show Offer & Deals Breakdown</button>
      <div class="offer-breakdown" style="display:none;"></div>
      <button class="btn-pay">Mark as Paid</button>
      <div style="margin-top:6px; color:var(--muted); font-size:12px;">Status: ${bill.status}</div>
    `;

    const breakdown = card.querySelector('.offer-breakdown');
    Object.values(bill.offers).forEach(offer => {
      const offerDiv = document.createElement('div');
      offerDiv.className = 'offer';
      offerDiv.innerHTML = `<strong>${offer.offerTitle} — ${offer.currency} ${offer.total.toFixed(2)}</strong>`;
      offer.deals.forEach(d => {
        const dealDiv = document.createElement('div');
        dealDiv.className = 'deal-item';
        dealDiv.textContent = `DealID: ${d.dealId} | Client: ${d.clientName} | Commission: ${d.commissionEarned.toFixed(2)} | Note: ${d.note}`;
        offerDiv.appendChild(dealDiv);
      });
      breakdown.appendChild(offerDiv);
    });

    card.querySelector('.btn-toggleOffers').onclick = () => {
      breakdown.style.display = breakdown.style.display==='none' ? 'block':'none';
    };

    card.querySelector('.btn-pay').onclick = async () => {
      try{
        const timestamp = new Date().toISOString();
        await push(ref(db, 'admin-notifications'), {
          providerId, billId: bill.billId, totals: bill.totals, offers: bill.offers, createdAt: timestamp, type:'providerPaymentNotification'
        });
        await update(ref(db, `bills/${providerId}/${bill.billId}`), { status:'paid_pending_verification', updatedAt: timestamp });
        showNotif('✅ Payment notification sent to admin.', 'success');
      } catch(err){
        console.error(err);
        showNotif('Error sending payment notification: ' + err.message, 'error');
      }
    };

    billContainer.appendChild(card);
  });
}
</script>
</body>
</html>
