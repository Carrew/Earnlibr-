<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EarnLibr â€” Offers</title>
  <style>
    :root{
      --bg:#0b0d17;
      --card:#0f1724;
      --accent1:#4a90e2;
      --accent2:#a3ff6e;
      --muted:#bfc7d6;
      --radius:12px;
    }
    body{
      margin:0; font-family:Inter,system-ui,Arial;
      background: var(--bg); color:#eef2f7;
      min-height:100vh; padding:20px;
    }
    h1{
      font-size:22px; margin-bottom:20px;
      background:linear-gradient(90deg,var(--accent1),var(--accent2));
      -webkit-background-clip:text; color:transparent;
    }
    .offer-grid{
      display:grid; grid-template-columns:repeat(auto-fill,minmax(320px,1fr)); gap:20px;
    }
    .offer-card{
      background:var(--card); border-radius:var(--radius); padding:15px;
      box-shadow:0 0 8px rgba(0,0,0,0.3);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .offer-card:hover{ transform:translateY(-5px); box-shadow:0 0 15px rgba(74,144,226,0.3);}
    .offer-card img{ width:100%; height:180px; object-fit:cover; border-radius:8px; margin-bottom:10px;}
    .offer-title{ font-weight:600; font-size:17px; color:#fff; margin-bottom:6px; }
    .offer-desc{ font-size:14px; color:#94a3b8; margin:4px 0; }
    .status{
      display:inline-block; padding:5px 10px; border-radius:8px; font-size:13px; margin-top:6px;
    }
    .status.active{ background:#22c55e33; color:#4ade80; }
    .status.paused{ background:#facc1533; color:#fbbf24; }
    .status.completed{ background:#ef444433; color:#f87171; }
    .actions{ margin-top:12px; display:flex; gap:8px; }
    .btn{ flex:1; border:none; border-radius:8px; padding:8px; font-size:13px; cursor:pointer; color:#fff; }
    .btn.copy{ background:#3b82f6; }
    .btn.track{ background:#4ade80; }
    @media(max-width:360px){
      body{ padding:10px; }
    }
  </style>
</head>
<body>
  <h1>Available Offers</h1>
  <div id="offerGrid" class="offer-grid"></div>

  <script type="module">
    import { db } from "./firebase.js";
    import { ref, onValue } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

    const sessionRaw = localStorage.getItem('userSession');
    if(!sessionRaw){ window.location.href='login.html'; throw new Error('No session'); }
    const session = JSON.parse(sessionRaw);

    const offerGrid = document.getElementById('offerGrid');
    const offersRef = ref(db, "offers");

    onValue(offersRef, snapshot => {
      offerGrid.innerHTML = "";
      snapshot.forEach(providerSnap => {
        const providerOffers = providerSnap.val();
        for(const offerId in providerOffers){
          const offer = providerOffers[offerId];
          if(!offer) continue;

          // Only show verified & active offers
          if(!offer.verified || offer.status !== "active") continue;

          const statusClass = offer.status;
          const image = offer.imageUrl || "https://via.placeholder.com/400x200?text=No+Image";
          const desc = offer.description ? offer.description.substring(0,80)+'...' : '';

          const card = document.createElement('div');
          card.className = 'offer-card';
          card.innerHTML = `
            <img src="${image}" alt="Offer">
            <div class="offer-title">${offer.title}</div>
            <div class="offer-desc">${desc}</div>
            <div class="offer-desc">ðŸ’° ${offer.currency||"$"} ${offer.price||"â€”"}</div>
            <div class="status ${statusClass}">${offer.status}</div>
            <div class="actions">
              <button class="btn copy">Copy Link</button>
              <button class="btn track">Track Stats</button>
            </div>
          `;
          offerGrid.appendChild(card);

          // Copy Link
          card.querySelector('.btn.copy').onclick = () => {
            const repoPath = "Earnlibr-";
            const link = `${window.location.origin}/${repoPath}/track.html?offer=${offerId}&user=${session.uid}`;
            navigator.clipboard.writeText(link);
            alert("Promotion link copied!");
          };

          // Track Stats
          card.querySelector('.btn.track').onclick = () => {
            window.location.href = `my-promotions.html#${offerId}`;
          };
        }
      });

      if(!offerGrid.hasChildNodes()){
        offerGrid.innerHTML = "<div style='text-align:center;opacity:0.6;'>No offers available yet.</div>";
      }
    });
  </script>
</body>
</html>
