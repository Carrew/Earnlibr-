<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EarnLibr â€” Admin Deals Management</title>

<style>
/* CSS unchanged */
</style>
</head>

<body>

<h1>Admin Deals Management</h1>
<div id="notif" class="notif"></div>
<div id="dealsContainer">Loading deals...</div>
<div id="loadMoreContainer" class="load-more" style="display: none;">
  <button id="loadMoreBtn">Load More Deals</button>
</div>

<script type="module">
import { auth, db } from './firebase.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { 
  collection, doc, getDoc, getDocs, setDoc, deleteDoc, runTransaction, query, orderBy,
  serverTimestamp, writeBatch, limit, startAfter, where
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const dealsContainer = document.getElementById("dealsContainer");
const notif = document.getElementById("notif");
const loadMoreBtn = document.getElementById("loadMoreBtn");
const loadMoreContainer = document.getElementById("loadMoreContainer");

const showNotif = (msg, type="success") => {
  notif.textContent = msg;
  notif.className = `notif ${type}`;
  notif.style.display = "block";
  setTimeout(() => notif.style.display = "none", 3000);
};

/* ðŸ” DEBUG: Global error trap */
window.addEventListener("unhandledrejection", e => {
  console.error("ðŸ”´ UNHANDLED PROMISE:", e.reason);
});
window.addEventListener("error", e => {
  console.error("ðŸ”´ GLOBAL ERROR:", e.message, e.error);
});

/* --- Session & Admin Auth --- */
let userSession = localStorage.getItem("userSession");
if(!userSession){
  console.error("ðŸ”´ No user session found");
  window.location.href = "login.html";
  throw new Error("No session");
}
userSession = JSON.parse(userSession);

onAuthStateChanged(auth, async (user) => {
  console.group("ðŸ” AUTH CHECK");
  console.log("Auth user:", user);

  try {
    if(!user || user.uid !== userSession.uid || !user.emailVerified){
      console.error("ðŸ”´ Auth mismatch or email not verified");
      localStorage.removeItem("userSession");
      window.location.href = "login.html";
      return;
    }

    const userDoc = await getDoc(doc(db, "users", user.uid));
    const adminDoc = await getDoc(doc(db, "admins", user.uid));

    console.log("User doc exists:", userDoc.exists());
    console.log("Admin doc exists:", adminDoc.exists());

    let data = null;
    let role = null;

    if (userDoc.exists()) {
      data = userDoc.data();
      role = data.role;
    } else if (adminDoc.exists()) {
      data = adminDoc.data();
      role = data.role || "admin";
    } else {
      console.error("ðŸ”´ No role document found");
      localStorage.removeItem("userSession");
      window.location.href = "login.html";
      return;
    }

    console.log("Resolved role:", role);

    if (!["admin", "super_admin"].includes(role)) {
      console.error("ðŸ”´ Unauthorized role");
      localStorage.removeItem("userSession");
      window.location.href = "login.html";
      return;
    }

    userSession = { uid: user.uid, name: data.name, email: data.email, role };
    localStorage.setItem("userSession", JSON.stringify(userSession));

    console.log("âœ… Auth OK â€” loading deals");
    console.groupEnd();

    loadDeals();

  } catch (err) {
    console.error("ðŸ”´ AUTH ERROR:", err);
    console.groupEnd();
  }
});

/* --- Load Deals with Pagination --- */
let lastDeal = null;

function loadDeals(isInitialLoad = true) {

  console.group("ðŸ” LOAD DEALS");
  console.log("Initial load:", isInitialLoad);
  console.log("Last deal:", lastDeal);

  if (isInitialLoad) {
    dealsContainer.innerHTML = "";
    lastDeal = null;
  }

  let dealsQuery = query(
    collection(db, "deals"),
    where("status", "!=", "processing"),
    orderBy("status"),
    orderBy("createdAt", "desc"),
    limit(25)
  );

  if (lastDeal) {
    dealsQuery = query(dealsQuery, startAfter(lastDeal));
  }

  console.log("Firestore query:", dealsQuery);

  loadMoreBtn.disabled = true;
  loadMoreBtn.textContent = "Loading...";

  getDocs(dealsQuery)
    .then(snapshot => {
      console.log("Snapshot size:", snapshot.size);

      if (snapshot.empty && isInitialLoad) {
        dealsContainer.innerHTML = "<p>No active deals found.</p>";
        loadMoreContainer.style.display = "none";
        return;
      }

      snapshot.docs.forEach(docSnap => {
        renderDealCard(docSnap.id, docSnap.data());
      });

      lastDeal = snapshot.docs[snapshot.docs.length - 1];
      loadMoreContainer.style.display = "block";

      if (snapshot.docs.length < 25) {
        loadMoreBtn.textContent = "No More Deals";
        loadMoreBtn.disabled = true;
      } else {
        loadMoreBtn.textContent = "Load More Deals";
        loadMoreBtn.disabled = false;
      }
    })
    .catch(err => {
      console.error("ðŸ”´ FIRESTORE QUERY FAILED");
      console.error("Code:", err.code);
      console.error("Message:", err.message);
      console.error("Stack:", err.stack);

      if (err.code === "failed-precondition") {
        console.warn("âš ï¸ THIS IS A FIRESTORE INDEX ERROR");
        console.warn("âž¡ï¸ Firestore should provide a console link to create the index");
      }

      showNotif("Failed to load deals.", "error");
      loadMoreBtn.textContent = "Failed to Load";
    })
    .finally(() => {
      console.groupEnd();
    });
}

loadMoreBtn.onclick = () => loadDeals(false);

/* --- Render Deal Card --- */
function renderDealCard(dealId, deal){
  const card = document.createElement("div");
  card.className="deal-card "+(deal.status||"");

  const createdDate = deal.createdAt?.toDate()?.toLocaleString() || 'N/A';

  card.innerHTML = `
    <div class="deal-info"><strong>Deal ID:</strong> ${dealId}</div>
    <div class="deal-info"><strong>Offer:</strong> ${deal.offerTitle||'N/A'}</div>
    <div class="deal-info"><strong>Provider:</strong> ${deal.providerName || deal.providerId}</div>
    <div class="deal-info"><strong>Promoter:</strong> ${deal.promoterId!=="direct"?deal.promoterName:"Direct"} (${deal.promoterId})</div>
    <div class="deal-info"><strong>Client:</strong> ${deal.clientName} | ${deal.clientContact}</div>
    <div class="deal-info"><strong>Note:</strong> ${deal.note||"None"}</div>

    <div class="deal-actions">
      <button class="complete">Mark Completed</button>
      <button class="cancel">Mark Cancelled</button>
    </div>

    <div class="timestamp">Created: ${createdDate} | Status: ${deal.status || "Pending"}</div>
  `;

  dealsContainer.appendChild(card);
}
</script>

</body>
</html>
