<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EarnLibr — Admin Deals Management & Platform Earnings</title>
<style>
:root {
  --bg: #0b0d17;
  --card: #131927;
  --accent1: #4a90e2;
  --accent2: #a3ff6e;
  --muted: #bfc7d6;
  --danger: #ef4444;
  --success: #4ade80;
  --shadow: rgba(0,0,0,0.35);
}
body {
  margin: 0; font-family: 'Inter', system-ui, Arial; background: var(--bg); color: #eef2f7; min-height: 100vh;
}
header {
  display: flex; align-items: center; justify-content: center;
  background: linear-gradient(90deg, var(--accent1), var(--accent2));
  padding: 20px; color: #041018;
}
header img { height: 50px; margin-right: 15px; }
header h1 { font-size: 24px; font-weight: bold; }

h1.page-title {
  text-align: center;
  margin: 25px 0;
  font-size: 22px;
  font-weight: 600;
  color: #eef2f7;
}

.notif {
  margin: 10px auto;
  padding: 12px 18px;
  width: 90%;
  max-width: 600px;
  border-radius: 12px;
  display: none;
  font-size: 14px;
  transition: transform 0.3s, opacity 0.3s;
}
.notif.success { background: var(--card); border-left: 4px solid var(--success); color: var(--success);}
.notif.error { background: var(--card); border-left: 4px solid var(--danger); color: #ff8c8c;}

.deals-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px;
  max-width: 900px;
  margin: 0 auto;
}

.deal-card {
  background: var(--card);
  border-radius: 14px;
  padding: 18px;
  margin-bottom: 20px;
  width: 100%;
  box-shadow: 0 4px 15px var(--shadow);
  transition: transform 0.2s, box-shadow 0.2s;
  position: relative;
}
.deal-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px var(--shadow); }
.deal-card.completed { border-left: 5px solid var(--success); }
.deal-card.cancelled { border-left: 5px solid var(--danger); }

.deal-info { font-size: 14px; margin-bottom: 6px; color: var(--muted); }
.deal-actions { margin-top: 12px; }
.deal-actions button {
  margin-right: 8px;
  padding: 8px 14px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  transition: background 0.2s, transform 0.2s;
}
.deal-actions button:hover { transform: translateY(-1px); }
.complete { background: var(--success); color: #041018; }
.cancel { background: var(--danger); color: #fff; }

.timestamp { font-size: 12px; color: var(--muted); margin-top: 8px; }

.card-notif {
  position: absolute; top: 10px; right: 10px;
  background: #1f2a3a; padding: 6px 12px; border-radius: 8px;
  font-size: 13px; display: flex; align-items: center; gap: 8px;
  box-shadow: 0 2px 8px var(--shadow);
}
.card-notif button {
  background: transparent; color: var(--accent2); border: none; cursor: pointer; font-weight: 700;
  transition: color 0.2s;
}
.card-notif button:hover { color: var(--success); }
</style>
</head>
<body>

<header>
  <img src="https://raw.githubusercontent.com/Carrew/Earnlibr-/refs/heads/main/1000115452-01.jpeg" alt="EarnLibr Logo">
  <h1>EarnLibr Admin</h1>
</header>

<div id="notif" class="notif"></div>
<h1 class="page-title">Admin — Deals Management & Platform Earnings</h1>
<div class="deals-container" id="dealsContainer">Loading deals...</div>

<script type="module">
import { db } from './firebase.js';
import { ref, onValue, update, push, get, set, remove } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js';

const dealsContainer = document.getElementById('dealsContainer');
const notif = document.getElementById('notif');
const showNotif = (message, type='success') => {
  notif.textContent = message;
  notif.className = `notif ${type}`;
  notif.style.display = 'block';
  notif.style.opacity = '1';
  setTimeout(() => { notif.style.opacity='0'; notif.style.display='none'; }, 4000);
};

// --- ADMIN SESSION CHECK ---
const session = JSON.parse(localStorage.getItem('userSession'));
if(!session || session.role !== 'admin'){
  showNotif('⚠ You must be logged in as admin to access this page.', 'error');
  dealsContainer.innerHTML = '';
  setTimeout(()=> window.location.href='login.html', 2000);
} else {
  const dealsRef = ref(db, 'deals');

  onValue(dealsRef, async (snapshot) => {
    dealsContainer.innerHTML = '';
    if(!snapshot.exists()) { dealsContainer.innerHTML='<p style="text-align:center;">No deals found.</p>'; return; }

    const dealsData = snapshot.val();
    const sortedDealIds = Object.keys(dealsData).sort((a,b)=> new Date(dealsData[b].createdAt) - new Date(dealsData[a].createdAt));

    sortedDealIds.forEach(async dealId => {
      const deal = dealsData[dealId];
      const card = document.createElement('div');
      card.className = 'deal-card ' + (deal.status||'');
      card.innerHTML = `
        <div class="deal-info"><strong>Deal ID:</strong> ${dealId}</div>
        <div class="deal-info"><strong>Offer:</strong> ${deal.offerTitle||'N/A'}</div>
        <div class="deal-info"><strong>Provider:</strong> ${deal.providerName||'N/A'} (${deal.providerId})</div>
        <div class="deal-info"><strong>Promoter:</strong> ${deal.promoterId!=='direct'?deal.promoterName||'Unknown':'Direct'} (${deal.promoterId})</div>
        <div class="deal-info"><strong>Client:</strong> ${deal.clientName} | ${deal.clientContact}</div>
        <div class="deal-info"><strong>Note:</strong> ${deal.note||'None'}</div>
        <div class="deal-actions">
          <button class="complete">✅ Complete</button>
          <button class="cancel">❌ Cancel</button>
        </div>
        <div class="timestamp">
          Created: ${new Date(deal.createdAt).toLocaleString()} | 
          Status: ${deal.status||'Pending'} 
          ${deal.completedBy ? ` | Completed by: ${deal.completedBy}` : ''}
        </div>
      `;

      // Helper function containing all the complex database logic
      const processAction = async (type) => {
        const timestamp = new Date().toISOString();
        const currency = deal.currency || 'USD';
        
        if(type==='complete'){
          if(deal.status==='completed') return showNotif('Already completed.','error');
          try {
            let commissionEarned = 0;

            // 1️⃣ Get platform settings
            const platformSnap = await get(ref(db, 'platform-settings/commission'));
            const platformData = platformSnap.exists() ? platformSnap.val() : { percentage: 20 };
            const platformPercentage = parseFloat(platformData.percentage);

            // 2️⃣ Calculate commission
            if (deal.offerId && deal.providerId) {
              const offerRef = ref(db, `offers/${deal.providerId}/${deal.offerId}`);
              const offerSnap = await get(offerRef);
              if (offerSnap.exists()) {
                const offerData = offerSnap.val();

                if (offerData.commissionType === 'percentage') {
                  commissionEarned = (parseFloat(offerData.price || 0) * parseFloat(offerData.commissionValue || 0)) / 100;
                } else if (offerData.commissionType === 'fixed') {
                  commissionEarned = parseFloat(offerData.commissionValue || 0);
                } else {
                  commissionEarned = parseFloat(deal.commissionValue || 0);
                }

                const platformShare = (commissionEarned * platformPercentage) / 100;
                const promoterNet = commissionEarned - platformShare;

                // 3️⃣ Update offer financials
                const newSpent = parseFloat(offerData.promoSpent || 0) + commissionEarned;
                const newAmountOwed = parseFloat(offerData.amountOwed || 0) + commissionEarned;
                const newOutstanding = newAmountOwed - parseFloat(offerData.amountPaid || 0);

                const offerUpdates = {
                  promoSpent: newSpent,
                  amountOwed: newAmountOwed,
                  outstandingBalance: newOutstanding
                };

                if (offerData.promotionBudget && newSpent >= parseFloat(offerData.promotionBudget)) {
                  offerUpdates.status = 'completed';
                }

                await update(offerRef, offerUpdates);

                // 4️⃣ Update promoter wallet
                if (deal.promoterId && deal.promoterId !== 'direct') {
                  const promoterBaseRef = ref(db, `promoter-earnings/${deal.promoterId}`);

                  await set(ref(promoterBaseRef, `deals/${dealId}`), {
                    offerId: deal.offerId,
                    offerTitle: deal.offerTitle,
                    providerId: deal.providerId,
                    providerName: deal.providerName,
                    clientName: deal.clientName,
                    clientContact: deal.clientContact,
                    note: deal.note || '',
                    commissionAmount: promoterNet,
                    withdrawn: false,
                    currency: currency,
                    completedAt: timestamp,
                    completedBy: session?.role === 'admin' ? 'admin' : 'provider',
                    platformTax: platformShare,
                    fullCommission: commissionEarned
                  });

                  const metaSnap = await get(ref(promoterBaseRef, 'metadata'));
                  let metadata = metaSnap.exists() ? metaSnap.val() : {
                    totalLifetimeEarnings: {}, totalWithdrawn: {}, currentBalance: {}
                  };

                  metadata.totalLifetimeEarnings[currency] = (metadata.totalLifetimeEarnings[currency] || 0) + promoterNet;
                  metadata.currentBalance[currency] =
                    metadata.totalLifetimeEarnings[currency] - (metadata.totalWithdrawn[currency] || 0);
                  metadata.lastUpdated = timestamp;

                  await update(ref(promoterBaseRef, 'metadata'), metadata);
                }

                // 5️⃣ Update platform earnings
                const platformEarningsRef = ref(db, `platform-earnings/${currency}`);
                const platformEarningsSnap = await get(platformEarningsRef);
                let platformData2 = platformEarningsSnap.exists() ? platformEarningsSnap.val() : {
                  totalRevenue: 0, dealsCount: 0, lastUpdated: ''
                };
                platformData2.totalRevenue += platformShare;
                platformData2.dealsCount += 1;
                platformData2.lastUpdated = timestamp;
                await set(platformEarningsRef, platformData2);

                // 6️⃣ Move deal to completed
                await set(ref(db, `completed-deals/${dealId}`), {
                  ...deal,
                  status: 'completed',
                  completedAt: timestamp,
                  completedBy: session?.role === 'admin' ? 'admin' : 'provider',
                  commissionEarned,
                  promoterNet,
                  platformShare,
                  providerPaid: false,
                  paymentAmount: 0,
                  paymentNotes: ''
                });

                await remove(ref(db, `deals/${dealId}`));
                card.remove();

                // 7️⃣ Notifications
                const notifData = {
                  title: 'Deal Completed ✅',
                  message: `Deal ${dealId} completed by ${session?.role === 'admin' ? 'Admin' : 'Provider'}. Promoter earned ${promoterNet.toFixed(2)} ${currency} after ${platformPercentage}% platform share.`,
                  type: 'completed',
                  createdAt: timestamp,
                  commissionEarned,
                  promoterNet,
                  platformShare,
                  currency,
                  completedBy: session?.role === 'admin' ? 'admin' : 'provider'
                };

                await push(ref(db, `notifications/${deal.providerId}`), notifData);
                if (deal.promoterId && deal.promoterId !== 'direct') await push(ref(db, `notifications/${deal.promoterId}`), notifData);
                await push(ref(db, `admin-notifications`), { ...notifData, dealId });

                showNotif(`✅ Deal completed by ${session?.role === 'admin' ? 'Admin' : 'Provider'}. ${platformPercentage}% platform share applied.`);
              }
            }
          } catch (err) {
            console.error(err);
            showNotif('Error completing deal: ' + err.message, 'error');
          }
        } else {
          // Cancel logic
          if(deal.status==='cancelled') return showNotif('Already cancelled.','error');
          
          await remove(ref(db, `deals/${dealId}`));
          card.remove();
          
          const notifData = { 
            title:'Deal Cancelled ❌', 
            message:`Deal ${dealId} cancelled.`, 
            type:'cancelled', 
            createdAt:timestamp, 
            dealId 
          };
          await push(ref(db, `notifications/${deal.providerId}`), notifData);
          if(deal.promoterId && deal.promoterId!=='direct') await push(ref(db, `notifications/${deal.promoterId}`), notifData);
          await push(ref(db, 'admin-notifications'), notifData);
          showNotif(`❌ Deal ${dealId} cancelled.`, 'error');
        }
      };

      // Function to introduce the 5-second delay and "Undo" option
      const scheduleAction = (type) => {
        const cardNotif = document.createElement('div');
        cardNotif.className = 'card-notif';
        cardNotif.innerHTML = `${type==='complete'?'Completing':'Cancelling'} in 5s <button>Undo</button>`;
        card.appendChild(cardNotif);

        let canceled=false;
        cardNotif.querySelector('button').onclick=()=>{
          canceled=true;
          cardNotif.remove();
          showNotif('Action canceled', 'error');
        };

        setTimeout(()=>{ if(!canceled) processAction(type); },5000);
      };

      card.querySelector('.complete').onclick=()=>scheduleAction('complete');
      card.querySelector('.cancel').onclick=()=>scheduleAction('cancel');

      dealsContainer.appendChild(card);
    });
  });
}
</script>

</body>
</html>
