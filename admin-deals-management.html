<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EarnLibr — Admin Deals Management</title>
<style>
body { font-family: Arial, sans-serif; background: #0b0d17; color: #eef2f7; margin: 0; padding: 20px; }
h1 { background: linear-gradient(90deg, #4a90e2, #a3ff6e); -webkit-background-clip: text; color: transparent; margin-bottom: 20px; }
.deal-card { background: #0f1724; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: opacity .5s ease, transform .3s; position: relative; }
.deal-card:hover { transform: translateY(-4px); }
.deal-card.completed { border-left: 4px solid #4ade80; }
.deal-card.cancelled { border-left: 4px solid #ef4444; }
.deal-info { margin-bottom: 10px; font-size: 14px; }
.deal-actions button { margin-right: 8px; padding: 6px 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; position: relative; }
.complete { background: #4ade80; color: #041018; }
.cancel { background: #ef4444; color: #fff; }
button.loading { pointer-events: none; opacity: 0.7; }
button.loading::after { content: ''; position: absolute; top: 50%; left: 50%; width: 16px; height: 16px; margin: -8px 0 0 -8px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.timestamp { font-size: 12px; color: #bfc7d6; margin-top: 5px; }
.notif { background: #1a2235; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; display: none; }
.notif.success { border-left: 4px solid #4ade80; color: #a3ff6e; }
.notif.error { border-left: 4px solid #ef4444; color: #ff8c8c; }
.card-notif { position: absolute; top: 10px; right: 10px; background: #1a2235; padding: 6px 12px; border-radius: 8px; font-size: 13px; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.45); }
.card-notif button { background: transparent; border: none; color: #a3ff6e; font-weight: 700; cursor: pointer; }
.card-notif button:hover { color: #4ade80; }
</style>
</head>
<body>

<h1>Admin Deals Management</h1>
<div id="notif" class="notif"></div>
<div id="dealsContainer">Loading deals...</div>

<script type="module">
import { auth, db } from './firebase.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { 
  collection, doc, getDoc, setDoc, deleteDoc, addDoc, runTransaction, query, orderBy, onSnapshot 
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const dealsContainer = document.getElementById("dealsContainer");
const notif = document.getElementById("notif");

const showNotif = (msg, type="success") => {
  notif.textContent = msg;
  notif.className = `notif ${type}`;
  notif.style.display = "block";
  setTimeout(() => { notif.style.display = "none"; }, 3000);
};

/* --- Session & Admin Auth --- */
let userSession = localStorage.getItem("userSession");
if(!userSession){ window.location.href = "login.html"; throw new Error("No session"); }
userSession = JSON.parse(userSession);

onAuthStateChanged(auth, async (user) => {
  if(!user || user.uid !== userSession.uid){
    localStorage.removeItem("userSession");
    window.location.href = "login.html";
    return;
  }

  if(!user.emailVerified){
    localStorage.removeItem("userSession");
    window.location.href = "login.html";
    return;
  }

  // Firestore user doc check
  const userDoc = await getDoc(doc(db, 'users', user.uid));
  if(!userDoc.exists() || !["admin","super_admin"].includes(userDoc.data().role)){
    localStorage.removeItem("userSession");
    window.location.href = "login.html";
    return;
  }

  // Update session
  const uData = userDoc.data();
  userSession = { uid: user.uid, name: uData.name, email: uData.email, role: uData.role };
  localStorage.setItem('userSession', JSON.stringify(userSession));

  loadDeals();
});

/* --- Helper --- */
const round = (num) => Math.round((num + Number.EPSILON) * 100) / 100;

/* --- Complete Deal --- */
async function processCompleteDeal(dealId, deal, card){
  try {
    const timestamp = new Date().toISOString();
    const currency = deal.offerCurrency || "USD";

    const dealRef = doc(db, "deals", dealId);
    const offerRef = doc(db, "offers_all", deal.offerId);

    await runTransaction(db, async (t) => {
      const offerSnap = await t.get(offerRef);
      if(!offerSnap.exists()) throw new Error("Offer not found");
      const offer = offerSnap.data();

      let commissionEarned = 0;
      if(offer.commissionType==="percentage") commissionEarned = (offer.price * offer.commissionValue)/100;
      else if(offer.commissionType==="fixed") commissionEarned = offer.commissionValue;
      else commissionEarned = deal.commissionValue || 0;
      commissionEarned = round(commissionEarned);

      const platformSnap = await getDoc(doc(db, "platform-settings", "commission"));
      const platformPercentage = platformSnap.exists() ? parseFloat(platformSnap.data().percentage) : 20;
      const platformShare = round(commissionEarned*platformPercentage/100);
      const promoterNet = round(commissionEarned-platformShare);

      // Update offer totals
      t.update(offerRef, {
        promoSpent: round((offer.promoSpent||0)+commissionEarned),
        amountOwed: round((offer.amountOwed||0)+commissionEarned),
        outstandingBalance: round((offer.amountOwed||0 + commissionEarned) - (offer.amountPaid||0))
      });

      // Update promoter earnings
      if(deal.promoterId && deal.promoterId !== "direct") {
        const promoterDealRef = doc(db, `promoter-earnings/${deal.promoterId}/deals/${dealId}`);
        t.set(promoterDealRef, {
          ...deal,
          commissionAmount: promoterNet,
          fullCommission: commissionEarned,
          platformTax: platformShare,
          completedAt: timestamp,
          withdrawn: false
        });

        const metaRef = doc(db, `promoter-earnings/${deal.promoterId}/metadata`);
        const metaSnap = await t.get(metaRef);
        let meta = metaSnap.exists() ? metaSnap.data() : { totalLifetimeEarnings:{}, currentBalance:{}, totalWithdrawn:{} };
        meta.totalLifetimeEarnings[currency] = (meta.totalLifetimeEarnings[currency]||0)+promoterNet;
        meta.currentBalance[currency] = meta.totalLifetimeEarnings[currency] - (meta.totalWithdrawn[currency]||0);
        meta.lastUpdated = timestamp;
        t.set(metaRef, meta, { merge:true });
      }

      // Update platform earnings
      const platformRef = doc(db, `platform-earnings/${currency}`);
      const platformSnap2 = await t.get(platformRef);
      const today = timestamp.split("T")[0];
      const platformData = platformSnap2.exists() ? platformSnap2.data() : { totalRevenue:0, dealsCount:0, dailyRevenue:{} };
      platformData.totalRevenue += platformShare;
      platformData.dealsCount += 1;
      platformData.dailyRevenue[today] = (platformData.dailyRevenue[today]||0) + platformShare;
      t.set(platformRef, platformData, { merge:true });

      // Move deal to completed-deals
      const completedRef = doc(db, "completed-deals", dealId);
      t.set(completedRef, {
        ...deal,
        status: "completed",
        completedAt: timestamp,
        completedBy: "admin",
        commissionEarned,
        platformShare,
        promoterNet,
        providerPaid:false
      });

      // Delete pending deal
      t.delete(dealRef);
    });

    // Notifications
    const notifData = { title:"Deal Completed ✅", message:`Deal ${dealId} marked complete by admin.`, type:"completed", createdAt: timestamp };
    await addDoc(collection(db, `notifications/${deal.providerId}/items`), notifData);
    if(deal.promoterId && deal.promoterId!=="direct") 
      await addDoc(collection(db, `notifications/${deal.promoterId}/items`), notifData);

    card.remove();
    showNotif("Deal completed successfully");
  } catch(err){ console.error(err); showNotif("Error: "+err.message,"error"); }
}

/* --- Cancel Deal --- */
async function processCancelDeal(dealId, deal, card){
  try {
    const timestamp = new Date().toISOString();
    await deleteDoc(doc(db, "deals", dealId));

    const notifData = { title:"Deal Cancelled ❌", message:`Deal ${dealId} cancelled by admin.`, type:"cancelled", createdAt: timestamp };
    await addDoc(collection(db, `notifications/${deal.providerId}/items`), notifData);
    if(deal.promoterId && deal.promoterId!=="direct") 
      await addDoc(collection(db, `notifications/${deal.promoterId}/items`), notifData);

    card.remove();
    showNotif("Deal cancelled","error");
  } catch(err){ console.error(err); showNotif("Error: "+err.message,"error"); }
}

/* --- Schedule Actions --- */
function scheduleAction(type, dealId, deal, card){
  const box = document.createElement("div");
  box.className="card-notif";
  box.innerHTML = `${type==="complete"?"Completing":"Cancelling"} in 5s <button>Undo</button>`;
  card.appendChild(box);

  const buttons = card.querySelectorAll("button");
  buttons.forEach(btn=>{ btn.disabled=true; btn.classList.add("loading"); });

  let cancelled=false;
  box.querySelector("button").onclick=()=>{
    cancelled=true;
    box.remove();
    buttons.forEach(btn=>{ btn.disabled=false; btn.classList.remove("loading"); });
    showNotif("Action cancelled","error");
  };

  setTimeout(async ()=>{
    box.remove();
    if(!cancelled){
      if(type==="complete") await processCompleteDeal(dealId, deal, card);
      else await processCancelDeal(dealId, deal, card);
    }
    buttons.forEach(btn=>{ btn.disabled=false; btn.classList.remove("loading"); });
  },5000);
}

/* --- Load All Deals --- */
function loadDeals(){
  const dealsQuery = query(
    collection(db, "deals"), 
    orderBy("createdAt","desc")
  );
  onSnapshot(dealsQuery, snapshot=>{
    dealsContainer.innerHTML="";
    if(snapshot.empty) return dealsContainer.innerHTML="<p>No active deals found.</p>";

    snapshot.docs.forEach(docSnap=>{
      renderDealCard(docSnap.id, docSnap.data());
    });
  });
}

/* --- Render Deal Card --- */
function renderDealCard(dealId, deal){
  const card = document.createElement("div");
  card.className="deal-card "+(deal.status||"");

  card.innerHTML = `
    <div class="deal-info"><strong>Deal ID:</strong> ${dealId}</div>
    <div class="deal-info"><strong>Offer:</strong> ${deal.offerTitle||'N/A'}</div>
    <div class="deal-info"><strong>Provider:</strong> ${deal.providerName || deal.providerId}</div>
    <div class="deal-info"><strong>Promoter:</strong> ${deal.promoterId!=="direct"?deal.promoterName:"Direct"} (${deal.promoterId})</div>
    <div class="deal-info"><strong>Client:</strong> ${deal.clientName} | ${deal.clientContact}</div>
    <div class="deal-info"><strong>Note:</strong> ${deal.note||"None"}</div>

    <div class="deal-actions">
      <button class="complete">Mark Completed</button>
      <button class="cancel">Mark Cancelled</button>
    </div>

    <div class="timestamp">Created: ${new Date(deal.createdAt).toLocaleString()} | Status: ${deal.status||"Pending"}</div>
  `;

  card.querySelector(".complete").onclick=()=>scheduleAction("complete",dealId,deal,card);
  card.querySelector(".cancel").onclick=()=>scheduleAction("cancel",dealId,deal,card);

  dealsContainer.appendChild(card);
}
</script>
</body>
</html>
