<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EarnLibr — Providers Create Offer</title>

<!-- CSS REMOVED BY USER REQUEST -->
<style>
/* CSS REMOVED */
#debugPanel {
  position: fixed;
  bottom: 10px;
  right: 10px;
  width: 320px;
  height: 230px;
  background: rgba(0,0,0,0.6);
  border: 1px solid #333;
  border-radius: 8px;
  padding: 10px;
  font-size: 12px;
  color: #aaffaa;
  overflow-y: auto;
  z-index: 9999;
}
</style>

</head>
<body>

<div id="debugPanel">Debug Log:</div>

<div class="wrap">
  <aside class="card sidebar">
    <div class="logo">
      <img src="https://raw.githubusercontent.com/Carrew/Earnlibr-/refs/heads/main/1000115452-01.jpeg" alt="logo">
      <div>
        <h2>EarnLibr</h2>
        <div>Provider Panel</div>
      </div>
    </div>
    <nav class="nav">
      <a id="nav-dashboard">Dashboard</a>
      <a id="nav-offers">Offers</a>
      <a id="nav-create" class="active">Create Offer</a>
      <a id="nav-notifs">Notifications</a>
    </nav>
    <div class="profile">
      <div id="avatar" class="avatar">P</div>
      <div>
        <div id="providerName">Loading...</div>
        <div id="providerEmail">—</div>
      </div>
      <div style="margin-left:auto">
        <button id="logoutBtn">Logout</button>
      </div>
    </div>
  </aside>

  <main class="main card">
    <h1>Create a New Offer</h1>
    <form id="offerForm">
      <label>Title</label>
      <input type="text" id="title" required />

      <label>Description</label>
      <textarea id="description" required></textarea>

      <label>Category</label>
      <select id="category" required>
        <option value="">Select category</option>
        <option>Digital Service</option>
        <option>Physical Product</option>
        <option>Course / Training</option>
        <option>Consultation</option>
        <option>Other</option>
      </select>

      <label>Currency</label>
      <select id="currency" required></select>

      <label>Price</label>
      <input type="number" id="price" required />

      <label>Commission Type</label>
      <select id="commissionType" required>
        <option value="fixed">Fixed</option>
        <option value="percentage">Percentage</option>
      </select>

      <label>Commission Value</label>
      <input type="number" id="commissionValue" required />

      <label>Promotion Budget</label>
      <input type="number" id="promotionBudget" required />

      <label>Total Products Available</label>
      <input type="number" id="totalProducts" required />

      <label>Upload Product Image</label>
      <input type="file" id="productImage" accept="image/*" />
      <img id="imagePreview" />

      <button type="submit" id="submitBtn">Submit Offer for Verification</button>
    </form>
  </main>
</div>

<!-- currencies.js stays -->
<script type="module" src="currencies.js"></script>

<script type="module">
/*********************************
        REAL DEBUG LOGGER
*********************************/
import { db } from "./firebase.js";
import { collection, addDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

function LOG(message, data = null) {
  const entry = {
    message,
    data,
    timestamp: new Date().toISOString()
  };

  console.log("⚡ DEBUG:", entry);

  // Update on-screen debug panel
  const panel = document.getElementById("debugPanel");
  const div = document.createElement("div");
  div.textContent = `${entry.timestamp}: ${message}`;
  panel.appendChild(div);
  panel.scrollTop = panel.scrollHeight;

  // Save to Firestore logs
  addDoc(collection(db, "debug_logs"), entry)
    .catch(err => console.error("❌ Failed to log to Firestore:", err));
}

/*********************************
        FIREBASE IMPORTS
*********************************/
import { auth } from "./firebase.js";
import {
  signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

import {
  collection as col, addDoc as addDocument
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

/*********************************
           ELEMENTS
*********************************/
const providerNameEl = document.getElementById('providerName');
const providerEmailEl = document.getElementById('providerEmail');
const avatarEl = document.getElementById('avatar');

const imageInput = document.getElementById('productImage');
const imagePreview = document.getElementById('imagePreview');
const offerForm = document.getElementById("offerForm");
const submitBtn = document.getElementById("submitBtn");

let userSession = null;
let imageBase64 = "";

/*********************************
     BASIC NOTIFICATION
*********************************/
function showNotification(msg) {
  alert(msg);
}

/*********************************
     LOAD SESSION
*********************************/
LOG("Loading session...");

const sessionRaw = localStorage.getItem("userSession");
if (!sessionRaw) {
  LOG("❌ No session found");
  location.href = "login.html";
}

userSession = JSON.parse(sessionRaw);
LOG("Session loaded", userSession);

/*********************************
      FIREBASE AUTH CHECK
*********************************/
onAuthStateChanged(auth, user => {
  LOG("Auth state:", user);

  if (!user || user.uid !== userSession.uid) {
    LOG("❌ Auth mismatch or null user");
    location.href = "login.html";
    return;
  }

  LOG("User authenticated");

  providerNameEl.textContent = userSession.name || "Provider";
  providerEmailEl.textContent = userSession.email;
  avatarEl.textContent = providerNameEl.textContent.charAt(0);

  attachHandlers();
});

/*********************************
      IMAGE COMPRESSION
*********************************/
function compressImage(file) {
  LOG("Compressing image:", file.name);

  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = event => {
      const img = new Image();
      img.src = event.target.result;
      img.onload = () => {
        const canvas = document.createElement("canvas");
        const ratio = 0.7;
        canvas.width = img.width * ratio;
        canvas.height = img.height * ratio;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        resolve(canvas.toDataURL("image/jpeg", 0.8));
      };
    };
    reader.readAsDataURL(file);
  });
}

/*********************************
      PAGE HANDLERS
*********************************/
function attachHandlers() {
  LOG("Attaching page handlers");

  document.getElementById("logoutBtn").onclick = async () => {
    LOG("Logging out...");
    await signOut(auth);
    localStorage.removeItem("userSession");
    location.href = "login.html";
  };

  imageInput.addEventListener("change", async e => {
    const file = e.target.files[0];
    if (!file) return;
    LOG("Image selected:", file.name);

    imageBase64 = await compressImage(file);
    imagePreview.src = imageBase64;
  });

  offerForm.onsubmit = async e => {
    e.preventDefault();
    submitBtn.disabled = true;

    LOG("Submitting offer...");

    const offerData = {
      providerId: userSession.uid,
      title: title.value.trim(),
      description: description.value.trim(),
      category: category.value,
      currency: currency.value,
      price: Number(price.value),
      commissionType: commissionType.value,
      commissionValue: Number(commissionValue.value),
      promotionBudget: Number(promotionBudget.value),
      totalProducts: Number(totalProducts.value),
      imageTemp: imageBase64,
      status: "pending",
      createdAt: new Date().toISOString()
    };

    LOG("Prepared offer:", offerData);

    try {
      const ref = await addDocument(col(db, "offers_pending"), offerData);
      LOG("✔ Offer submitted:", ref.id);
      showNotification("Offer submitted.");
      offerForm.reset();
      imagePreview.src = "";
    } catch (err) {
      LOG("❌ Firestore error:", err);
      showNotification("Error submitting offer.");
    }

    submitBtn.disabled = false;
  };
}
</script>

</body>
</html>
