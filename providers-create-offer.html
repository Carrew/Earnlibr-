<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EarnLibr — Providers Create Offer</title>
<style>
:root {
  --bg: #0b0d17;
  --card: #0f1724;
  --accent1: #4a90e2;
  --accent2: #a3ff6e;
  --muted: #bfc7d6;
  --danger: #e74c3c;
  --glass: rgba(255,255,255,0.02);
  --glass-2: rgba(255,255,255,0.015);
  --radius: 12px;
}
html, body { height:100%; margin:0; font-family:Inter,system-ui,Arial; background: linear-gradient(180deg, #071028 0%, #0b0d17 100%); color:#eef2f7; }
.wrap { max-width: 1200px; margin: 28px auto; padding: 20px; display: grid; grid-template-columns: 260px 1fr; gap: 20px; }
.card { background: linear-gradient(180deg, var(--glass), var(--glass-2)); border-radius: var(--radius); padding: 18px; box-shadow: 0 8px 30px rgba(2,6,23,0.6); border:1px solid rgba(255,255,255,0.03); overflow:hidden; }
.sidebar { height: calc(100vh - 80px); display:flex; flex-direction:column; gap:14px; position:sticky; top:20px; }
.logo { display:flex; gap:12px; align-items:center; padding-bottom:8px; border-bottom:1px solid rgba(255,255,255,0.03); }
.logo img { width:44px; height:44px; object-fit:cover; border-radius:8px; }
.logo h2 { font-size:16px; margin:0; background:linear-gradient(90deg, var(--accent1), var(--accent2)); -webkit-background-clip:text; color:transparent; }
.nav { margin-top:12px; display:flex; flex-direction:column; gap:8px; }
.nav a { display:block; padding:10px 12px; border-radius:10px; text-decoration:none; color:var(--muted); font-weight:600; cursor:pointer; }
.nav a.active, .nav a:hover { color:#041018; background: linear-gradient(90deg, var(--accent1), var(--accent2)); }
.profile { margin-top:auto; padding-top:10px; border-top:1px solid rgba(255,255,255,0.03); display:flex; gap:12px; align-items:center; }
.avatar { width:44px; height:44px; border-radius:10px; background:linear-gradient(90deg, var(--accent1), var(--accent2)); display:flex; align-items:center; justify-content:center; font-weight:700; color:#041018; }
.main { min-height:80vh; display:flex; flex-direction:column; gap:18px; position:relative; }
h1 { font-size:20px; background:linear-gradient(90deg, var(--accent1), var(--accent2)); -webkit-background-clip:text; color:transparent; margin:0 0 10px 0; }
form label { display:block; margin-top:14px; color:var(--muted); font-size:13px; }
input, textarea, select { width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:#071427; color:#fff; font-size:14px; margin-top:4px; }
textarea { min-height:80px; resize:vertical; }
button { margin-top:18px; width:100%; padding:12px; border:none; border-radius:10px; background:linear-gradient(90deg, var(--accent1), var(--accent2)); font-weight:700; color:#041018; cursor:pointer; }
#imagePreview { width:100%; max-height:220px; object-fit:contain; border-radius:10px; margin-top:8px; display:none; }
.notification { position:absolute; top:-10px; right:0; padding:10px 16px; border-radius:8px; font-weight:700; font-size:0.9rem; opacity:0.95; }
.notification.success { background:#4ade80; color:#041018; }
.notification.error { background:#ef4444; color:#fff; }
.notification.info { background:#3b82f6; color:#fff; }
@media (max-width:980px) { .wrap { grid-template-columns:1fr; padding:14px; } .sidebar { position:relative; height:auto; } }

/* NEW DEBUG PANEL */
#debugPanel {
  position: fixed;
  bottom: 10px;
  right: 10px;
  width: 320px;
  height: 230px;
  background: rgba(0,0,0,0.6);
  border: 1px solid #333;
  border-radius: 8px;
  padding: 10px;
  font-size: 12px;
  color: #aaffaa;
  overflow-y: auto;
  z-index: 9999;
}
</style>
</head>
<body>

<div id="debugPanel">Debug Log:</div>

<div class="wrap">
  <aside class="card sidebar">
    <div class="logo">
      <img src="https://raw.githubusercontent.com/Carrew/Earnlibr-/refs/heads/main/1000115452-01.jpeg" alt="logo">
      <div>
        <h2>EarnLibr</h2>
        <div style="font-size:12px;color:var(--muted);">Provider Panel</div>
      </div>
    </div>
    <nav class="nav">
      <a id="nav-dashboard">Dashboard</a>
      <a id="nav-offers">Offers</a>
      <a id="nav-create" class="active">Create Offer</a>
      <a id="nav-notifs">Notifications</a>
    </nav>
    <div class="profile">
      <div id="avatar" class="avatar">P</div>
      <div>
        <div id="providerName" style="font-weight:700;">Loading...</div>
        <div id="providerEmail" class="muted">—</div>
      </div>
      <div style="margin-left:auto">
        <button id="logoutBtn" class="btn" style="padding:6px 10px;">Logout</button>
      </div>
    </div>
  </aside>

  <main class="main card">
    <h1>Create a New Offer</h1>
    <form id="offerForm">
      <label>Title</label>
      <input type="text" id="title" required />
      <label>Description</label>
      <textarea id="description" required></textarea>
      <label>Category</label>
      <select id="category" required>
        <option value="">Select category</option>
        <option>Digital Service</option>
        <option>Physical Product</option>
        <option>Course / Training</option>
        <option>Consultation</option>
        <option>Other</option>
      </select>
      <label>Currency</label>
      <select id="currency" required></select>
      <label>Price</label>
      <input type="number" id="price" required />
      <label>Commission Type</label>
      <select id="commissionType" required>
        <option value="fixed">Fixed</option>
        <option value="percentage">Percentage</option>
      </select>
      <label>Commission Value</label>
      <input type="number" id="commissionValue" required />
      <label>Promotion Budget</label>
      <input type="number" id="promotionBudget" required />
      <label>Total Products Available</label>
      <input type="number" id="totalProducts" required />
      <label>Upload Product Image</label>
      <input type="file" id="productImage" accept="image/*" />
      <img id="imagePreview" alt="Preview" />
      <button type="submit" id="submitBtn">Submit Offer for Verification</button>
    </form>
  </main>
</div>

<script type="module" src="currencies.js"></script>

<script type="module">
/*********************************
     GLOBAL DEBUG LOGGER
*********************************/
function LOG(...msg) {
  console.log("[DEBUG]", ...msg);

  const panel = document.getElementById("debugPanel");
  if (panel) {
    const line = document.createElement("div");
    line.textContent = msg.join(" ");
    panel.appendChild(line);
    panel.scrollTop = panel.scrollHeight;
  }

  // Optional: Enable this to log to Firestore
  // addDoc(collection(db, "debug_logs"), { time: Date.now(), msg });
}

/*********************************
        FIREBASE IMPORTS
*********************************/
import { auth, db } from "./firebase.js";
import {
  collection, addDoc
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

import {
  signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

/*********************************
          ELEMENTS
*********************************/
const providerNameEl = document.getElementById('providerName');
const providerEmailEl = document.getElementById('providerEmail');
const avatarEl = document.getElementById('avatar');

const imageInput = document.getElementById('productImage');
const imagePreview = document.getElementById('imagePreview');
const offerForm = document.getElementById("offerForm");
const submitBtn = document.getElementById("submitBtn");

let imageBase64 = "";
let userSession = null;

/*********************************
     NOTIFICATION SYSTEM
*********************************/
function showNotification(message, type='info', duration=3000) {
  const notif = document.createElement('div');
  notif.className = `notification ${type}`;
  notif.textContent = message;
  offerForm.prepend(notif);
  setTimeout(() => notif.remove(), duration);
}

/*********************************
      SESSION VALIDATION
*********************************/
LOG("Checking user session...");

const userSessionRaw = localStorage.getItem('userSession');

if (!userSessionRaw) {
  LOG("No session found → redirecting");
  window.location.href = 'login.html';
  throw new Error('No session');
}

userSession = JSON.parse(userSessionRaw);
LOG("Loaded session:", userSession);

if (userSession.role !== 'provider') {
  LOG("Invalid role:", userSession.role);
  localStorage.removeItem('userSession');
  window.location.href = 'login.html';
}

/*********************************
     AUTH STATE LISTENER
*********************************/
onAuthStateChanged(auth, (user) => {
  LOG("Auth change:", user);

  if (!user || user.uid !== userSession.uid || !user.emailVerified) {
    LOG("User invalid or not verified");
    localStorage.removeItem('userSession');
    window.location.href = 'login.html';
  } else {
    providerNameEl.textContent = userSession.name || 'Provider';
    providerEmailEl.textContent = userSession.email || '';
    avatarEl.textContent = (userSession.name || 'P').charAt(0).toUpperCase();
    attachHandlers();
  }
});

/*********************************
        IMAGE COMPRESSION
*********************************/
function compressImage(file, maxSizeMB = 2) {
  LOG("Compressing image:", file.name);

  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = event => {
      const img = new Image();
      img.src = event.target.result;

      img.onload = () => {
        LOG("Image loaded for compression");

        const canvas = document.createElement('canvas');
        let ratio = 1;

        const compress = () => {
          canvas.width = img.width * ratio;
          canvas.height = img.height * ratio;

          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

          canvas.toBlob(blob => {
            LOG("Compression attempt — size:", blob.size);

            if (blob.size / 1024 / 1024 > maxSizeMB && ratio > 0.2) {
              ratio *= 0.7;
              compress();
            } else {
              const reader2 = new FileReader();
              reader2.onload = e => resolve(e.target.result);
              reader2.readAsDataURL(blob);
            }
          }, 'image/jpeg', 0.8);
        };

        compress();
      };

      img.onerror = reject;
    };

    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

/*********************************
           HANDLERS
*********************************/
function attachHandlers() {
  LOG("Handlers attached");

  document.getElementById('nav-dashboard').onclick = () => location.href='provider-dashboard.html';
  document.getElementById('nav-offers').onclick = () => location.href='manage-offers.html';
  document.getElementById('nav-notifs').onclick = () => location.href='notifications.html';

  document.getElementById('logoutBtn').onclick = async () => {
    LOG("Logging out...");
    await signOut(auth);
    localStorage.removeItem('userSession');
    location.href='login.html';
  };

  populateCurrencyDropdown('currency');

  imageInput.addEventListener("change", async e => {
    const file = e.target.files[0];
    if (!file) return;

    LOG("Image selected:", file.name);
    showNotification("Processing image...", "info");

    try {
      imageBase64 = await compressImage(file);
      LOG("Image compressed");
      imagePreview.src = imageBase64;
      imagePreview.style.display = "block";
    } catch(err) {
      LOG("Image error:", err);
      showNotification("Image processing failed","error");
    }
  });

  /*********************************
         FORM SUBMISSION
  *********************************/
  offerForm.addEventListener("submit", async e => {
    e.preventDefault();
    submitBtn.disabled = true;
    showNotification("Submitting offer...", "info");

    const offerData = {
      providerId: userSession.uid,
      title: title.value.trim(),
      description: description.value.trim(),
      category: category.value,
      currency: currency.value,
      price: Number(price.value),
      commissionType: commissionType.value,
      commissionValue: Number(commissionValue.value),
      promotionBudget: Number(promotionBudget.value),
      totalProducts: Number(totalProducts.value),
      imageTemp: imageBase64 || null,
      status: "pending",
      createdAt: new Date().toISOString()
    };

    LOG("Offer data to submit:", offerData);

    try {
      const ref = await addDoc(collection(db, "offers_pending"), offerData);
      LOG("Firestore success:", ref.id);
      showNotification("Offer submitted!", "success");

      offerForm.reset();
      imagePreview.style.display = "none";
      imageBase64 = "";
    } catch(err) {
      LOG("Firestore ERROR:", err);
      showNotification("Submission error","error");
    }

    submitBtn.disabled = false;
  });
}
</script>
</body>
</html>
