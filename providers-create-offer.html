<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EarnLibr â€” Providers Create Offer</title>
<style>
:root {
  --bg: #0b0d17;
  --card: #0f1724;
  --accent1: #4a90e2;
  --accent2: #a3ff6e;
  --muted: #bfc7d6;
  --danger: #e74c3c;
  --glass: rgba(255, 255, 255, 0.02);
  --glass-2: rgba(255, 255, 255, 0.015);
  --radius: 12px;
}
html, body {
  height:100%;
  margin:0;
  font-family:Inter,system-ui,Arial;
  background: linear-gradient(180deg, #071028 0%, #0b0d17 100%);
  color: #eef2f7;
}
.wrap {
  max-width: 1200px;
  margin: 28px auto;
  padding: 20px;
  display: grid;
  grid-template-columns: 260px 1fr;
  gap: 20px;
}
.card {
  background: linear-gradient(180deg, var(--glass), var(--glass-2));
  border-radius: var(--radius);
  padding: 18px;
  box-shadow: 0 8px 30px rgba(2,6,23,0.6);
  border:1px solid rgba(255,255,255,0.03);
  overflow:hidden;
}
.sidebar {
  height: calc(100vh - 80px);
  display:flex;
  flex-direction:column;
  gap:14px;
  position:sticky;
  top:20px;
}
.logo {
  display:flex;
  gap:12px;
  align-items:center;
  padding-bottom:8px;
  border-bottom:1px solid rgba(255,255,255,0.03);
}
.logo img {
  width:44px;
  height:44px;
  object-fit:cover;
  border-radius:8px;
}
.logo h2 {
  font-size:16px;
  margin:0;
  background:linear-gradient(90deg, var(--accent1), var(--accent2));
  -webkit-background-clip:text;
  color:transparent;
}
.profile {
  margin-top:auto;
  padding-top:10px;
  border-top:1px solid rgba(255,255,255,0.03);
  display:flex;
  gap:12px;
  align-items:center;
}
.avatar {
  width:44px;
  height:44px;
  border-radius:10px;
  background:linear-gradient(90deg, var(--accent1), var(--accent2));
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  color:#041018;
}
.main {
  min-height:80vh;
  display:flex;
  flex-direction:column;
  gap:18px;
  position:relative;
}
h1 {
  font-size:20px;
  background:linear-gradient(90deg, var(--accent1), var(--accent2));
  -webkit-background-clip:text;
  color:transparent;
  margin:0 0 10px 0;
}
form label {
  display:block;
  margin-top:14px;
  color:var(--muted);
  font-size:13px;
}
input, textarea, select {
  width:100%;
  padding:10px 12px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.04);
  background:#071427;
  color:#fff;
  font-size:14px;
  margin-top:4px;
}
textarea { min-height:80px; resize:vertical; }
button {
  margin-top:18px;
  padding:12px;
  border:none;
  border-radius:10px;
  background:linear-gradient(90deg, var(--accent1), var(--accent2));
  font-weight:700;
  color:#041018;
  cursor:pointer;
}
button:disabled {
  opacity:0.6;
  cursor:not-allowed;
}
#submitBtn {
  width:100%;
}
#imagePreview {
  width:100%;
  max-height:220px;
  object-fit:contain;
  border-radius:10px;
  margin-top:8px;
  display:none;
}
.notification {
  position:absolute;
  top:-10px;
  right:0;
  padding:10px 16px;
  border-radius:8px;
  font-weight:700;
  font-size:0.9rem;
  opacity:0.95;
  z-index: 10;
}
.notification.success { background:#4ade80; color:#041018; }
.notification.error { background:#ef4444; color:#fff; }
.notification.info { background:#3b82f6; color:#fff; }

.legal-note {
  font-size:12px;
  color:var(--muted);
  margin-top:8px;
  text-align:left;
}

@media (max-width:980px) {
  .wrap {
    grid-template-columns:1fr;
    padding:14px;
  }
  .sidebar {
    position:relative;
    height:auto;
  }
}
</style>
</head>
<body>

<div class="wrap">
  <aside class="card sidebar">
    <div class="logo">
      <img src="https://raw.githubusercontent.com/Carrew/Earnlibr-/refs/heads/main/1000115452-01.jpeg" alt="logo">
      <div>
        <h2>EarnLibr</h2>
        <div style="font-size:12px;color:var(--muted);">Provider Panel</div>
      </div>
    </div>

    <div class="profile">
      <div id="avatar" class="avatar">P</div>
      <div>
        <div id="providerName" style="font-weight:700;">Loading...</div>
        <div id="providerEmail" class="muted" style="font-size: 11px;">â€”</div>
      </div>
      <div style="margin-left:auto">
        <button id="logoutBtn" style="padding:6px 10px; font-size: 11px; width: auto; margin:0;">Logout</button>
      </div>
    </div>
  </aside>

  <main class="main card">
    <h1>Create a New Offer</h1>
    <form id="offerForm" novalidate>
      <label>Title</label>
      <input
        type="text"
        id="title"
        placeholder="Enter product or service title"
        required
        minlength="3"
      />
      
      <label>Description</label>
      <textarea
        id="description"
        placeholder="Describe your product/service"
        required
        minlength="10"
      ></textarea>
      
      <label>Category</label>
      <select id="category" required>
        <option value="">Select category</option>
        <option>Digital Service</option>
        <option>Physical Product</option>
        <option>Course / Training</option>
        <option>Consultation</option>
        <option>Other</option>
      </select>
      
      <label>Currency</label>
      <select id="currency" required></select>
      
      <label>Price</label>
      <input
        type="number"
        id="price"
        placeholder="Main price"
        required
        min="0.01"
        step="0.01"
      />
      
      <label>Commission Type</label>
      <select id="commissionType" required>
        <option value="fixed">Fixed</option>
        <option value="percentage">Percentage</option>
      </select>
      
      <label>Commission Value</label>
      <input
        type="number"
        id="commissionValue"
        placeholder="e.g., 10 or 5%"
        required
        min="0.01"
        step="0.01"
      />
      
      <label>Promotion Budget</label>
      <input
        type="number"
        id="promotionBudget"
        placeholder="Set your promo budget"
        required
        min="0"
        step="0.01"
      />
      
      <label>Total Products Available</label>
      <input
        type="number"
        id="totalProducts"
        placeholder="How many items available"
        required
        min="1"
        step="1"
      />
      
      <label>Upload Product Image (optional)</label>
      <input type="file" id="productImage" accept="image/*" />
      <img id="imagePreview" alt="Preview" />
      
      <button type="submit" id="submitBtn">Submit Offer for Verification</button>

      <!-- NEW: legal note -->
      <p class="legal-note">
        By submitting this offer, you confirm that all details are accurate and agree to EarnLibrâ€™s
        <a href="/policies/terms.html" target="_blank" style="color:var(--accent2);text-decoration:none;">
          Terms of Service
        </a>,
        including our rules on offers, commissions, cancellations, and payments.
      </p>
    </form>
  </main>
</div>

<script type="module" src="currencies.js"></script>

<script type="module">
import { auth, db } from "./firebase.js";
import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

const providerNameEl = document.getElementById('providerName');
const providerEmailEl = document.getElementById('providerEmail');
const avatarEl = document.getElementById('avatar');
const imageInput = document.getElementById('productImage');
const imagePreview = document.getElementById('imagePreview');
const offerForm = document.getElementById("offerForm");
const submitBtn = document.getElementById("submitBtn");

// Form Inputs
const title = document.getElementById('title');
const description = document.getElementById('description');
const category = document.getElementById('category');
const currency = document.getElementById('currency');
const price = document.getElementById('price');
const commissionType = document.getElementById('commissionType');
const commissionValue = document.getElementById('commissionValue');
const promotionBudget = document.getElementById('promotionBudget');
const totalProducts = document.getElementById('totalProducts');

let userSession = null;
let imageBase64 = "";

// --- Helper Functions ---

async function sendAdminNotification(notifTitle, message) {
  try {
    await addDoc(collection(db, `admin_notifications`), {
      title: notifTitle,
      message: message,
      type: "new_offer",
      createdAt: serverTimestamp(),
      read: false
    });
  } catch(err) {
    console.error("Admin Notification error:", err);
  }
}

function showNotification(message, type='info', duration=4000) {
  const existing = document.querySelector('.notification');
  if (existing) existing.remove();

  const notif = document.createElement('div');
  notif.className = `notification ${type}`;
  notif.textContent = message;
  offerForm.prepend(notif);
  setTimeout(() => notif.remove(), duration);
}

// --- Simple Validation ---

function validateOfferForm() {
  const titleVal = title.value.trim();
  const descVal = description.value.trim();
  const categoryVal = category.value;
  const currencyVal = currency.value;

  const priceVal = parseFloat(price.value);
  const commissionVal = parseFloat(commissionValue.value);
  const promotionVal = parseFloat(promotionBudget.value);
  const totalProductsVal = parseInt(totalProducts.value);

  if (!titleVal || titleVal.length < 3) {
    showNotification("Title must be at least 3 characters.", "error");
    return false;
  }

  if (!descVal || descVal.length < 10) {
    showNotification("Description must be at least 10 characters.", "error");
    return false;
  }

  if (!categoryVal) {
    showNotification("Please select a category.", "error");
    return false;
  }

  if (!currencyVal) {
    showNotification("Please select a currency.", "error");
    return false;
  }

  if (isNaN(priceVal) || priceVal <= 0) {
    showNotification("Price must be greater than 0.", "error");
    return false;
  }

  if (isNaN(commissionVal) || commissionVal <= 0) {
    showNotification("Commission value must be greater than 0.", "error");
    return false;
  }

  if (commissionType.value === "percentage" && (commissionVal <= 0 || commissionVal > 100)) {
    showNotification("Commission percentage must be between 1 and 100.", "error");
    return false;
  }

  if (isNaN(promotionVal) || promotionVal < 0) {
    showNotification("Promotion budget cannot be negative.", "error");
    return false;
  }

  if (isNaN(totalProductsVal) || totalProductsVal < 1) {
    showNotification("Total products must be at least 1.", "error");
    return false;
  }

  return true;
}

// --- Session Verification ---

const userSessionRaw = localStorage.getItem('userSession');
if (!userSessionRaw) {
  window.location.href = 'login.html';
} else {
  try {
    userSession = JSON.parse(userSessionRaw);
    if (!userSession || userSession.role !== 'provider') {
      localStorage.removeItem('userSession');
      window.location.href = 'login.html';
    }
  } catch (e) {
    localStorage.removeItem('userSession');
    window.location.href = 'login.html';
  }
}

onAuthStateChanged(auth, (user) => {
  if (!user || user.uid !== userSession.uid || !user.emailVerified) {
    localStorage.removeItem('userSession');
    window.location.href = 'login.html';
  } else {
    providerNameEl.textContent = userSession.name || 'Provider';
    providerEmailEl.textContent = userSession.email || '';
    avatarEl.textContent = (userSession.name || 'P').charAt(0).toUpperCase();
    attachHandlers();
  }
});

// --- Logic ---

async function compressImage(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.src = e.target.result;
      img.onload = () => {
        const canvas = document.createElement("canvas");
        let width = img.width;
        let height = img.height;
        const maxDim = 800;

        if (width > height && width > maxDim) {
          height *= maxDim / width;
          width = maxDim;
        } else if (height > maxDim) {
          width *= maxDim / height;
          height = maxDim;
        }
        
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, width, height);

        try {
          const dataUrl = canvas.toDataURL("image/jpeg", 0.7);
          resolve(dataUrl);
        } catch (err) {
          reject(err);
        }
      };
      img.onerror = reject;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function attachHandlers() {
  // Logout
  document.getElementById('logoutBtn').onclick = async () => { 
    await signOut(auth); 
    localStorage.removeItem('userSession'); 
    window.location.href='login.html'; 
  };

  // Image preview
  imageInput.addEventListener("change", async e => {
    const file = e.target.files[0];
    if (!file) return;

    if (!file.type.startsWith("image/")) {
      showNotification("Please upload a valid image file.", "error");
      imageInput.value = "";
      return;
    }

    try {
      imageBase64 = await compressImage(file);
      imagePreview.src = imageBase64;
      imagePreview.style.display = "block";
    } catch(err) {
      console.error(err);
      showNotification("Image processing failed.", "error");
    }
  });

  const checkCurrency = setInterval(() => {
    if (currency.options.length > 0) {
      clearInterval(checkCurrency);
      setupFormSubmit();
    }
  }, 300);
}

function setupFormSubmit() {
  offerForm.addEventListener("submit", async e => {
    e.preventDefault();

    submitBtn.disabled = true;
    submitBtn.textContent = "Uploading Offer...";

    // Extra validation before sending to Firestore
    if (!validateOfferForm()) {
      submitBtn.disabled = false;
      submitBtn.textContent = "Submit Offer for Verification";
      return;
    }

    const offerData = {
      providerId: userSession.uid,
      title: title.value.trim(),
      description: description.value.trim(),
      category: category.value,
      currency: currency.value,
      price: parseFloat(price.value) || 0,
      commissionType: commissionType.value,
      commissionValue: parseFloat(commissionValue.value) || 0,
      promotionBudget: parseFloat(promotionBudget.value) || 0,
      totalProducts: parseInt(totalProducts.value) || 0,
      imageTemp: imageBase64 || null,
      status: "pending",
      createdAt: serverTimestamp()
    };

    try {
      await addDoc(collection(db, "offers_pending"), offerData);
      
      await sendAdminNotification(
        "New Offer Submitted ðŸ””",
        `Provider **${userSession.name}** submitted "${offerData.title}" for review.`
      );

      showNotification("Success! Your offer is now pending verification.", "success");
      offerForm.reset();
      imagePreview.style.display = "none";
      imageBase64 = "";
    } catch(err) {
      console.error(err);
      showNotification("Error: Could not save offer. Check your connection.", "error");
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Submit Offer for Verification";
    }
  });
}
</script>
</body>
</html>
