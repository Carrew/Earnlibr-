<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Request Offer | EarnLibr</title>
<style>
:root {
  --bg:#071028; --card:#0f1724; --accent1:#4a90e2;
  --accent2:#a3ff6e; --muted:#cbd5e1; --radius:14px;
}
body {
  margin:0; font-family:sans-serif;
  background:linear-gradient(180deg,var(--bg) 0%,#0b0d17 100%);
  color:#fff; min-height:100vh; display:flex;
  justify-content:center; align-items:flex-start; padding:40px 15px;
}
.container {
  background:var(--card); border-radius:var(--radius);
  box-shadow:0 10px 30px rgba(0,0,0,.4); max-width:700px; width:100%; padding:30px;
}
img { width:100%; height:250px; object-fit:cover; border-radius:var(--radius); background:#1a2235; margin-bottom:20px; }
h1 { background:linear-gradient(90deg,var(--accent1),var(--accent2)); -webkit-background-clip:text; color:transparent; font-size:26px; }
.price-section { display:flex; align-items:baseline; gap:15px; }
.price { font-size:24px; font-weight:700; color:var(--accent2); }
.category { font-size:13px; padding:4px 10px; border-radius:20px; background:rgba(163,255,110,.1); color:var(--accent2); }
.desc { margin:20px 0; color:var(--muted); line-height:1.6; }
form label { margin-top:15px; display:block; font-size:14px; color:var(--muted); }
form input, form textarea { width:100%; margin-top:6px; padding:10px; border-radius:8px; border:1px solid #1a2235; background:#141f33; color:#fff; box-sizing: border-box; }

button { margin-top:25px; width:100%; padding:14px; border:none; border-radius:10px; font-weight:700; cursor:pointer; background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:#041018; transition:opacity 0.2s, transform 0.2s; }
button:hover:not(:disabled) { transform:scale(1.005); }
button:disabled { opacity:.6; cursor:not-allowed; }

.success, .error { margin-top:20px; padding:15px; border-radius:10px; display:none; text-align:center; }
.success { background:rgba(163,255,110,.1); color:var(--accent2); }
.error { background:rgba(239,68,68,.1); color:#ef4444; }
.loading { opacity:.6; pointer-events:none; }

/* ‚ö†Ô∏è Important notice box above the button */
.notice-box {
  margin-top:18px;
  padding:12px 12px 10px;
  border-radius:10px;
  background:rgba(15,23,42,0.85);
  border:1px solid rgba(148,163,184,0.4);
  font-size:12px;
}
.notice-box p {
  margin:0 0 8px;
  color:var(--muted);
}
.notice-box a {
  color:var(--accent2);
  text-decoration:underline;
  font-size:12px;
}
.notice-check {
  display:flex;
  align-items:flex-start;
  gap:8px;
  font-size:12px;
  color:var(--muted);
}
.notice-check input {
  margin-top:2px;
}
</style>
</head>

<body>
<div class="container" id="container">
  <img id="offerImage" src="https://via.placeholder.com/600x300?text=Loading..." />
  <h1 id="offerTitle">Loading offer...</h1>
  <div class="price-section">
    <div class="price" id="offerPrice"></div>
    <div class="category" id="offerCategory"></div>
  </div>
  <div class="desc" id="offerDescription"></div>

  <!-- ‚úÖ UPGRADE: Resume existing deal/chat (shown if found) -->
  <div id="resumeBox" class="notice-box" style="display:none;">
    <p style="margin-bottom:10px;">
      You already started a request for this offer. You can continue the conversation anytime.
    </p>
    <button type="button" id="continueChatBtn" style="margin-top:0;">Continue Chat</button>
  </div>

  <form id="requestForm">
    <label>Quantity <span style="color:#ef4444">*</span></label>
    <input type="number" id="quantity" min="1" value="1" required>

    <label>Full Name <span style="color:#ef4444">*</span></label>
    <input type="text" id="clientName" required>

    <label>Phone Number <span style="color:#ef4444">*</span></label>
    <input type="text" id="clientContact" required placeholder="+231 xxx xxx xxx">

    <label>Message (optional)</label>
    <textarea id="note" placeholder="Any additional info..."></textarea>

    <!-- ‚ö†Ô∏è Important notice shown every time on this page -->
    <div class="notice-box">
      <p>
        Important: For your safety, keep all main communication and payments inside EarnLibr. 
        Do not move the conversation off the platform or send money privately to anyone. 
        A provider may only contact you outside the platform for necessary delivery details (like location or time), 
        but all deal decisions and payment confirmations should stay in EarnLibr chat.
      </p>
      <div class="notice-check">
        <input type="checkbox" id="termsConfirm">
        <label for="termsConfirm">
          I understand these rules and agree to EarnLibr‚Äôs
          <a href="/policies/terms.html" target="_blank" rel="noopener">Terms of Service</a>
          and
          <a href="/policies/privacy.html" target="_blank" rel="noopener">Privacy Policy</a>.
        </label>
      </div>
    </div>

    <button type="submit" id="submitBtn">Request This Offer</button>
  </form>

  <!-- ‚úÖ UPGRADE: Forced success screen (no instant redirect) -->
  <div id="successScreen" class="success" style="display:none;">
    <h3 style="margin:0 0 10px;">Request sent ‚úÖ</h3>
    <p style="margin:0 0 12px; color:#cbd5e1; line-height:1.5;">
      Your conversation continues inside EarnLibr Secure Chat.
      Please keep payments and decisions inside the chat.
    </p>

    <div class="notice-box" style="margin-top:12px; text-align:left;">
      <p style="margin:0 0 10px;">
        Important: Save this link to return to your chat anytime.
      </p>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button type="button" id="continueToChatBtn" style="flex:1; margin-top:0;">
          Continue to Secure Chat
        </button>

        <button type="button" id="copyLinkBtn"
          style="flex:1; margin-top:0; background:#141f33; color:#fff; border:1px solid #1a2235;">
          Copy this page link
        </button>
      </div>

      <div id="copiedHint" style="display:none; margin-top:10px; color:var(--accent2); font-size:12px;">
        Link copied ‚úÖ
      </div>
    </div>
  </div>

  <div class="success" id="successMsg"></div>
  <div class="error" id="errorMsg"></div>
</div>

<script type="module">
import { db } from "./firebase.js";
import {
  doc,
  getDoc,
  collection,
  serverTimestamp,
  writeBatch,
  query,
  where,
  getDocs,
  updateDoc,
  setDoc,
  increment
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const params = new URLSearchParams(window.location.search);
const offerId = params.get("offer");
const promoterId = params.get("promoter") || "direct";

let isSubmitting = false;
let clientId = localStorage.getItem("clientId");
if (!clientId) {
  clientId = "client_" + Math.random().toString(36).slice(2,10);
  localStorage.setItem("clientId", clientId);
}

const form = document.getElementById("requestForm");
const submitBtn = document.getElementById("submitBtn");
const errorMsg = document.getElementById("errorMsg");
const successMsg = document.getElementById("successMsg");
const container = document.getElementById("container");
const termsConfirm = document.getElementById("termsConfirm");

// ‚úÖ UPGRADE refs
const resumeBox = document.getElementById("resumeBox");
const continueChatBtn = document.getElementById("continueChatBtn");
const successScreen = document.getElementById("successScreen");
const continueToChatBtn = document.getElementById("continueToChatBtn");
const copyLinkBtn = document.getElementById("copyLinkBtn");
const copiedHint = document.getElementById("copiedHint");

let offerData, providerId, providerInfo, promoterInfo;

/**
 * ‚úÖ UPGRADE: Increment GLOBAL offer clicks in offers_all/{offerId}
 * - increments clicks
 * - updates lastClickAt
 */
async function incrementGlobalOfferClicks() {
  if (!offerId) return;

  try {
    await updateDoc(doc(db, "offers_all", offerId), {
      clicks: increment(1),
      lastClickAt: serverTimestamp()
    });
  } catch (err) {
    console.error("Failed to increment global clicks:", err);
  }
}

/**
 * üîÑ Update promoter_offers stats when a visitor lands on this page
 * - increments clicks
 * - updates lastClickAt
 * - sets lastSource = "view"
 */
async function updatePromoterStatsOnView() {
  if (!offerId || !promoterId || promoterId === "direct") return;

  const statsRef = doc(db, "promoter_offers", promoterId, "offers", offerId);

  try {
    await updateDoc(statsRef, {
      clicks: increment(1),
      lastClickAt: serverTimestamp(),
      lastSource: "view"
    });
  } catch (err) {
    // If doc doesn't exist yet (edge case), create a minimal one
    try {
      await setDoc(
        statsRef,
        {
          offerId,
          promoterId,
          title: offerData?.title || "Untitled Offer",
          imageUrl: offerData?.imageUrl || "",
          status: offerData?.status || "active",
          clicks: 1,
          lastClickAt: serverTimestamp(),
          lastSource: "view",
          createdAt: serverTimestamp()
        },
        { merge: true }
      );
    } catch (err2) {
      console.error("Failed to create/update promoter stats on view:", err2);
    }
  }
}

/**
 * ‚úÖ UPGRADE: If user already has pending/active deal, show "Continue Chat"
 */
async function checkExistingDealAndShowResume() {
  if (!offerId) return;

  try {
    const q = query(
      collection(db, "deals"),
      where("clientId","==",clientId),
      where("offerId","==",offerId),
      where("status","in",["pending","active"])
    );
    const existing = await getDocs(q);

    if (!existing.empty) {
      const dealId = existing.docs[0].id;
      resumeBox.style.display = "block";
      continueChatBtn.onclick = () => {
        window.location.href = `client-chat.html?deal=${dealId}&client=${clientId}`;
      };
    }
  } catch (e) {
    console.error("Resume check failed:", e);
  }
}

async function loadOffer() {
  if (!offerId) {
    document.getElementById("offerTitle").textContent = "Invalid or missing offer link.";
    form.style.display = "none";
    return;
  }

  try {
    const snap = await getDoc(doc(db, "offers_all", offerId));
    if (!snap.exists()) {
      document.getElementById("offerTitle").textContent = "Offer not found (404).";
      document.getElementById("offerImage").src = "https://via.placeholder.com/600x300?text=Offer+Not+Found";
      form.style.display = "none";
      return;
    }

    offerData = snap.data();
    if (!offerData.verified || offerData.status !== "active") {
      document.getElementById("offerTitle").textContent = "This offer is currently unavailable.";
      document.getElementById("offerImage").src = "https://via.placeholder.com/600x300?text=Unavailable";
      form.style.display = "none";
      return;
    }

    providerId = offerData.providerId || "unknown";
    if (providerId !== "unknown") {
      const pSnap = await getDoc(doc(db, "users", providerId));
      providerInfo = pSnap.exists() ? pSnap.data() : null;
    }

    if (promoterId !== "direct") {
      const prSnap = await getDoc(doc(db, "users", promoterId));
      promoterInfo = prSnap.exists() ? prSnap.data() : null;
    }

    document.getElementById("offerImage").src = offerData.imageUrl || "https://via.placeholder.com/600x300?text=Offer+Image";
    document.getElementById("offerTitle").textContent = offerData.title || "Untitled Offer";
    document.getElementById("offerPrice").textContent = `${offerData.currency || "$"} ${offerData.price || "N/A"}`;
    document.getElementById("offerDescription").textContent = offerData.description || "No description available.";
    document.getElementById("offerCategory").textContent = offerData.category || "Uncategorized";

    // ‚úÖ UPGRADE: Increment global clicks once the offer is valid/loaded
    await incrementGlobalOfferClicks();

    // ‚úÖ Existing: track promoter view/click
    await updatePromoterStatsOnView();

    // ‚úÖ UPGRADE: show resume option if existing deal found
    await checkExistingDealAndShowResume();

  } catch(err) {
    console.error(err);
    document.getElementById("offerTitle").textContent = "Error loading offer. Check console.";
    form.style.display = "none";
  }
}
loadOffer();

form.addEventListener("submit", async e => {
  e.preventDefault();
  if (isSubmitting) return;

  // ‚úÖ Make sure user has seen/accepted the notice every time
  if (!termsConfirm.checked) {
    errorMsg.textContent = "Please confirm you understand the safety rules and agree to the Terms before requesting this offer.";
    errorMsg.style.display = "block";
    window.scrollTo({ top: 0, behavior: "smooth" });
    return;
  }

  isSubmitting = true;
  submitBtn.disabled = true;
  submitBtn.textContent = "Processing...";
  container.classList.add("loading");
  errorMsg.style.display = "none";

  const quantity = Number(document.getElementById("quantity").value) || 1;
  const clientName = document.getElementById("clientName").value.trim();
  const clientContact = document.getElementById("clientContact").value.trim();
  const note = document.getElementById("note").value.trim();

  if (!clientName || !clientContact || quantity < 1) {
    errorMsg.textContent = "Please fill in all required fields with a valid quantity (min 1).";
    errorMsg.style.display = "block";
    isSubmitting = false;
    submitBtn.disabled = false;
    submitBtn.textContent = "Request This Offer";
    container.classList.remove("loading");
    return;
  }

  try {
    // DUPLICATE CHECK ‚Äî redirect to chat if existing deal active/pending
    const q = query(
      collection(db, "deals"),
      where("clientId","==",clientId),
      where("offerId","==",offerId),
      where("status","in",["pending","active"])
    );
    const existing = await getDocs(q);
    if (!existing.empty) {
      window.location.href = `client-chat.html?deal=${existing.docs[0].id}&client=${clientId}`;
      return;
    }

    const batch = writeBatch(db);
    const dealRef = doc(collection(db, "deals"));
    const dealId = dealRef.id;
    const promoterName = promoterId === "direct" ? "Direct Lead" : (promoterInfo?.name || "Referral Promoter");

    const dealData = {
      offerId,
      offerTitle: offerData.title,
      offerPrice: offerData.price,
      offerCurrency: offerData.currency || "$",
      providerId,
      promoterId,
      clientId,
      clientName,
      clientContact,
      note,
      quantity,
      status: "pending",
      providerName: providerInfo?.name || "",
      providerEmail: providerInfo?.email || "",
      providerPhone: providerInfo?.phone || "",
      commissionType: offerData.commissionType || "",
      commissionValue: offerData.commissionValue || 0,
      promoterName,
      createdAt: serverTimestamp()
    };
    batch.set(dealRef, dealData);

    // CHAT CREATION WITH SYSTEM MESSAGE
    const chatRef = doc(db, "chats", dealId);
    batch.set(chatRef, {
      dealId, providerId, clientId,
      participants: { providerId, clientId },
      clientInfo: { name: clientName, contact: clientContact },
      lastMessage: { 
        text: "üîí EarnLibr Secure Conversation. This chat is monitored and recorded by EarnLibr. Messages may be reviewed only to resolve disputes and ensure fairness.", 
        sender: "system", timestamp: serverTimestamp() 
      },
      status: "active",
      createdAt: serverTimestamp()
    });
    const firstMsgRef = doc(collection(chatRef, "messages"));
    batch.set(firstMsgRef, {
      text: "üîí EarnLibr Secure Conversation. This chat is monitored and recorded by EarnLibr. Messages may be reviewed only to resolve disputes and ensure fairness. Please keep payments and important decisions inside this chat.",
      sender: "system",
      timestamp: serverTimestamp()
    });

    // NOTIFICATIONS
    batch.set(doc(collection(db, "admin_notifications")), {
      message: `${clientName} requested ${quantity} unit(s) of "${dealData.offerTitle}" (Referred by ${promoterName})`,
      type:"deal", dealId, ...dealData, createdAt: serverTimestamp()
    });
    if (providerId !== "unknown") {
      batch.set(doc(collection(db, "notifications", providerId, "items")), {
        title:"New Deal Request",
        message:`Request for ${quantity}x ${dealData.offerTitle}. Source: ${promoterName}`,
        type:"deal", dealId, ...dealData, createdAt: serverTimestamp()
      });
    }
    if (promoterId !== "direct") {
      batch.set(doc(collection(db, "notifications", promoterId, "items")), {
        title:"You Generated a Deal!",
        message:`Your shared link converted into a deal for ${quantity} unit(s) of "${dealData.offerTitle}, you earn once this deal is completed".`,
        type:"deal", dealId, ...dealData, createdAt: serverTimestamp()
      });
    }

    // ‚úÖ Update promoter_offers stats for this conversion (only if it's not a direct lead)
    if (promoterId !== "direct") {
      const statsRef = doc(db, "promoter_offers", promoterId, "offers", offerId);
      batch.set(
        statsRef,
        {
          offerId,
          promoterId,
          title: offerData.title || "Untitled Offer",
          imageUrl: offerData.imageUrl || "",
          status: offerData.status || "active",
          lastDealAt: serverTimestamp(),
          lastActionAt: serverTimestamp(),
          lastSource: "deal",
          dealsCount: increment(1),
          totalQuantity: increment(quantity)
        },
        { merge: true }
      );
    }

    await batch.commit();

    // ‚úÖ UPGRADE: Force success screen + 3s delay (no instant redirect)
    form.style.display = "none";
    errorMsg.style.display = "none";
    successMsg.style.display = "none";
    container.classList.remove("loading");
    successScreen.style.display = "block";
    window.scrollTo({ top: 0, behavior: "smooth" });

    const chatUrl = `client-chat.html?deal=${dealId}&client=${clientId}`;

    // Copy the current page link (so they can return)
    copyLinkBtn.onclick = async () => {
      try {
        await navigator.clipboard.writeText(window.location.href);
        copiedHint.style.display = "block";
        setTimeout(() => (copiedHint.style.display = "none"), 2000);
      } catch (e) {
        prompt("Copy this link:", window.location.href);
      }
    };

    // 3-second forced read delay
    continueToChatBtn.disabled = true;
    let t = 3;
    continueToChatBtn.textContent = `Continue to Secure Chat (${t})`;
    const timer = setInterval(() => {
      t--;
      if (t <= 0) {
        clearInterval(timer);
        continueToChatBtn.disabled = false;
        continueToChatBtn.textContent = "Continue to Secure Chat";
      } else {
        continueToChatBtn.textContent = `Continue to Secure Chat (${t})`;
      }
    }, 1000);

    continueToChatBtn.onclick = () => {
      window.location.href = chatUrl;
    };

    // Reset submit UI state (in case user navigates back without refresh)
    isSubmitting = false;
    submitBtn.disabled = false;
    submitBtn.textContent = "Request This Offer";

  } catch(err) {
    console.error(err);
    errorMsg.textContent = "Error submitting request: " + (err.message || "Please try again later.");
    errorMsg.style.display = "block";
    window.scrollTo({top:0, behavior:"smooth"});
    isSubmitting = false;
    submitBtn.disabled = false;
    submitBtn.textContent = "Request This Offer";
    container.classList.remove("loading");
  }
});
</script>
</body>
</html>
