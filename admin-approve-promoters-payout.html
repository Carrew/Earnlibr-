<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EarnLibr ‚Äî Admin Approve Promoter Payouts</title>
<style>
:root{
  --bg:#0b0d17;
  --card:#0f1724;
  --accent1:#4a90e2;
  --accent2:#a3ff6e;
  --muted:#bfc7d6;
  --danger:#e74c3c;
  --success:#4ade80;
  --radius:12px;
}

body{
  margin:0;
  font-family:Inter,system-ui,Arial;
  background:radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
  color:#eef2f7;
  min-height:100vh;
  padding:20px;
}

.page-wrap {
  max-width: 960px;
  margin: 0 auto;
}

/* Header */
h1{
  font-size:24px;
  margin:0 0 6px 0;
  background:linear-gradient(90deg,var(--accent1),var(--accent2));
  -webkit-background-clip:text;
  color:transparent;
}

.page-subtitle{
  font-size:13px;
  color:var(--muted);
  margin-bottom:14px;
}

/* Global notification */
.notif{
  background:#071427;
  padding:10px 12px;
  border-radius:10px;
  margin-bottom:15px;
  display:none;
  font-size:13px;
  border:1px solid rgba(148,163,184,0.4);
}
.notif.success{border-left:4px solid var(--success); color:#bbf7d0;}
.notif.error{border-left:4px solid var(--danger); color:#fecaca;}
.notif.info{border-left:4px solid var(--accent1); color:#bfdbfe;}

/* Controls */
.controls{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:16px;
  padding:12px 14px;
  background:#111827;
  border-radius:var(--radius);
  border:1px solid rgba(148,163,184,0.35);
  font-size:13px;
}
.controls span.label {
  color:var(--muted);
}

/* Buttons */
.btn{
  background:linear-gradient(90deg,var(--accent1),var(--accent2));
  border:none;
  padding:8px 14px;
  border-radius:999px;
  cursor:pointer;
  font-weight:700;
  color:#041018;
  font-size:12px;
  display:inline-flex;
  align-items:center;
  gap:6px;
  box-shadow:0 8px 20px rgba(15,118,255,0.4);
  transition: all 0.2s ease;
}
.btn span.icon { font-size:13px; }

.btn:hover:not(:disabled){
  opacity:0.92;
  transform:translateY(-1px);
}

.btn:disabled{
  opacity:0.55;
  cursor:not-allowed;
  box-shadow:none;
}

.btn.danger{
  background:transparent;
  border:1px solid var(--danger);
  color:#fecaca;
  box-shadow:none;
}
.btn.danger:hover:not(:disabled){
  background:rgba(231,76,60,0.16);
  box-shadow:0 6px 16px rgba(231,76,60,0.35);
}

.btn-all {
  background:#3b82f6;
  color:#fff;
}

/* Requests container */
#requestsContainer {
  margin-top:10px;
}

/* Request card */
.request-card{
  background:#071427;
  border-radius:12px;
  padding:14px 14px 12px;
  margin-bottom:12px;
  border:1px solid rgba(255,255,255,0.04);
  box-shadow:0 10px 25px rgba(15,23,42,0.7);
  transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.25s ease;
}
.request-card:hover {
  transform: translateY(-2px);
  box-shadow:0 14px 35px rgba(15,23,42,0.9);
}

.request-card.completed,
.request-card.rejected{
  opacity:0.55;
  pointer-events:none;
}

.request-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:6px;
}
.request-title {
  font-size:13px;
  font-weight:600;
  color:#f9fafb;
}

.status-pill {
  padding:3px 8px;
  border-radius:999px;
  font-size:10px;
  text-transform:uppercase;
  letter-spacing:0.05em;
  border:1px solid rgba(148,163,184,0.6);
  color:#fde68a;
}

.request-card div.line{
  font-size:13px;
  margin-bottom:4px;
  color:var(--muted);
}
.request-card div.line strong{
  color:#e5e7eb;
}

.request-meta {
  margin-top:6px;
  font-size:11px;
  color:var(--muted);
}

.request-actions{
  margin-top:10px;
  display:flex;
  gap: 8px;
}

/* Skeletons */
.skeleton-card {
  background: linear-gradient(180deg, rgba(15,23,42,0.9), rgba(15,23,42,0.95));
  border-radius: var(--radius);
  padding: 14px 14px 10px;
  margin-bottom: 10px;
  position: relative;
  overflow: hidden;
  border: 1px solid rgba(30,64,175,0.4);
}
.skeleton-line {
  height: 10px;
  border-radius: 999px;
  background: #1f2937;
  margin-bottom: 8px;
  position: relative;
  overflow: hidden;
}
.skeleton-line.short { width: 40%; }
.skeleton-line.medium { width: 65%; }
.skeleton-line.long { width: 90%; }
.skeleton-line::before {
  content:'';
  position:absolute;
  inset:0;
  background: linear-gradient(90deg,
    rgba(31,41,55,0) 0%,
    rgba(55,65,81,0.9) 50%,
    rgba(31,41,55,0) 100%
  );
  transform:translateX(-100%);
  animation: shimmer 1.2s infinite;
}
@keyframes shimmer {
  100% { transform: translateX(100%); }
}

/* Empty state */
.empty-state {
  padding:20px 18px;
  border-radius:var(--radius);
  background:rgba(15,23,42,0.9);
  border:1px dashed rgba(148,163,184,0.5);
  font-size:13px;
  color:var(--muted);
}
.empty-state strong {
  color:#e5e7eb;
  display:block;
  margin-bottom:4px;
}
</style>
</head>

<body>
<div class="page-wrap">
  <h1>Approve Promoter Payouts</h1>
  <p class="page-subtitle">Review, approve, or reject promoter withdrawal requests.</p>

  <div id="notif" class="notif"></div>

  <div class="controls">
    <span class="label">Action Center: Approve or reject pending promoter payout requests.</span>
    <button id="approveAllBtn" class="btn btn-all">
      <span class="icon">‚úÖ</span><span>Approve All</span>
    </button>
  </div>

  <div id="requestsContainer" class="requests">
    <!-- Skeletons or requests will be injected here -->
  </div>
</div>

<script type="module">
import { auth, db } from './firebase.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { 
  collection, doc, onSnapshot, serverTimestamp, writeBatch,
  query, where, runTransaction, getDoc
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const requestsContainer = document.getElementById("requestsContainer");
const notif = document.getElementById("notif");
const approveAllBtn = document.getElementById("approveAllBtn");

let userSession = null;
let requestsList = [];
let skeletonContainer = null;

// --- Notifications ---
const showNotif = (msg,type="success")=>{
  notif.textContent = msg;
  notif.className = `notif ${type}`;
  notif.style.display = "block";
  setTimeout(()=>{ notif.style.display="none"; },4000);
};

// --- Skeleton helpers ---
function createSkeletonCard() {
  const card = document.createElement("div");
  card.className = "skeleton-card";
  card.innerHTML = `
    <div class="skeleton-line medium"></div>
    <div class="skeleton-line long"></div>
    <div class="skeleton-line short"></div>
  `;
  return card;
}

function showSkeleton(count = 3) {
  hideSkeleton();
  skeletonContainer = document.createElement("div");
  for (let i = 0; i < count; i++) {
    skeletonContainer.appendChild(createSkeletonCard());
  }
  requestsContainer.innerHTML = "";
  requestsContainer.appendChild(skeletonContainer);
}

function hideSkeleton() {
  if (skeletonContainer && skeletonContainer.parentNode) {
    skeletonContainer.parentNode.removeChild(skeletonContainer);
  }
  skeletonContainer = null;
}

// --- Notification Helper (Batch) ---
async function sendNotification(uid, title, message) {
  try {
    const batch = writeBatch(db);
    batch.set(doc(collection(db, `notifications/${uid}/items`)), {
      title,
      message,
      createdAt: serverTimestamp(),
      read: false
    });
    await batch.commit();
  } catch(err) {
    console.error("Batch notification error:", err);
  }
}

// --- AUTH CHECK & ROLE ENFORCEMENT ---
let rawSession = localStorage.getItem("userSession");
if(!rawSession){
  window.location.href="login.html";
  throw new Error("No session");
}

try {
  userSession = JSON.parse(rawSession);
} catch(e) {
  localStorage.removeItem("userSession");
  window.location.href="login.html";
  throw e;
}

onAuthStateChanged(auth, async user=>{
  if(!user || user.uid !== userSession.uid || !user.emailVerified){ 
    localStorage.removeItem("userSession"); 
    window.location.href="login.html"; 
    return; 
  }
  
  // Verify Admin Role from Firestore
  try {
    const adminDoc = await getDoc(doc(db, "admins", user.uid));
    const data = adminDoc.exists() ? adminDoc.data() : null;
    const role = data?.role || "guest";

    if (!["admin","super_admin"].includes(role)) { 
      localStorage.removeItem("userSession"); 
      window.location.href="login.html"; 
      return;
    }

    userSession = { uid: user.uid, name: data?.name || user.email, email: user.email, role };
    localStorage.setItem("userSession", JSON.stringify(userSession));

    loadWithdrawalRequests();
  } catch (err) {
    console.error("Auth / role error:", err);
    localStorage.removeItem("userSession");
    window.location.href="login.html";
  }
});

// --- LOAD PENDING REQUESTS ---
function loadWithdrawalRequests(){
  showSkeleton(3);

  const requestsQuery = query(
    collection(db, "withdrawal-requests"),
    where("status", "==", "pending")
  );
  
  let firstSnapshot = true;

  onSnapshot(requestsQuery, snapshot=>{
    if (firstSnapshot) {
      hideSkeleton();
      firstSnapshot = false;
    }

    requestsContainer.innerHTML = "";
    requestsList = [];

    if(snapshot.empty) {
      requestsContainer.innerHTML = `
        <div class="empty-state">
          <strong>No pending withdrawal requests.</strong>
          When promoters request payouts, they will appear here for your approval.
        </div>
      `;
      return;
    }

    snapshot.docs.forEach(docSnap=>{
      const request = docSnap.data();
      renderRequestCard(docSnap.id, request);
    });
  }, (err) => {
    console.error("Withdrawal requests snapshot error:", err);
    hideSkeleton();
    requestsContainer.innerHTML = `
      <div class="empty-state">
        <strong>Failed to load withdrawal requests.</strong>
        Please refresh the page or check your connection.
      </div>
    `;
    showNotif("Failed to load withdrawal requests.", "error");
  });
}

function renderRequestCard(id, request) {
  const card = document.createElement("div");
  card.className = "request-card";

  const amountNumber = typeof request.amount === "number"
    ? request.amount
    : parseFloat(request.amount || 0);
  const safeAmount = isNaN(amountNumber) ? 0 : amountNumber;

  const currency = request.currency || "USD";
  const dealsCount = Array.isArray(request.dealIds) ? request.dealIds.length : 0;
  const requestedAt = request.requestedAt && typeof request.requestedAt.toDate === "function"
    ? request.requestedAt.toDate().toLocaleString()
    : "N/A";

  card.innerHTML = `
    <div class="request-header">
      <div class="request-title">Payout Request</div>
      <div class="status-pill">PENDING</div>
    </div>
    <div class="line"><strong>Request ID:</strong> ${request.withdrawalRequestId || id}</div>
    <div class="line"><strong>Promoter ID:</strong> ${request.promoterId}</div>
    <div class="line">
      <strong>Amount:</strong>
      <span style="color:var(--accent2);">${safeAmount.toFixed(2)} ${currency}</span>
    </div>
    <div class="line"><strong>Deals Count:</strong> ${dealsCount}</div>
    <div class="line"><strong>Requested:</strong> ${requestedAt}</div>
    <div class="request-meta">
      Check that the requested amount matches the promoter's cleared earnings before approving.
    </div>
  `;

  const actions = document.createElement("div");
  actions.className = "request-actions";

  const approveBtn = document.createElement("button");
  approveBtn.className = "btn";
  approveBtn.innerHTML = `<span class="icon">üí∏</span><span>Approve Payout</span>`;

  const rejectBtn = document.createElement("button");
  rejectBtn.className = "btn danger";
  rejectBtn.innerHTML = `<span class="icon">‚ùå</span><span>Reject Payout</span>`;

  approveBtn.onclick = () =>
    approvePayout(id, request.promoterId, safeAmount, currency, request.dealIds || [], approveBtn, card);

  rejectBtn.onclick = () =>
    handleReject(id, request.promoterId, safeAmount, currency, request.dealIds || [], rejectBtn, card);

  actions.appendChild(rejectBtn);
  actions.appendChild(approveBtn);
  card.appendChild(actions);

  requestsContainer.appendChild(card);

  // Track for "Approve All"
  requestsList.push({
    id,
    promoterId: request.promoterId,
    amount: safeAmount,
    currency,
    dealIds: request.dealIds || [],
    btn: approveBtn,
    card
  });
}

// --- Helper to get reason for rejection ---
function handleReject(requestId, promoterId, amount, currency, dealIds, btn, card) {
  const confirmReject = confirm(`Reject this payout request for ${amount.toFixed(2)} ${currency}?`);
  if (!confirmReject) return;

  const reason = prompt("Please provide a reason for rejecting this payout request:");
  if (reason && reason.trim()) {
    rejectPayout(requestId, promoterId, amount, currency, dealIds, btn, card, reason.trim());
  } else {
    showNotif("Rejection cancelled. A reason is required.", "error");
  }
}

// --- REJECT Payout (ATOMIC FUNCTION) ---
async function rejectPayout(requestId, promoterId, amount, currency, dealIds, btn, card, rejectionReason){
  btn.disabled = true;
  const originalText = btn.innerHTML;
  btn.innerHTML = `<span class="icon">‚è≥</span><span>Reversing...</span>`;
  
  const metaRef = doc(db, "promoter-earnings", promoterId, "metadata", "summary");
  const dealsCollectionRef = collection(db, "promoter-earnings", promoterId, "deals");
  const requestRef = doc(db, "withdrawal-requests", requestId);

  try {
    await runTransaction(db, async (t) => {
      // 1. Get metadata
      const metaSnap = await t.get(metaRef);
      if (!metaSnap.exists()) throw new Error("Promoter metadata not found. Cannot reverse funds.");
      const meta = metaSnap.data();
      const currentBalance = meta.currentBalance?.[currency] || 0;

      // 2. Get request and ensure still pending
      const reqSnap = await t.get(requestRef);
      if (!reqSnap.exists()) throw new Error("Withdrawal request not found.");
      if (reqSnap.data().status !== "pending") throw new Error("Request already processed.");

      // 3. Update request status
      const requestUpdateData = { 
        status: "rejected",
        adminProcessedAt: serverTimestamp(),
        adminProcessedBy: userSession.uid,
        rejectionReason
      };
      t.update(requestRef, requestUpdateData);

      // 4. Clear withdrawal flags from deals
      (dealIds || []).forEach(dealId => {
        t.update(doc(dealsCollectionRef, dealId), {
          withdrawalRequestId: null,
          withdrawalRequestedAt: null 
        });
      });

      // 5. Return funds to currentBalance
      const newBalance = currentBalance + amount;
      t.update(metaRef, {
        [`currentBalance.${currency}`]: newBalance,
      });
    });

    await sendNotification(
      promoterId,
      "Payout Request Rejected ‚ùå",
      `Your withdrawal request for ${amount.toFixed(2)} ${currency} was rejected.\nReason: ${rejectionReason}\nThe funds have been returned to your available balance.`
    );

    card.classList.add("rejected");
    btn.innerHTML = `<span class="icon">‚ùå</span><span>Rejected</span>`;
    showNotif(`Request ${requestId} rejected and funds reversed.`, "success");

  } catch(err){
    console.error("Payout rejection failed:", err);
    showNotif(`Rejection Failed: ${err.message}`, "error");
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

// --- APPROVE Payout (ATOMIC FUNCTION) ---
async function approvePayout(requestId, promoterId, amount, currency, dealIds, btn, card){
  if (!dealIds || dealIds.length === 0) {
    showNotif("Error: Request has no linked deals.", "error");
    return;
  }

  const confirmApprove = confirm(
    `Approve payout of ${amount.toFixed(2)} ${currency} for promoter ${promoterId}?`
  );
  if (!confirmApprove) return;

  btn.disabled = true;
  const originalText = btn.innerHTML;
  btn.innerHTML = `<span class="icon">‚è≥</span><span>Processing...</span>`;
  
  const metaRef = doc(db, "promoter-earnings", promoterId, "metadata", "summary");
  const dealsCollectionRef = collection(db, "promoter-earnings", promoterId, "deals");
  const requestRef = doc(db, "withdrawal-requests", requestId);

  try {
    await runTransaction(db, async (t) => {
      // Metadata
      const metaSnap = await t.get(metaRef);
      if (!metaSnap.exists()) throw new Error("Promoter metadata not found. Cannot finalize payout.");
      const meta = metaSnap.data();
      const currentTotalWithdrawn = meta.totalWithdrawn?.[currency] || 0;
      
      // Request
      const requestSnap = await t.get(requestRef);
      if (!requestSnap.exists()) throw new Error("Withdrawal request not found.");
      if (requestSnap.data().status !== "pending") throw new Error("Request already processed.");

      // 1. Mark request as completed
      const requestUpdateData = { 
        status: "completed",
        adminProcessedAt: serverTimestamp(),
        adminProcessedBy: userSession.uid
      };
      t.update(requestRef, requestUpdateData);

      // 2. Mark deals as withdrawn
      (dealIds || []).forEach(dealId => {
        t.update(doc(dealsCollectionRef, dealId), {
          withdrawn: true,
          withdrawalCompletedAt: serverTimestamp()
        });
      });

      // 3. Update totalWithdrawn
      const newTotalWithdrawn = currentTotalWithdrawn + amount;
      t.update(metaRef, {
        [`totalWithdrawn.${currency}`]: newTotalWithdrawn,
      });
    });

    await sendNotification(
      promoterId,
      "Payout Complete! üí∏",
      `Your withdrawal request for ${amount.toFixed(2)} ${currency} has been approved and processed.`
    );

    card.classList.add("completed");
    btn.innerHTML = `<span class="icon">‚úÖ</span><span>Completed</span>`;
    showNotif(`Payout completed successfully for Request ID: ${requestId}`, "success");

  } catch(err){
    console.error("Payout approval failed:", err);
    showNotif(`Payout Failed: ${err.message}`, "error");
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

// --- Approve all concurrently ---
approveAllBtn.onclick = async () => {
  const activeRequests = requestsList.filter(
    r => !r.btn.disabled && !r.card.classList.contains("completed") && !r.card.classList.contains("rejected")
  );

  if(activeRequests.length === 0) {
    showNotif("No pending requests to approve.", "error");
    return;
  }

  const confirmed = confirm(
    `Approve all ${activeRequests.length} pending payout request(s)?`
  );
  if (!confirmed) return;

  approveAllBtn.disabled = true;
  const original = approveAllBtn.innerHTML;
  approveAllBtn.innerHTML = `<span class="icon">‚è≥</span><span>Approving All...</span>`;
  showNotif(`Attempting to process ${activeRequests.length} payouts...`, "info");

  let successCount = 0;
  let failCount = 0;

  for (const r of activeRequests) {
    // Approve one by one so confirmations & errors are clear
    try {
      await approvePayout(r.id, r.promoterId, r.amount, r.currency, r.dealIds, r.btn, r.card);
      successCount++;
    } catch {
      failCount++;
    }
  }

  approveAllBtn.disabled = false;
  approveAllBtn.innerHTML = original;

  if (successCount && !failCount) {
    showNotif(`Successfully approved ${successCount} payout(s).`, "success");
  } else if (successCount && failCount) {
    showNotif(`Approved ${successCount}, but ${failCount} failed. Check console for details.`, "error");
  } else {
    showNotif("No payouts were approved. Please check errors in the console.", "error");
  }
};
</script>

</body>
</html>
