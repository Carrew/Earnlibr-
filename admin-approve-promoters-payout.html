<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EarnLibr — Admin Approves Promoter Withdrawals</title>
<style>
  :root {
    --bg: #0b0d17;
    --card: #0f1724;
    --accent1: #4a90e2;
    --accent2: #a3ff6e;
    --muted: #bfc7d6;
    --danger: #ef4444;
    --success: #4ade80;
  }
  body { margin: 0; font-family: Inter, system-ui, Arial; background: var(--bg); color: #eef2f7; min-height: 100vh; }
  header { display: flex; align-items: center; justify-content: center; background: linear-gradient(90deg, var(--accent1), var(--accent2)); padding: 20px; color: #041018; }
  header img { height: 50px; margin-right: 15px; }
  header h1 { font-size: 24px; font-weight: bold; }
  .notif { margin: 10px auto; padding: 10px 15px; width: 90%; max-width: 500px; border-radius: 8px; display: none; font-size: 14px; }
  .notif.success { background: var(--card); border-left: 4px solid var(--success); color: var(--success);}
  .notif.error { background: var(--card); border-left: 4px solid var(--danger); color: var(--danger);}
  h1.page-title { text-align: center; margin-top: 20px; margin-bottom: 20px; }
  .request-card { background: var(--card); border-radius: 12px; padding: 15px; margin: 15px auto; max-width: 700px; box-shadow: 0 4px 10px rgba(0,0,0,0.4); }
  .deal-info { font-size: 14px; margin-bottom: 5px; color: var(--muted);}
  .btn { padding: 6px 12px; border-radius: 6px; font-weight: bold; cursor: pointer; border: none; margin-right: 10px; }
  .btn.approve { background: var(--success); color: #041018; }
  .btn.reject { background: var(--danger); color: #fff; }
  .deals-list { background: #1a2235; padding: 10px; border-radius: 8px; margin-top: 10px; }
  .total-request { font-weight: bold; margin-bottom: 8px; }
</style>
</head>
<body>

<header>
  <img src="https://raw.githubusercontent.com/Carrew/Earnlibr-/refs/heads/main/1000115452-01.jpeg" alt="EarnLibr Logo">
  <h1>EarnLibr Admin</h1>
</header>

<div id="notif" class="notif"></div>
<h1 class="page-title">Promoter Withdrawal Requests</h1>
<div id="requestsContainer">Loading withdrawal requests...</div>

<script type="module">
import { db } from './firebase.js';
import { 
  doc, collection, getDoc, query, where, orderBy, onSnapshot, runTransaction 
} from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js';

const notif = document.getElementById('notif');
const container = document.getElementById('requestsContainer');

const showNotif = (msg, type='success') => {
  notif.textContent = msg;
  notif.className = `notif ${type}`;
  notif.style.display = 'block';
  setTimeout(() => notif.style.display = 'none', 4000);
};

// ----- SECURITY: Check admin session -----
const session = JSON.parse(localStorage.getItem('userSession'));
if(!session || session.role !== 'admin'){
  showNotif('⚠ You must be logged in as admin to access this page.', 'error');
  container.innerHTML = '';
  setTimeout(() => window.location.href = 'login.html', 2000);
} else {

  const withdrawalsCol = collection(db, 'withdrawal-requests');
  const q = query(withdrawalsCol, where('status', '==', 'pending'), orderBy('requestedAt', 'desc'));

  onSnapshot(q, snapshot => {
    container.innerHTML = '';
    if(snapshot.empty){
      container.innerHTML = '<p style="text-align:center;">No pending withdrawal requests.</p>';
      return;
    }

    snapshot.docs.forEach(docSnap => renderRequestCard(docSnap.id, docSnap.data()));
  });

  async function renderRequestCard(reqId, request) {
    const card = document.createElement('div');
    card.className = 'request-card';

    const currency = request.currency || 'USD';
    let dealsHTML = '';
    let totalAmount = 0;

    // Gather deals info
    for(const dealId of request.dealIds){
      const dealRef = doc(db, 'promoter-earnings', request.promoterId, 'deals', dealId);
      const dealSnap = await getDoc(dealRef);
      if(dealSnap.exists()){
        const deal = dealSnap.data();
        dealsHTML += `<div class="deal-info">
          • ${deal.offerTitle || 'N/A'} - ${deal.currency || 'USD'} ${deal.commissionAmount.toFixed(2)}
          | Platform Share: ${deal.platformTax.toFixed(2)}
          | Full Commission: ${deal.fullCommission.toFixed(2)}
          | Client: ${deal.clientName || 'N/A'}
        </div>`;
        totalAmount += deal.commissionAmount || 0;
      }
    }

    card.innerHTML = `
      <div><strong>Promoter:</strong> ${request.promoterId}</div>
      <div class="total-request">Total Requested: ${currency} ${totalAmount.toFixed(2)}</div>
      <div><strong>Requested At:</strong> ${new Date(request.requestedAt).toLocaleString()}</div>
      <div class="deals-list">${dealsHTML}</div>
      <button class="btn approve">✅ Approve</button>
      <button class="btn reject">❌ Reject</button>
    `;

    // ----- Approve withdrawal -----
    card.querySelector('.approve').onclick = async () => {
      try {
        await runTransaction(db, async (t) => {
          const requestRef = doc(db, 'withdrawal-requests', reqId);
          const reqSnap = await t.get(requestRef);
          if(!reqSnap.exists() || reqSnap.data().status !== 'pending') throw new Error('Request no longer pending');

          const promoterId = request.promoterId;
          const metaRef = doc(db, 'promoter-earnings', promoterId, 'metadata', 'meta');
          const metaSnap = await t.get(metaRef);
          const meta = metaSnap.exists() ? metaSnap.data() : { totalWithdrawn: {}, currentBalance: {} };

          // Mark deals withdrawn
          for(const dealId of request.dealIds){
            const dealRef = doc(db, 'promoter-earnings', promoterId, 'deals', dealId);
            t.update(dealRef, { withdrawn: true });
          }

          // Recalculate balances
          const dealsCol = collection(db, 'promoter-earnings', promoterId, 'deals');
          const allDealsSnap = await t.get(dealsCol);
          const currentBalance = {};
          const totalWithdrawn = {...(meta.totalWithdrawn||{})};

          allDealsSnap.forEach(dSnap => {
            const d = dSnap.data();
            const c = d.currency || 'USD';
            if(!d.withdrawn){
              currentBalance[c] = (currentBalance[c]||0) + (d.commissionAmount || 0);
            } else {
              totalWithdrawn[c] = (totalWithdrawn[c]||0) + (d.commissionAmount || 0);
            }
          });

          t.update(metaRef, { currentBalance, totalWithdrawn, lastUpdated: new Date().toISOString() });
          t.update(requestRef, { status: 'approved', processedAt: new Date().toISOString() });

          // Notification
          const notifRef = collection(db, `notifications/${promoterId}/items`);
          t.set(doc(notifRef), {
            title: 'Withdrawal Approved ✅',
            message: `Your withdrawal of ${currency} ${totalAmount.toFixed(2)} has been approved.`,
            type: 'withdrawal_approved',
            createdAt: new Date().toISOString(),
            requestId: reqId
          });
        });

        showNotif(`✅ ${currency} withdrawal approved.`);
        card.remove();
      } catch(err){
        console.error(err);
        showNotif('Error approving withdrawal: ' + err.message, 'error');
      }
    };

    // ----- Reject withdrawal -----
    card.querySelector('.reject').onclick = async () => {
      try {
        await runTransaction(db, async (t) => {
          const requestRef = doc(db, 'withdrawal-requests', reqId);
          const reqSnap = await t.get(requestRef);
          if(!reqSnap.exists() || reqSnap.data().status !== 'pending') throw new Error('Request no longer pending');

          const promoterId = request.promoterId;

          // Reset deals withdrawn
          for(const dealId of request.dealIds){
            const dealRef = doc(db, 'promoter-earnings', promoterId, 'deals', dealId);
            t.update(dealRef, { withdrawn: false });
          }

          // Recalculate currentBalance
          const dealsCol = collection(db, 'promoter-earnings', promoterId, 'deals');
          const allDealsSnap = await t.get(dealsCol);
          const currentBalance = {};
          allDealsSnap.forEach(dSnap => {
            const d = dSnap.data();
            const c = d.currency || 'USD';
            if(!d.withdrawn){
              currentBalance[c] = (currentBalance[c]||0) + (d.commissionAmount || 0);
            }
          });

          const metaRef = doc(db, 'promoter-earnings', promoterId, 'metadata', 'meta');
          t.update(metaRef, { currentBalance, lastUpdated: new Date().toISOString() });

          t.update(requestRef, { status: 'rejected', processedAt: new Date().toISOString() });

          // Notification
          const notifRef = collection(db, `notifications/${promoterId}/items`);
          t.set(doc(notifRef), {
            title: 'Withdrawal Rejected ❌',
            message: `Your withdrawal of ${currency} ${totalAmount.toFixed(2)} has been rejected. You can request again later.`,
            type: 'withdrawal_rejected',
            createdAt: new Date().toISOString(),
            requestId: reqId
          });
        });

        showNotif(`❌ ${currency} withdrawal rejected.`);
        card.remove();
      } catch(err){
        console.error(err);
        showNotif('Error rejecting withdrawal: ' + err.message, 'error');
      }
    };

    container.appendChild(card);
  }

}
</script>

</body>
</html>
