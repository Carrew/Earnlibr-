<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin — Approve Withdrawals</title>

<style>
body { font-family: Arial, sans-serif; background: #0b0d17; color: #eef2f7; margin: 0; padding: 20px; }
h1 { background: linear-gradient(90deg, #4a90e2, #a3ff6e); -webkit-background-clip: text; color: transparent; margin-bottom: 20px; }
.request-box { background: #0f1724; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
.request-box button { margin-top: 10px; padding: 6px 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; }
.approve { background: #4ade80; color: #041018; }
.reject { background: #ef4444; color: #fff; }
.notif { background: #1a2235; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; display: none; }
.notif.success { border-left: 4px solid #4ade80; color: #a3ff6e; }
.notif.error { border-left: 4px solid #ef4444; color: #ff8c8c; }
</style>
</head>
<body>

<h1>Withdrawal Requests</h1>
<div id="notif" class="notif"></div>
<div id="requestsContainer">Loading requests...</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { 
  collection, doc, getDoc, getDocs, updateDoc,
  query, where, runTransaction, addDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const notif = document.getElementById("notif");
const requestsContainer = document.getElementById("requestsContainer");

const showNotif = (msg, type="success") => {
  notif.textContent = msg;
  notif.className = `notif ${type}`;
  notif.style.display = "block";
  setTimeout(() => notif.style.display = "none", 3000);
};

/* -------------------------------------------
   AUTHENTICATION — MATCHES YOUR LOGIN SYSTEM
-------------------------------------------- */
let userSession = localStorage.getItem("userSession");

if (!userSession) {
  window.location.href = "login.html";
  throw new Error("No session");
}
userSession = JSON.parse(userSession);

onAuthStateChanged(auth, async (user) => {
  if (!user || user.uid !== userSession.uid) {
    localStorage.removeItem("userSession");
    window.location.href = "login.html";
    return;
  }

  if (!user.emailVerified) {
    localStorage.removeItem("userSession");
    window.location.href = "login.html";
    return;
  }

  const adminRef = doc(db, "admins", user.uid);
  const adminSnap = await getDoc(adminRef);

  if (!adminSnap.exists() || !["admin", "super_admin"].includes(adminSnap.data().role)) {
    localStorage.removeItem("userSession");
    window.location.href = "login.html";
    return;
  }

  const data = adminSnap.data();
  userSession = {
    uid: user.uid,
    name: data.name,
    email: data.email,
    role: data.role,
    referralCode: data.referralCode || "",
    phone: data.phone || "",
    country: data.country || "",
    createdAt: data.createdAt || ""
  };

  localStorage.setItem("userSession", JSON.stringify(userSession));

  loadRequests();
});

/* -------------------------------------------
   SEND NOTIFICATION — MODEL A
-------------------------------------------- */
async function sendNotification(uid, title, message) {
  try {
    await addDoc(collection(db, `notifications/${uid}/items`), {
      title,
      message,
      createdAt: serverTimestamp(),
      read: false
    });
  } catch (err) {
    console.error("Notification error:", err);
  }
}

/* -------------------------------------------
   LOAD WITHDRAWAL REQUESTS
-------------------------------------------- */
async function loadRequests() {
  const reqQuery = query(
    collection(db, "withdrawal-requests"),
    where("status", "==", "pending")
  );

  const reqSnap = await getDocs(reqQuery);
  requestsContainer.innerHTML = "";

  if (reqSnap.empty) {
    requestsContainer.innerHTML = "<p>No pending withdrawal requests.</p>";
    return;
  }

  reqSnap.forEach(docSnap => {
    renderRequestBox(docSnap.id, docSnap.data());
  });
}

/* -------------------------------------------
   DISPLAY REQUEST BOX
-------------------------------------------- */
function renderRequestBox(reqId, req) {
  const box = document.createElement("div");
  box.className = "request-box";

  box.innerHTML = `
    <p><strong>Promoter ID:</strong> ${req.promoterId}</p>
    <p><strong>Currency:</strong> ${req.currency}</p>
    <p><strong>Amount:</strong> ${req.amount}</p>
    <p><strong>Deals:</strong> ${req.dealIds.join(", ")}</p>
    <button class="approve">Approve</button>
    <button class="reject">Reject</button>
  `;

  requestsContainer.appendChild(box);

  box.querySelector(".approve").onclick = () => processApproval(reqId, req, true, box);
  box.querySelector(".reject").onclick = () => processApproval(reqId, req, false, box);
}

/* -------------------------------------------
   PROCESS APPROVE/REJECT (FIXED TRANSACTION)
-------------------------------------------- */
async function processApproval(reqId, req, approve = true, box) {
  try {
    await runTransaction(db, async (t) => {

      const reqRef = doc(db, "withdrawal-requests", reqId);

      // 1️⃣ READ REQUEST
      const reqSnap = await t.get(reqRef);
      if (!reqSnap.exists()) throw new Error("Request already processed");

      let metaRef, metaSnap;
      const dealRefs = [];
      const dealSnaps = [];

      if (approve) {
        // 2️⃣ READ ALL DEAL DOCS FIRST — NO WRITES YET
        for (const dealId of req.dealIds) {
          const dealRef = doc(db, "promoter-earnings", req.promoterId, "deals", dealId);
          dealRefs.push(dealRef);
          dealSnaps.push(await t.get(dealRef));
        }

        // 3️⃣ READ METADATA DOC
        metaRef = doc(db, "promoter-earnings", req.promoterId, "metadata", "summary");
        metaSnap = await t.get(metaRef);
        if (!metaSnap.exists()) throw new Error("Metadata missing");
      }

      // ------- ALL READS DONE — WRITES BEGIN BELOW -------
      if (approve) {
        // 4️⃣ WRITE: Mark deal docs withdrawn
        for (const ref of dealRefs) {
          t.update(ref, { withdrawn: true });
        }

        // 5️⃣ WRITE: Update metadata
        const meta = metaSnap.data();
        meta.totalWithdrawn[req.currency] =
          (meta.totalWithdrawn[req.currency] || 0) + req.amount;

        meta.currentBalance[req.currency] =
          (meta.totalLifetimeEarnings[req.currency] || 0) -
          meta.totalWithdrawn[req.currency];

        meta.lastUpdated = new Date().toISOString();

        t.set(metaRef, meta, { merge: true });

        // 6️⃣ WRITE: Mark request approved
        t.update(reqRef, {
          status: "approved",
          processedAt: new Date().toISOString()
        });

        // 7️⃣ SEND STANDARDIZED NOTIFICATION — APPROVAL
        await sendNotification(
          req.promoterId,
          "Withdrawal Approved ✅",
          `Your withdrawal request of ${req.amount} ${req.currency} has been approved and processed successfully.`
        );

      } else {
        // Reject only updates the request
        t.update(reqRef, {
          status: "rejected",
          processedAt: new Date().toISOString()
        });

        // 7️⃣ SEND STANDARDIZED NOTIFICATION — REJECTION
        await sendNotification(
          req.promoterId,
          "Withdrawal Rejected ❌",
          `Your withdrawal request of ${req.amount} ${req.currency} has been rejected. Please contact support for more information.`
        );
      }
    });

    showNotif(`Request ${approve ? "approved" : "rejected"} successfully`);
    box.remove();

  } catch (err) {
    console.error(err);
    showNotif(err.message, "error");
  }
}
</script>
</body>
</html>
