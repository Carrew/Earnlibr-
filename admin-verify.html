<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EarnLibr ‚Äî Admin Verify Offers</title>
<style>
  body { font-family: Arial, sans-serif; background:#0b0d17; color:#eef2f7; margin:0; padding:20px;}
  h1 { background: linear-gradient(90deg,#4a90e2,#a3ff6e); -webkit-background-clip:text; color:transparent; }

  .offer-card { 
    background:#0f1724; border-radius:12px; padding:15px; margin-bottom:15px; 
    display:flex; gap:15px; align-items:flex-start; position:relative; 
  }
  .offer-card img {
    width:120px; height:80px; object-fit:cover; border-radius:8px; 
    transition: transform 0.2s ease; cursor:pointer;
  }
  .offer-card img:hover { transform: scale(2); z-index: 10; position: relative; }

  .offer-details { flex:1; line-height:1.4; }
  .offer-actions button { margin-right:8px; padding:6px 12px; border:none; border-radius:8px; cursor:pointer; font-weight:700;}
  .approve { background:#4ade80; color:#041018; }
  .reject { background:#ef4444; color:#fff; }

  .notification {
    position: absolute;
    top:5px; right:5px;
    padding:6px 12px;
    border-radius:8px;
    font-size:0.9rem;
    font-weight:700;
    opacity:0.9;
  }
  .notification.success { background:#4ade80; color:#041018; }
  .notification.error { background:#ef4444; color:#fff; }
  .notification.info { background:#3b82f6; color:#fff; }
</style>
</head>
<body>

<h1>Pending Offers Verification</h1>
<div id="offersContainer">Loading...</div>

<script type="module">
import { db } from './firebase.js';
import { ref, onValue, remove, push, get, set } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js';

const offersContainer = document.getElementById('offersContainer');

function showNotification(card, message, type='info', duration=3000) {
  const notif = document.createElement('div');
  notif.className = `notification ${type}`;
  notif.innerText = message;
  card.appendChild(notif);
  setTimeout(() => notif.remove(), duration);
}

// Fetch provider/user info
async function getProviderInfo(providerId) {
  const userRef = ref(db, `users/${providerId}`);
  const snapshot = await get(userRef);
  return snapshot.exists() ? snapshot.val() : null;
}

const pendingRef = ref(db, 'offers_pending');
onValue(pendingRef, (snapshot) => {
  offersContainer.innerHTML = '';
  if (!snapshot.exists()) {
    offersContainer.innerHTML = '<p>No pending offers.</p>';
    return;
  }

  snapshot.forEach(userSnap => {
    const uid = userSnap.key;
    const userOffers = userSnap.val();

    for (const offerId in userOffers) {
      const offer = userOffers[offerId];

      const card = document.createElement('div');
      card.className = 'offer-card';
      card.innerHTML = `
        <img src="${offer.imageBase64 || 'https://via.placeholder.com/120x80?text=No+Image'}" alt="Offer Image">
        <div class="offer-details">
          <strong>${offer.title || 'Untitled Offer'}</strong><br>
          ${offer.description || ''}<br>
          üí∞ ${offer.currency || '$'} ${offer.price || 0}<br>
          Commission: ${offer.commissionType || ''} ${offer.commissionValue || 0}<br>
          Total Products: ${offer.totalProducts || 0}<br>
          Promo Budget: ${offer.promotionBudget || 0}<br>
          Promo Spent: 0<br><br>

          <em>Category:</em> ${offer.category || 'Uncategorized'}<br>
          <em>Submitted:</em> ${offer.createdAt ? new Date(offer.createdAt).toLocaleString() : 'N/A'}<br>
          <em>Provider:</em> ${offer.providerPhone || '+231000000000'} (ID: ${uid})
        </div>
        <div class="offer-actions">
          <button class="approve">Approve</button>
          <button class="reject">Reject</button>
        </div>
      `;

      const approveBtn = card.querySelector('.approve');
      const rejectBtn = card.querySelector('.reject');

      approveBtn.onclick = async () => {
        approveBtn.disabled = true;
        rejectBtn.disabled = true;
        showNotification(card, 'Processing approval...', 'info');

        try {
          const providerInfo = await getProviderInfo(uid);

          let cloudUrl = null;
          if (offer.imageBase64) {
            const formData = new FormData();
            formData.append('file', offer.imageBase64);
            formData.append('upload_preset', 'Earnlibr');

            const res = await fetch('https://api.cloudinary.com/v1_1/dye3bda08/image/upload', { method:'POST', body:formData });
            const data = await res.json();
            cloudUrl = data.secure_url;
          }

          // üîπ Set up the new offer object with extended financial fields
          const approvedOffer = {   
            providerId: uid,
            providerName: providerInfo?.name || "Unknown",
            providerEmail: providerInfo?.email || "",
            providerPhone: providerInfo?.phone || offer.providerPhone || "+231000000000",
            role: providerInfo?.role || "provider",
            
            // Offer & Commission Details
            title: offer.title || 'Untitled Offer',
            description: offer.description || '',
            category: offer.category || 'Uncategorized',
            currency: offer.currency || '$',
            price: offer.price || 0,
            commissionType: offer.commissionType || '',
            commissionValue: offer.commissionValue || 0,
            totalProducts: offer.totalProducts || 0,
            
            // Promo/Financial Details
            promotionBudget: offer.promotionBudget || 0,
            promoSpent: 0,
            amountOwed: 0,              // üí∞ Total owed by provider for completed deals
            amountPaid: 0,              // üíµ Total provider has paid
            outstandingBalance: 0,      // amountOwed - amountPaid
            nextBillingDate: null,      // üóìÔ∏è To be assigned by system (weekly billing day)
            lastBilledAt: null,         // Last time billed
            paymentStatus: 'unpaid',
            paymentDeadline: null,
            paymentNotes: '',
            
            // Status & Metadata
            status: 'active',
            verified: true,
            verifiedBy: 'superadmin',
            approvedAt: new Date().toISOString(),
            createdAt: offer.createdAt || new Date().toISOString(),
            
            // Tracking for reporting
            providerStats: {
              totalDeals: 0,
              completedDeals: 0,
              cancelledDeals: 0
            }
          };

          // Push to main offers DB
          await push(ref(db, 'offers/' + uid), approvedOffer);

          // Remove from pending
          await remove(ref(db, `offers_pending/${uid}/${offerId}`));

          // Notify provider
          await push(ref(db, `notifications/${uid}`), {
            title: 'Offer Approved ‚úÖ',
            message: `Your offer "${offer.title}" has been approved and is now live.`,
            type: 'approved',
            createdAt: new Date().toISOString()
          });

          offer.imageBase64 = null;
          showNotification(card, 'Offer approved and saved with payment tracking fields.', 'success');

        } catch (err) {
          console.error(err);
          showNotification(card, 'Error: ' + err.message, 'error');
          approveBtn.disabled = false;
          rejectBtn.disabled = false;
        }
      };

      // Reject logic
      rejectBtn.onclick = async () => {
        const confirmReject = confirm('Are you sure you want to reject this offer?');
        if (!confirmReject) return;

        approveBtn.disabled = true;
        rejectBtn.disabled = true;
        showNotification(card, 'Processing rejection...', 'info');

        try {
          await remove(ref(db, `offers_pending/${uid}/${offerId}`));
          await push(ref(db, `notifications/${uid}`), {
            title: 'Offer Rejected ‚ùå',
            message: `Your offer "${offer.title}" was rejected. Please review and try again.`,
            type: 'rejected',
            createdAt: new Date().toISOString()
          });

          offer.imageBase64 = null;
          showNotification(card, 'Offer rejected. Provider notified.', 'error');
        } catch (err) {
          console.error(err);
          showNotification(card, 'Error: ' + err.message, 'error');
          approveBtn.disabled = false;
          rejectBtn.disabled = false;
        }
      };

      offersContainer.appendChild(card);
    }
  });
});
</script>

</body>
</html>
