<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EarnLibr â€” Provider Deals Management (Firestore)</title>
<style>
body { font-family: Arial, sans-serif; background: #0b0d17; color: #eef2f7; margin: 0; padding: 20px; }
h1 { background: linear-gradient(90deg, #4a90e2, #a3ff6e); -webkit-background-clip: text; color: transparent; margin-bottom: 20px; }
.deal-card { background: #0f1724; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: opacity .5s ease, transform .3s; position: relative; }
.deal-card:hover { transform: translateY(-4px); }
.deal-card.completed { border-left: 4px solid #4ade80; }
.deal-card.cancelled { border-left: 4px solid #ef4444; }
.deal-info { margin-bottom: 10px; font-size: 14px; }
.deal-actions button { margin-right: 8px; padding: 6px 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; position: relative; }
.complete { background: #4ade80; color: #041018; }
.cancel { background: #ef4444; color: #fff; }
button.loading { pointer-events: none; opacity: 0.7; }
button.loading::after { content: ''; position: absolute; top: 50%; left: 50%; width: 16px; height: 16px; margin: -8px 0 0 -8px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.timestamp { font-size: 12px; color: #bfc7d6; margin-top: 5px; }
.notif { background: #1a2235; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; display: none; }
.notif.success { border-left: 4px solid #4ade80; color: #a3ff6e; }
.notif.error { border-left: 4px solid #ef4444; color: #ff8c8c; }
.card-notif { position: absolute; top: 10px; right: 10px; background: #1a2235; padding: 6px 12px; border-radius: 8px; font-size: 13px; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.45); }
.card-notif button { background: transparent; border: none; color: #a3ff6e; font-weight: 700; cursor: pointer; }
.card-notif button:hover { color: #4ade80; }
</style>
</head>
<body>
<h1>Your Deals</h1>
<div id="notif" class="notif"></div>
<div id="dealsContainer">Loading deals...</div>

<script type="module">
import { auth, db } from './firebase.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import {
  collection, doc, getDoc, setDoc, deleteDoc, addDoc, runTransaction, query, where, orderBy, onSnapshot
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const dealsContainer = document.getElementById("dealsContainer");
const notif = document.getElementById("notif");

const showNotif = (msg, type="success") => {
  notif.textContent = msg;
  notif.className = `notif ${type}`;
  notif.style.display = "block";
  setTimeout(() => { notif.style.display = "none"; }, 3000);
};

/* --- Session & Auth Check --- */
let userSession = localStorage.getItem("userSession");
console.log("Loaded user session from localStorage:", userSession);

if(!userSession){
  console.warn("No user session found, redirecting to login...");
  window.location.href = "login.html";
  throw new Error("No session");
}
userSession = JSON.parse(userSession);
console.log("Parsed user session:", userSession);

onAuthStateChanged(auth, async (user) => {
  console.log("Auth state changed, user:", user);
  if(!user || user.uid !== userSession.uid){
    console.warn("User not logged in or UID mismatch, redirecting...");
    localStorage.removeItem("userSession");
    window.location.href = "login.html";
    return;
  }

  if(!user.emailVerified){
    console.warn("User email not verified, redirecting...");
    localStorage.removeItem("userSession");
    window.location.href = "login.html";
    return;
  }

  // Firestore user doc check
  const userDoc = await getDoc(doc(db, 'users', user.uid));
  console.log("Fetched user document:", userDoc.exists() ? userDoc.data() : "Does not exist");

  if(!userDoc.exists() || userDoc.data().role !== 'provider'){
    console.error("User is not a provider, redirecting...");
    localStorage.removeItem("userSession");
    window.location.href = "login.html";
    return;
  }

  // Update local session just in case
  const uData = userDoc.data();
  userSession = { uid: user.uid, name: uData.name, email: uData.email, role: uData.role };
  localStorage.setItem('userSession', JSON.stringify(userSession));
  console.log("Updated local session with Firestore data:", userSession);

  loadDeals(user.uid);
});

/* --- Helper --- */
const round = (num) => Math.round((num + Number.EPSILON) * 100) / 100;

/* --- Load Deals --- */
function loadDeals(providerId){
  console.log("Loading deals for providerId:", providerId);

  const dealsQuery = query(
    collection(db, "deals"),
    where("providerId", "==", providerId),
    orderBy("createdAt", "desc")
  );

  onSnapshot(dealsQuery,
    snapshot => {
      console.log("Deals snapshot received:", snapshot);
      dealsContainer.innerHTML = "";

      if(snapshot.empty){
        console.warn("No active deals found.");
        dealsContainer.innerHTML = "<p>No active deals yet.</p>";
        return;
      }

      snapshot.docs.forEach(docSnap => {
        console.log("Rendering deal:", docSnap.id, docSnap.data());
        renderDealCard(docSnap.id, docSnap.data());
      });
    },
    error => {
      console.error("Error fetching deals snapshot:", error);
      dealsContainer.innerHTML = "<p>Error loading deals.</p>";
      showNotif("Error fetching deals: " + error.message, "error");
    }
  );
}

/* --- Render Deal Card --- */
function renderDealCard(dealId, deal){
  const card = document.createElement("div");
  card.className="deal-card "+(deal.status||"");

  card.innerHTML = `
    <div class="deal-info"><strong>Deal ID:</strong> ${dealId}</div>
    <div class="deal-info"><strong>Offer:</strong> ${deal.offerTitle||'N/A'}</div>
    <div class="deal-info"><strong>Promoter:</strong> ${deal.promoterId!=="direct"?deal.promoterName:"Direct"} (${deal.promoterId})</div>
    <div class="deal-info"><strong>Client:</strong> ${deal.clientName} | ${deal.clientContact}</div>
    <div class="deal-info"><strong>Note:</strong> ${deal.note||"None"}</div>

    <div class="deal-actions">
      <button class="complete">Mark Completed</button>
      <button class="cancel">Mark Cancelled</button>
    </div>

    <div class="timestamp">Created: ${new Date(deal.createdAt).toLocaleString()} | Status: ${deal.status||"Pending"}</div>
  `;

  card.querySelector(".complete").onclick=()=>scheduleAction("complete", dealId, deal, card);
  card.querySelector(".cancel").onclick=()=>scheduleAction("cancel", dealId, deal, card);

  dealsContainer.appendChild(card);
}

/* --- Schedule Actions --- */
function scheduleAction(type, dealId, deal, card){
  const box = document.createElement("div");
  box.className="card-notif";
  box.innerHTML = `${type==="complete"?"Completing":"Cancelling"} in 5s <button>Undo</button>`;
  card.appendChild(box);

  const buttons = card.querySelectorAll("button");
  buttons.forEach(btn=>{ btn.disabled=true; btn.classList.add("loading"); });

  let cancelled=false;
  box.querySelector("button").onclick=()=>{
    cancelled=true;
    box.remove();
    buttons.forEach(btn=>{ btn.disabled=false; btn.classList.remove("loading"); });
    showNotif("Action cancelled","error");
  };

  setTimeout(async ()=>{
    box.remove();
    if(!cancelled){
      if(type==="complete") await processCompleteDeal(dealId, deal, card);
      else await processCancelDeal(dealId, deal, card);
    }
    buttons.forEach(btn=>{ btn.disabled=false; btn.classList.remove("loading"); });
  },5000);
}

/* --- Complete & Cancel Deal functions --- */
// Keep your existing processCompleteDeal and processCancelDeal functions as-is.
// You can also add console.log inside them to track transaction success/failure.

</script>
</body>
</html>
