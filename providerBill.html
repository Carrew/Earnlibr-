<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EarnLibr — Provider Bill</title>
<style>
body { font-family: Arial, sans-serif; background: #0b0d17; color: #eef2f7; margin: 0; padding: 20px; }
h1 { background: linear-gradient(90deg, #4a90e2, #a3ff6e); -webkit-background-clip: text; color: transparent; margin-bottom: 20px; }
.bill-container { margin-bottom: 20px; }
.currency-total { background: #1a2235; padding: 15px; border-radius: 12px; margin-bottom: 10px; }
.currency-total h3 { margin: 0 0 10px 0; }
.offer-breakdown { background: #0f1724; padding: 10px; margin-bottom: 5px; border-radius: 10px; cursor: pointer; }
.deal-item { background: #171f34; padding: 8px; margin: 5px 0; border-radius: 8px; font-size: 14px; }
.btn-pay { background: #4ade80; color: #041018; padding: 10px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; margin-top: 10px; }
.notif { display: none; margin-bottom: 20px; padding: 10px; border-radius: 8px; }
.notif.success { border-left: 4px solid #4ade80; color: #a3ff6e; }
.notif.error { border-left: 4px solid #ef4444; color: #ff8c8c; }
</style>
</head>
<body>

<h1>Provider Weekly Bill</h1>
<div id="notif" class="notif"></div>
<div id="billContainer" class="bill-container">Loading your bill...</div>

<script type="module">
import { db } from './firebase.js';
import { ref, get, push, update } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js';

const providerId = "PROVIDER_ID_HERE"; // replace with logged-in provider ID
const billContainer = document.getElementById('billContainer');
const notif = document.getElementById('notif');

const showNotif = (msg, type='success') => {
  notif.textContent = msg;
  notif.className = `notif ${type}`;
  notif.style.display = 'block';
  setTimeout(() => notif.style.display = 'none', 4000);
};

async function fetchProviderBills() {
  billContainer.innerHTML = "Loading...";
  try {
    const billsSnap = await get(ref(db, `provider-bills/${providerId}`));
    if (!billsSnap.exists()) {
      billContainer.innerHTML = "<p>No bills available.</p>";
      return;
    }

    const bills = billsSnap.val();
    billContainer.innerHTML = "";

    for (const [billId, bill] of Object.entries(bills)) {
      const currencyTotals = bill.totalPerCurrency;

      for (const [currency, total] of Object.entries(currencyTotals)) {
        const currencyDiv = document.createElement('div');
        currencyDiv.className = "currency-total";

        currencyDiv.innerHTML = `<h3>Total Owed (${currency}): ${total.toFixed(2)}</h3>`;

        // Offer breakdown
        bill.offers.filter(o => o.currency === currency).forEach(offer => {
          const offerDiv = document.createElement('div');
          offerDiv.className = "offer-breakdown";
          offerDiv.innerHTML = `<strong>${offer.offerTitle}</strong> — Subtotal: ${offer.subtotal.toFixed(2)} (${offer.deals.length} deals)`;

          const dealsList = document.createElement('div');
          dealsList.style.display = 'none';

          offer.deals.forEach(deal => {
            const dealDiv = document.createElement('div');
            dealDiv.className = "deal-item";
            dealDiv.textContent = `DealID: ${deal.id} | Client: ${deal.clientName} | Commission: ${deal.commissionEarned.toFixed(2)}`;
            dealsList.appendChild(dealDiv);
          });

          offerDiv.appendChild(dealsList);
          offerDiv.onclick = () => dealsList.style.display = dealsList.style.display === 'none' ? 'block' : 'none';
          currencyDiv.appendChild(offerDiv);
        });

        // Pay button
        const payBtn = document.createElement('button');
        payBtn.className = 'btn-pay';
        payBtn.textContent = `Mark as Paid (${currency} ${total.toFixed(2)})`;
        payBtn.onclick = async () => {
          try {
            await push(ref(db, 'admin-notifications'), {
              providerId,
              billId,
              currency,
              totalAmount: total,
              offers: bill.offers.filter(o => o.currency === currency),
              createdAt: new Date().toISOString(),
              type: 'providerPaymentRequest'
            });
            showNotif(`Payment notification sent to admin for ${currency} ${total.toFixed(2)}.`, 'success');
          } catch (err) {
            console.error(err);
            showNotif('Error sending payment notification: ' + err.message, 'error');
          }
        };

        currencyDiv.appendChild(payBtn);
        billContainer.appendChild(currencyDiv);
      }
    }
  } catch (err) {
    console.error(err);
    billContainer.innerHTML = "<p>Error fetching bills: " + err.message + "</p>";
  }
}

fetchProviderBills();
</script>
</body>
</html>
