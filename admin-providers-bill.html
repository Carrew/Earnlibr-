<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EarnLibr â€” Admin Send Weekly Bills</title>
<style>
  :root {
    --bg: #0b0d17;
    --card: #0f1724;
    --accent1: #4a90e2;
    --accent2: #a3ff6e;
    --muted: #bfc7d6;
    --danger: #ef4444;
    --success: #4ade80;
  }

  body {
    font-family: Inter, system-ui, Arial;
    background: var(--bg);
    color: #eef2f7;
    margin: 0;
    padding: 20px;
    min-height: 100vh;
  }

  header {
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    padding: 20px;
    color: #041018;
    margin-bottom: 20px;
  }

  header img {
    height: 50px;
    margin-right: 15px;
  }

  header h1 {
    font-size: 24px;
    font-weight: bold;
  }

  .notif {
    margin: 10px auto;
    padding: 10px 15px;
    width: 90%;
    max-width: 500px;
    border-radius: 8px;
    display: none;
    font-size: 14px;
  }
  .notif.success { background: #1a2235; border-left: 4px solid var(--success); color: var(--success);}
  .notif.error { background: #1a2235; border-left: 4px solid var(--danger); color: var(--danger);}

  .profile-card {
    background: var(--card);
    margin: 20px auto;
    max-width: 500px;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
  }
  .profile-card h2 { margin: 5px 0; }
  .profile-card p { margin: 2px 0; color: var(--muted); font-size: 14px; }
  .logout-btn {
    margin-top: 12px;
    padding: 8px 14px;
    border-radius: 8px;
    background: var(--danger);
    color: #fff;
    border: none;
    cursor: pointer;
    font-weight: bold;
    transition: 0.2s;
  }
  .logout-btn:hover { opacity: 0.9; }

  .controls { margin-bottom: 20px; display: flex; justify-content: flex-start; gap: 10px; }
  .btn {
    background: var(--success);
    border: none;
    padding: 8px 14px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    color: #041018;
  }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }

  .provider-card {
    background: var(--card);
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.4);
  }
  .provider-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  .offer-breakdown {
    background: #1a2235;
    border-radius: 8px;
    padding: 10px;
    margin-top: 10px;
    display: none;
  }
  .offer { border-bottom: 1px solid #2b3145; padding: 5px 0; }
  .deal-item { font-size: 13px; margin-left: 10px; padding: 2px 0; }
</style>
</head>
<body>

<header>
  <img src="https://raw.githubusercontent.com/Carrew/Earnlibr-/refs/heads/main/1000115452-01.jpeg" alt="EarnLibr Logo">
  <h1>EarnLibr Admin â€” Weekly Bills</h1>
</header>

<div id="notif" class="notif"></div>

<div class="profile-card">
  <h2 id="adminName">Admin Name</h2>
  <p id="adminEmail">admin@example.com</p>
  <p id="adminPhone">+0000000000</p>
  <p id="adminReferral">Referral Code: N/A</p>
  <p id="adminCreated">Joined: N/A</p>
  <button id="logoutBtn" class="logout-btn">Logout</button>
</div>

<div class="controls">
  <button id="sendAll" class="btn">ðŸ“¤ Send All Eligible Bills</button>
</div>

<div id="providersContainer">Loading pending bills...</div>

<script type="module">
import { db } from './firebase.js';
import { ref, onValue, push, set, get } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js';

const notif = document.getElementById('notif');
const adminName = document.getElementById('adminName');
const adminEmail = document.getElementById('adminEmail');
const adminPhone = document.getElementById('adminPhone');
const adminReferral = document.getElementById('adminReferral');
const adminCreated = document.getElementById('adminCreated');
const logoutBtn = document.getElementById('logoutBtn');
const providersContainer = document.getElementById('providersContainer');
const sendAllBtn = document.getElementById('sendAll');
const THRESHOLDS = { USD: 1, LRD: 300 };

// âœ… Admin Security Check
const session = JSON.parse(localStorage.getItem('userSession'));
if(!session || session.role !== 'admin'){
  notif.textContent = 'âš  You must be logged in as admin to access this page.';
  notif.className = 'notif error';
  notif.style.display = 'block';
  setTimeout(() => window.location.href = 'index.html', 2000);
} else {
  adminName.textContent = session.name;
  adminEmail.textContent = session.email;
  adminPhone.textContent = session.phone || 'N/A';
  adminReferral.textContent = `Referral Code: ${session.referralCode || 'N/A'}`;
  adminCreated.textContent = `Joined: ${new Date(session.createdAt).toLocaleDateString() || 'N/A'}`;
}

// Logout
logoutBtn.addEventListener('click', () => {
  localStorage.removeItem('userSession');
  window.location.href = 'index.html';
});

// Notifications helper
const showNotif = (msg) => {
  notif.textContent = msg;
  notif.className = 'notif success';
  notif.style.display = 'block';
  setTimeout(() => notif.style.display = 'none', 4000);
};

let grouped = {};

// Fetch all completed but unpaid deals
const dealsRef = ref(db, 'completed-deals');
onValue(dealsRef, (snapshot) => {
  providersContainer.innerHTML = '';
  if (!snapshot.exists()) {
    providersContainer.innerHTML = '<p>No completed unpaid deals found.</p>';
    return;
  }

  const deals = snapshot.val();
  grouped = {};

  Object.keys(deals).forEach(id => {
    const d = deals[id];
    if (d.providerPaid) return;
    const provId = d.providerId;

    if (!grouped[provId]) grouped[provId] = { name: d.providerName, offers: {}, totals: {} };

    if (!grouped[provId].offers[d.offerId]) {
      grouped[provId].offers[d.offerId] = {
        offerTitle: d.offerTitle,
        currency: d.currency || 'USD',
        total: 0,
        deals: []
      };
    }

    const offer = grouped[provId].offers[d.offerId];
    offer.total += parseFloat(d.commissionEarned || 0);
    offer.deals.push({
      dealId: id,
      clientName: d.clientName,
      clientContact: d.clientContact,
      commissionEarned: parseFloat(d.commissionEarned || 0),
      note: d.note || '',
      createdAt: d.createdAt
    });

    const curr = offer.currency;
    if (!grouped[provId].totals[curr]) grouped[provId].totals[curr] = 0;
    grouped[provId].totals[curr] += parseFloat(d.commissionEarned || 0);
  });

  // Render provider cards
  Object.keys(grouped).forEach(provId => {
    const provider = grouped[provId];
    const card = document.createElement('div');
    card.className = 'provider-card';

    let totalsHTML = '';
    Object.entries(provider.totals).forEach(([curr, amt]) => {
      totalsHTML += `<div><strong>${curr}:</strong> ${amt.toFixed(2)}</div>`;
    });

    const header = `
      <div class="provider-header">
        <h2>${provider.name || 'Unnamed Provider'} (${provId})</h2>
        <button class="btn sendBill">Send Bill</button>
      </div>
      <div>${totalsHTML}</div>
      <button class="btn toggleOffers">Show Offers & Deals</button>
      <div class="offer-breakdown"></div>
    `;
    card.innerHTML = header;
    providersContainer.appendChild(card);

    const breakdown = card.querySelector('.offer-breakdown');
    Object.values(provider.offers).forEach(offer => {
      const offerDiv = document.createElement('div');
      offerDiv.className = 'offer';
      offerDiv.innerHTML = `<strong>${offer.offerTitle} â€” ${offer.currency} ${offer.total.toFixed(2)}</strong>`;
      offer.deals.forEach(d => {
        const dealDiv = document.createElement('div');
        dealDiv.className = 'deal-item';
        dealDiv.textContent = `DealID: ${d.dealId} | Client: ${d.clientName} | Commission: ${d.commissionEarned.toFixed(2)} | Note: ${d.note}`;
        offerDiv.appendChild(dealDiv);
      });
      breakdown.appendChild(offerDiv);
    });

    card.querySelector('.toggleOffers').onclick = () => {
      breakdown.style.display = breakdown.style.display === 'none' ? 'block' : 'none';
    };

    card.querySelector('.sendBill').onclick = () => sendBillToProvider(provId, provider);
  });
});

// Send bill for one provider
async function sendBillToProvider(provId, provider) {
  const eligible = Object.entries(provider.totals).some(
    ([curr, amt]) => amt >= (THRESHOLDS[curr] || 0)
  );
  if (!eligible) return showNotif(`Provider ${provider.name} below threshold.`);

  const timestamp = new Date().toISOString();
  const billId = push(ref(db, `bills/${provId}`)).key;

  const billData = {
    billId,
    providerId: provId,
    providerName: provider.name,
    totals: provider.totals,
    offers: provider.offers,
    createdAt: timestamp,
    status: 'pending'
  };

  await set(ref(db, `bills/${provId}/${billId}`), billData);
  await set(ref(db, `admin-bills/${billId}`), billData);

  const notifRef = ref(db, `provider-notifications/${provId}`);
  const notifData = {
    type: 'billing',
    title: 'New Weekly Bill Generated',
    message: `Your weekly bill is ready for review.`,
    billId,
    createdAt: timestamp,
    status: 'unread'
  };
  await push(notifRef, notifData);

  showNotif(`âœ… Bill sent to ${provider.name}`);
}

// Send all eligible providers
sendAllBtn.onclick = async () => {
  if (!grouped || !Object.keys(grouped).length) {
    return showNotif('No providers with unpaid deals.');
  }
  sendAllBtn.disabled = true;
  showNotif('Sending bills to all eligible providers...');

  for (const [provId, provider] of Object.entries(grouped)) {
    const eligible = Object.entries(provider.totals).some(
      ([curr, amt]) => amt >= (THRESHOLDS[curr] || 0)
    );
    if (eligible) await sendBillToProvider(provId, provider);
  }

  showNotif('ðŸŽ‰ All eligible bills sent.');
  sendAllBtn.disabled = false;
};
</script>

</body>
</html>
