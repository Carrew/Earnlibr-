<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EarnLibr â€” Admin Send Bills</title>
<style>
body { font-family: Arial, sans-serif; background: #0b0d17; color: #eef2f7; margin:0; padding:20px; }
h1 { background: linear-gradient(90deg, #4a90e2, #a3ff6e); -webkit-background-clip: text; color: transparent; margin-bottom:20px; }
.notif { background:#1a2235; padding:10px; border-radius:8px; margin-bottom:15px; font-size:14px; display:none; }
.notif.success { border-left:4px solid #4ade80; color:#a3ff6e; }
.notif.error { border-left:4px solid #ef4444; color:#ff8c8c; }
.provider-card { background:#0f1724; border-radius:12px; padding:15px; margin-bottom:15px; box-shadow:0 5px 15px rgba(0,0,0,0.5); transition:opacity .5s, transform .3s; position:relative; }
.provider-card:hover { transform:translateY(-4px); }
.provider-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
.btn { background:#4ade80; border:none; padding:6px 12px; border-radius:8px; cursor:pointer; font-weight:700; color:#041018; }
.btn.danger { background:#ef4444; color:#fff; }
.btn:disabled { opacity:0.6; cursor:not-allowed; }
.offer-breakdown { background:#1a2235; border-radius:8px; padding:10px; margin-top:10px; display:none; font-size:13px; }
.toggle-offers { margin-top:10px; background:#4a90e2; color:#041018; }
.card-notif { position:absolute; top:10px; right:10px; background:#1a2235; padding:6px 12px; border-radius:8px; font-size:13px; display:flex; align-items:center; gap:8px; box-shadow:0 2px 8px rgba(0,0,0,0.45); }
.card-notif button { background:transparent; border:none; color:#a3ff6e; font-weight:700; cursor:pointer; }
.card-notif button:hover { color:#4ade80; }
</style>
</head>
<body>

<h1>Admin Send Bills</h1>
<div id="notif" class="notif"></div>

<div class="controls">
  <button id="sendAll" class="btn">ðŸ“¤ Send All Eligible Bills</button>
</div>

<div id="providersContainer">Loading unpaid deals...</div>

<script type="module">
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { auth, db } from "./firebase.js";
import { collection, doc, setDoc, addDoc, query, where, onSnapshot, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const notif = document.getElementById("notif");
const providersContainer = document.getElementById("providersContainer");
const sendAllBtn = document.getElementById("sendAll");
const THRESHOLDS = { USD: 1, LRD: 300 };
let grouped = {};

// --- Auth Check ---
let userSession = localStorage.getItem("userSession");
if(!userSession){ window.location.href="login.html"; throw new Error("No session"); }
userSession = JSON.parse(userSession);

onAuthStateChanged(auth, async (user) => {
  if(!user || user.uid !== userSession.uid){ 
    localStorage.removeItem("userSession"); 
    window.location.href="login.html"; 
    return;
  }

  if(!user.emailVerified){
    localStorage.removeItem("userSession");
    window.location.href="login.html";
    return;
  }

  const userDoc = await getDoc(doc(db, "users", user.uid));
  const adminDoc = await getDoc(doc(db, "admins", user.uid));
  let data = null;
  let role = null;

  if (userDoc.exists()) { data = userDoc.data(); role = data.role; }
  else if (adminDoc.exists()) { data = adminDoc.data(); role = data.role || "admin"; }
  else { localStorage.removeItem("userSession"); window.location.href="login.html"; return; }

  if (!["admin","super_admin"].includes(role)) { localStorage.removeItem("userSession"); window.location.href="login.html"; return; }

  userSession = { uid: user.uid, name: data.name, email: data.email, role: role };
  localStorage.setItem("userSession", JSON.stringify(userSession));

  loadDeals();
});

// --- Notifications ---
const showNotif = (msg,type="success")=>{
  notif.textContent = msg;
  notif.className = `notif ${type}`;
  notif.style.display="block";
  setTimeout(()=>{ notif.style.display="none"; },3000);
};

// --- Model A Notification Helper ---
async function sendNotification(uid, title, message) {
  try {
    await addDoc(collection(db, `notifications/${uid}/items`), {
      title,
      message,
      createdAt: serverTimestamp(),
      read: false
    });
  } catch(err) {
    console.error("Notification error:", err);
  }
}

// --- Load unpaid completed deals ---
function loadDeals(){
  const dealsQuery = query(collection(db,"completed-deals"), where("providerPaid","==",false));
  onSnapshot(dealsQuery, snapshot=>{
    providersContainer.innerHTML="";
    grouped={};

    if(snapshot.empty){ providersContainer.innerHTML="<p>No unpaid deals.</p>"; return; }

    snapshot.forEach(docSnap=>{
      const d = docSnap.data();
      const providerId = d.providerId;
      const offerId = d.offerId;
      if(!grouped[providerId]) grouped[providerId] = { name:d.providerName, offers:{} };

      if(!grouped[providerId].offers[offerId]){
        grouped[providerId].offers[offerId] = { offerTitle:d.offerTitle, currency:d.currency||"USD", total:0, deals:[] };
      }

      const offer = grouped[providerId].offers[offerId];
      offer.total += Number(d.commissionEarned);
      offer.deals.push({ dealId: docSnap.id, clientName:d.clientName, commissionEarned:d.commissionEarned, providerPaid: d.providerPaid });
    });

    renderProviders();
  });
}

// --- Render provider cards ---
function renderProviders(){
  providersContainer.innerHTML="";
  Object.keys(grouped).forEach(providerId=>{
    const p = grouped[providerId];
    const card = document.createElement("div");
    card.className="provider-card";

    let totalsHTML="";
    Object.values(p.offers).forEach(offer=>{
      totalsHTML+=`<div><strong>${offer.offerTitle} (${offer.currency}):</strong> ${offer.total.toFixed(2)}</div>`;
    });

    card.innerHTML=`
      <div class="provider-header">
        <h2>${p.name}</h2>
      </div>
      ${totalsHTML}
      <div></div>
      <button class="btn toggle-offers">Show Details</button>
      <div class="offer-breakdown"></div>
    `;

    const breakdown = card.querySelector(".offer-breakdown");
    Object.entries(p.offers).forEach(([offerId,offer])=>{
      const offerBox = document.createElement("div");
      offerBox.innerHTML=`<strong>${offer.offerTitle} â€” ${offer.currency} ${offer.total.toFixed(2)}</strong>`;

      offer.deals.forEach(deal=>{
        const d = document.createElement("div");
        d.textContent=`Deal ${deal.dealId} | ${deal.clientName} | +${deal.commissionEarned}`;
        offerBox.appendChild(d);
      });

      const sendBtn = document.createElement("button");
      sendBtn.className="btn";
      sendBtn.textContent="Send Bill";
      sendBtn.onclick=()=>sendBill(providerId, offerId, offer);
      offerBox.appendChild(sendBtn);

      breakdown.appendChild(offerBox);
    });

    card.querySelector(".toggle-offers").onclick=()=>{ 
      breakdown.style.display = breakdown.style.display==="none"?"block":"none"; 
    };

    providersContainer.appendChild(card);
  });
}

// --- Send Single Offer Bill ---
async function sendBill(providerId, offerId, offer){
  if(offer.total < (THRESHOLDS[offer.currency]||0)) return showNotif("Below threshold","error");

  const unpaidDeals = offer.deals.filter(d => d.providerPaid !== true);
  if(unpaidDeals.length === 0) return showNotif("All deals already paid","error");

  const billRef = doc(collection(db,"bills"));
  const billId = billRef.id;
  const dealIds = unpaidDeals.map(d=>d.dealId);

  const billData = {
    billId,
    providerId,
    providerName: grouped[providerId].name,
    offerId,
    offerTitle: offer.offerTitle,
    currency: offer.currency,
    total: offer.total,
    deals: dealIds,
    createdAt: new Date().toISOString(),
    status:"sent"
  };

  await setDoc(billRef,billData);
  await setDoc(doc(db,`providers/${providerId}/bills/${billId}`),billData);
  
  // Model A notification
  await sendNotification(providerId, `Bill Ready ðŸ§¾`, `A bill for ${offer.offerTitle} totaling ${offer.total.toFixed(2)} ${offer.currency} is ready.`);

  showNotif(`Bill sent for ${offer.offerTitle}`);
}

// --- Send All Eligible Bills ---
sendAllBtn.onclick = async ()=>{
  sendAllBtn.disabled=true;
  for(const [providerId,p] of Object.entries(grouped)){
    for(const [offerId,offer] of Object.entries(p.offers)){
      if(offer.total >= (THRESHOLDS[offer.currency]||0)){
        await sendBill(providerId, offerId, offer);
      }
    }
  }
  sendAllBtn.disabled=false;
  showNotif("All eligible bills sent!");
};
</script>

</body>
</html>
