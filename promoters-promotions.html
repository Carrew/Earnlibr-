<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EarnLibr â€” Promoter Deals Tracking</title>
<style>
body { font-family: Arial, sans-serif; background: #0b0d17; color: #eef2f7; margin: 0; padding: 20px; }
h1 { background: linear-gradient(90deg, #a3ff6e, #4a90e2); -webkit-background-clip: text; color: transparent; margin-bottom: 20px; }
.deal-card { background: #0f1724; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: transform .3s; }
.deal-card:hover { transform: translateY(-4px); }
.deal-card.completed { border-left: 4px solid #4ade80; }
.deal-card.cancelled { border-left: 4px solid #ef4444; }
.deal-info { margin-bottom: 8px; font-size: 14px; }
.deal-info strong { display: inline-block; width: 100px; }
.status-pending { color: #facc15; font-weight: 700; }
.status-completed { color: #4ade80; font-weight: 700; }
.status-processing { color: #3b82f6; font-weight: 700; }
.status-cancelled { color: #ef4444; font-weight: 700; }
.timestamp { font-size: 12px; color: #bfc7d6; margin-top: 5px; }
.notif { background: #1a2235; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; display: none; border-left: 4px solid #4ade80; }
.notif.error { border-left: 4px solid #ef4444; color: #ff8c8c; }
.load-more { text-align: center; margin-top: 20px; }
.load-more button { padding: 10px 20px; background: #3b82f6; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; }
</style>
</head>
<body>

<h1>Your Referral Deals</h1>
<div id="notif" class="notif"></div>
<div id="dealsContainer">Loading deals...</div>
<div id="loadMoreContainer" class="load-more" style="display: none;">
    <button id="loadMoreBtn">Load More Deals</button>
</div>

<script type="module">
import { auth, db } from './firebase.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { 
  collection, doc, getDoc, getDocs, runTransaction, query, orderBy, limit, startAfter, where
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const dealsContainer = document.getElementById("dealsContainer");
const notif = document.getElementById("notif");
const loadMoreBtn = document.getElementById("loadMoreBtn");
const loadMoreContainer = document.getElementById("loadMoreContainer");

const showNotif = (msg, type="success") => {
  notif.innerHTML = msg; 
  notif.className = `notif ${type}`;
  notif.style.display = "block";
  setTimeout(() => { notif.style.display = "none"; }, 5000);
};

/* --- Session & Promoter Auth Check --- */
let userSession = localStorage.getItem("userSession");
if(!userSession){ window.location.href = "login.html"; throw new Error("No session"); }
userSession = JSON.parse(userSession);

onAuthStateChanged(auth, async (user) => {
  if(!user || user.uid !== userSession.uid || !user.emailVerified){
    localStorage.removeItem("userSession");
    window.location.href = "login.html";
    return;
  }

  const userDoc = await getDoc(doc(db, 'users', user.uid));
  const adminDoc = await getDoc(doc(db, 'admins', user.uid));

  let uData = userDoc.exists() ? userDoc.data() : null;
  let role = uData?.role;

  if (adminDoc.exists() && adminDoc.data().role === 'promoter') {
      uData = adminDoc.data();
      role = 'promoter';
  } else if (!userDoc.exists() || role !== 'promoter') {
      // Check if they are a 'direct' promoter (no separate user account, shouldn't reach here)
      if (user.uid !== "direct") { 
          localStorage.removeItem("userSession");
          window.location.href = "login.html";
          return;
      }
  }

  userSession = { uid: user.uid, name: uData?.name || "Promoter", email: uData?.email, role: role };
  localStorage.setItem('userSession', JSON.stringify(userSession));

  loadDeals();
});

/* --- Helper --- */
const round = (num) => Math.round((num + Number.EPSILON) * 100) / 100;
const formatCurrency = (amount, currency = 'USD') => {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: currency,
    }).format(amount);
};


/* --- Load Deals with Pagination --- */
let lastDeal = null;
function loadDeals(isInitialLoad=true){
  if(isInitialLoad){ dealsContainer.innerHTML=""; lastDeal=null; loadMoreContainer.style.display="none"; }

  // Query: Filter by promoterId and order by creation date
  let dealsQuery = query(
    collection(db,"deals"),
    where("promoterId","==",userSession.uid), 
    orderBy("createdAt","desc"),
    limit(25)
  );

  if(lastDeal) dealsQuery = query(dealsQuery,startAfter(lastDeal));

  loadMoreBtn.disabled=true;
  loadMoreBtn.textContent="Loading...";

  getDocs(dealsQuery).then(snapshot=>{
    if(snapshot.empty && isInitialLoad){ dealsContainer.innerHTML="<p>No referral deals found yet.</p>"; loadMoreContainer.style.display="none"; return; }
    if(snapshot.empty){ loadMoreBtn.textContent="No More Deals"; loadMoreBtn.disabled=true; return; }

    snapshot.docs.forEach(docSnap=>renderDealCard(docSnap.id,docSnap.data()));
    lastDeal = snapshot.docs[snapshot.docs.length-1];
    loadMoreContainer.style.display="block";

    if(snapshot.docs.length<25){ loadMoreBtn.textContent="No More Deals"; loadMoreBtn.disabled=true; }
    else { loadMoreBtn.textContent="Load More Deals"; loadMoreBtn.disabled=false; }
  }).catch(err=>{ 
    console.error(err); 
    
    // Index Error Reporting (if needed)
    let errorMsg = `**Failed to Load Deals:** ${err.code || 'Unknown Error'}. Check console.`;
    const indexRegex = /(https:\/\/[^/]+\/[^/]+\/console\/firestore\/indexes\?create_composite=true&[^>\s]+)/;
    const match = err.message.match(indexRegex);

    if (match) {
         const indexUrl = match[1];
         errorMsg = `
             **CRITICAL: MISSING COMPOSITE INDEX!**<br>
             Your query requires a specific index. Click the link below to fix it:<br>
             <a href="${indexUrl}" target="_blank" style="color:#a3ff6e; font-weight:700;">
                 Click here to create the required Firebase Index
             </a>
             <br>
             <code style="background:#253040;padding:2px 4px;border-radius:4px;font-size:11px;display:inline-block;margin-top:5px;">promoterId, createdAt</code>
         `;
    } 

    dealsContainer.innerHTML = `<p style="color:#ef4444;">${errorMsg}</p>`;
    showNotif(errorMsg,"error"); 
    loadMoreBtn.textContent="Failed to Load"; 
  });
}
loadMoreBtn.onclick=()=>loadDeals(false);

/* --- Render Deal Card --- */
function renderDealCard(dealId, deal){
  const card = document.createElement("div");
  card.className=`deal-card ${deal.status||''}`;

  let createdDate = 'N/A';
  if (deal.createdAt) {
      if (typeof deal.createdAt.toDate === 'function') {
          createdDate = deal.createdAt.toDate().toLocaleString();
      } else if (deal.createdAt instanceof Date) {
          createdDate = deal.createdAt.toLocaleString();
      } else if (typeof deal.createdAt === 'string') {
          try {
              createdDate = new Date(deal.createdAt).toLocaleString();
          } catch (e) {
              createdDate = 'Invalid Date String';
          }
      }
  }

  const currency = deal.offerCurrency || "USD";
  let commissionHtml = '';

  if (deal.status === 'completed') {
    // Show final, calculated earnings for completed deals
    const gross = formatCurrency(deal.commissionEarned || deal.fullCommission || 0, currency);
    const net = formatCurrency(deal.promoterNet || deal.commissionAmount || 0, currency);
    const platformFee = formatCurrency(deal.platformShare || 0, currency);

    commissionHtml = `
      <div class="deal-info"><strong>Gross Commission:</strong> <span style="color:#4ade80;">${gross}</span></div>
      <div class="deal-info"><strong>Platform Fee:</strong> ${platformFee}</div>
      <div class="deal-info"><strong>Your Net Payout:</strong> <span style="color:#a3ff6e; font-size:16px;">${net}</span></div>
    `;

  } else {
    // Show estimated potential commission for pending/processing deals
    const estimatedCommission = formatCurrency(deal.commissionValue || 'N/A', currency);
    commissionHtml = `
      <div class="deal-info"><strong>Estimated Gross:</strong> <span style="color:#facc15;">${estimatedCommission}</span></div>
      <div class="deal-info">Awaiting Provider approval for final payout calculation.</div>
    `;
  }


  // Redact sensitive contact info for the promoter
  const clientDisplay = deal.clientName ? `${deal.clientName} (Contact Redacted)` : 'Client Name Unavailable';
  const statusClass = `status-${deal.status || 'pending'}`;

  card.innerHTML = `
    <div class="deal-info"><strong>Deal ID:</strong> ${dealId}</div>
    <div class="deal-info"><strong>Offer:</strong> ${deal.offerTitle || 'N/A'}</div>
    <div class="deal-info"><strong>Provider:</strong> ${deal.providerName || 'N/A'}</div>
    <div class="deal-info"><strong>Client:</strong> ${clientDisplay}</div>
    <hr style="border-color: #1a2235; margin: 10px 0;">
    ${commissionHtml}
    <hr style="border-color: #1a2235; margin: 10px 0;">
    <div class="timestamp">Created: ${createdDate} | Status: <span class="${statusClass}">${(deal.status || "Pending").toUpperCase()}</span></div>
  `;
  
  dealsContainer.appendChild(card);
}
</script>
</body>
</html>
